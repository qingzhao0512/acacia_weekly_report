---
title: "æŠ—ç”Ÿç´ æ–‡ç« "
author: "èµµé’"
date: "`r format(Sys.time(), '%a %b %d %X %Y')`"
output:
  html_notebook:
    toc: TRUE
    number_sections: yes

---



æ³¨æ„ç‚¹ï¼š
`tm` å…¨åˆ äº†



æ–‡ä»¶å‘½åï¼š

1. `antibotic_treatments_by_cases-2025-05-14.xlsx` æ˜¯ATCã€åŸºè¯ã€AWaReåˆ†çº§çš„æ–‡æ¡£ï¼›åŸºè¯ä¼šå†ç”¨`essentialmedicine.xlsx`åˆ†æ

1. `output_by_case_type.xlsx` æ˜¯å¾è€å¸ˆè®©åšçš„æŠ—ç”Ÿç´ å’Œå…¶ä»–è¯ç‰©è”åŠ¨åˆ†æ






æ•°æ®å˜é‡ï¼š

1. `formal_data_clean` æ˜¯åŸºç¡€æ•°æ®ï¼›

1. `formal_data_final_modeimputed` æ˜¯åœ¨åŸºç¡€æ•°æ®ä¸Šè¿›è¡Œå¤šé‡æ’è¡¥çš„æ•°æ®ï¼›

1. `excel_data` æ˜¯å¯¼å…¥æŠ—èŒè¯ç‰©åˆ†å¸ƒçš„æ•°æ®ï¼›

1. `qualityresult` æ˜¯ä½•æ–‡ä¿Šçš„æ•°æ®



ä¸€å®šä¼šçº³å…¥æ¨¡å‹çš„å˜é‡ï¼š

1. sp_age

1. sp_gender

1. doctor_age

1. doctor_ethnic

1. doctor_female

1. case_type



çŸ¥è¯†ç‚¹ï¼š

1. Firthâ€™s penalized logistic regressionå’Œglmçš„family = binomialï¼Œä¸æ˜¯ä¸€ä¸ªä¸œè¥¿å¯¹å§ï¼Œå¦å¤–firthä¸å±äºglmæ˜¯å§
ç­”ï¼šä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼šglm(family = binomial) æ˜¯ æ ‡å‡†çš„å¹¿ä¹‰çº¿æ€§æ¨¡å‹ï¼ˆGLMï¼‰ï¼Œç”¨äºæ‹ŸåˆäºŒé¡¹åˆ†å¸ƒçš„å“åº”å˜é‡ï¼Œé€šå¸¸ä½¿ç”¨ logit é“¾æ¥å‡½æ•°ã€‚Firthâ€™s penalized logistic regression æ˜¯ä¸€ç§ ä¿®æ­£åçš„é€»è¾‘å›å½’æ–¹æ³•ï¼Œåœ¨ä¼¼ç„¶å‡½æ•°ä¸­åŠ å…¥æƒ©ç½šé¡¹ï¼ˆpenalization termï¼‰ï¼Œç”¨æ¥ å‡å°‘åå€šï¼Œç‰¹åˆ«é€‚ç”¨äºå°æ ·æœ¬ã€ç¨€æœ‰äº‹ä»¶ã€å®Œå…¨æˆ–å‡†å®Œå…¨åˆ†ç¦»ï¼ˆseparationï¼‰ç­‰æƒ…å†µã€‚

Firthæ–¹æ³•ä¸æ˜¯æ ‡å‡†GLMçš„ä¸€éƒ¨åˆ†ï¼šFirthæ–¹æ³•ä¸èƒ½é€šè¿‡glm()å‡½æ•°ç›´æ¥å®ç°ï¼Œé€šå¸¸éœ€è¦ç”¨ä¸“é—¨çš„å‡½æ•°ï¼ˆå¦‚ R ä¸­çš„ logistf()ï¼‰ã€‚Firthå›å½’ç”¨çš„æ˜¯ æƒ©ç½šçš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆpenalized maximum likelihood estimationï¼‰ï¼Œè€Œæ ‡å‡†GLMç”¨çš„æ˜¯ æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆMLEï¼‰ã€‚


2. å³ä¾¿æŠ—ç”Ÿç´ å¤„æ–¹å¼€è®¾ç‡ï¼0.1ï¼Œä½†æ˜¯å› ä¸ºäº§åæŠ‘éƒç—…ä¾‹å­˜åœ¨å®Œå…¨åˆ†ç¦»ï¼Œå› æ­¤å³ä¾¿å¯ä»¥ç”¨Poissonå›å½’ä¼°è®¡RRï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ï¼Œåªèƒ½ç”¨Firth logistic å›å½’



å¼€æŠ—ç”Ÿç´ æ¯”ä¾‹ï¼š
æ¬¡æ•°ï¼š222


å¼€è¯æ•°é‡ï¼š
0=1921
1=206
2=16
å…±è®¡238



åŸºè¯çš„æ–‡æ¡£ï¼Œç›´æ¥ç”¨ï¼šåŸºè¯ç»Ÿè®¡_20250619_111604




```{r,echo=FALSE, warning=FALSE, message=FALSE}
#Clear existing data and graphics
rm(list=ls())
graphics.off()

#Setting the chunk parameter
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


```
```{r}
packages = c("tidyverse","lubridate","finalfit","summarytools","kableExtra","ggplot2","readxl","redcapAPI")
packages.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      suppressPackageStartupMessages(library(x, character.only = TRUE, quietly = T,warn.conflicts = F))
    }
  }
)


packages <- c("Hmisc", "ggplot2", "forcats", "redcapAPI", "tidyverse", "showtext", "ggpubr", "readxl", "kableExtra", "knitr", "this.path", "sp", "maptools", "mapproj", "RColorBrewer", "ggnewscale", "ggstatsplot", "rstantools", "PMCMRplus", "ggside","gridExtra","grid","openxlsx", "rio")
packages.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)




```




# å…ˆå¤„ç†æ•°æ®

```{r}

# åŠ è½½ç¬¬ä¸€ä¸ªæ•°æ®
load("data_national_survey_replaced_add_r.rda")
# åŠ è½½åï¼Œdata_national_survey_replaced_add_r ä¼šå‡ºç°åœ¨å½“å‰ç¯å¢ƒä¸­

# åŠ è½½ç¬¬äºŒä¸ªæ•°æ®
load("data_national_survey_250829.rda")
# åŠ è½½åï¼Œdata_national_survey ä¼šå‡ºç°åœ¨å½“å‰ç¯å¢ƒä¸­




data_national_survey_replaced_add_r <- data_national_survey_replaced_add_r %>%
  mutate(case_name = case_when(
    visit_case == 1  ~ "åå¤´ç—›",
    visit_case == 2  ~ "äº§åæŠ‘éƒ",
    visit_case == 3  ~ "å°å„¿è…¹æ³»",
    visit_case == 4  ~ "æ™®é€šæ„Ÿå†’",
    visit_case == 5  ~ "è‚ºç»“æ ¸",
    visit_case == 6  ~ "èƒƒç‚",
    visit_case == 7  ~ "å“®å–˜",
    visit_case == 8  ~ "å¿ƒç»ç—›",
    visit_case == 9  ~ "è…°èƒŒç—›",
    visit_case == 10 ~ "å‹åŠ›æ€§å°¿å¤±ç¦",
    visit_case == 11 ~ "é«˜è¡€å‹",
    visit_case == 12 ~ "ç³–å°¿ç—…",
    TRUE ~ NA_character_  # å…¶ä»–æƒ…å†µèµ‹å€¼ä¸º NA
  ))


```


```{r}




# # åˆ é™¤ record_id ä»¥æ•°å­—å¼€å¤´çš„è®°å½•
# data_national_survey <- data_national_survey[!grepl("^[0-9]", data_national_survey$record_id), ]
#
#
#
# # æ‰¾åˆ°æ‰€æœ‰çš„æ—¢æœ‰ä¸å¸¦rï¼Œåˆæœ‰å¸¦ _r çš„è®°å½•
# with_r <- data_national_survey[data_national_survey$record_id %in% paste0(unique(data_national_survey$record_id), "_r"), ]
#
#
# # æ‰¾åˆ°æ‰€æœ‰çš„ä¸å¸¦ _r çš„è®°å½•ã€‚å¦‚æœåŒæ—¶å­˜åœ¨basic idå’Œå¸¦_rï¼Œä¿ç•™basic id
# without_r <- data_national_survey[!data_national_survey$record_id %in% paste0(unique(data_national_survey$record_id), "_r"), ]
#
#
# # ä»ä¸å¸¦ _r çš„è®°å½•ä¸­åˆ é™¤é‚£äº›æœ‰å¸¦ _r çš„å¯¹åº”basic id
# for (id in unique(with_r$record_id)) {
#   without_r <- without_r[without_r$record_id != gsub("_r$", "", id), ]
# }
#
# # åˆå¹¶å¸¦ _r çš„è®°å½•å’Œå‰©ä½™çš„ä¸å¸¦ _r çš„è®°å½•
# data_national_survey_replaced_add_r <- rbind(with_r, without_r)


# æŸ¥ä¸€ä¸‹record_idâ€”â€”250513ï¼šæ²¡æœ‰é—®é¢˜
unique_id_df <- data.frame(record_id = unique(data_national_survey_replaced_add_r$record_id))

# # åˆ é™¤gz_visit710_ræ‰€åœ¨è¡Œ
# data_national_survey_replaced_add_r <- data_national_survey_replaced_add_r %>%
#   filter(record_id != "gz_visit710_r")


```




```{r}

# åˆ†ç—…ä¾‹æ•´ç†æ•°æ®æ¡†

tmp <- data_national_survey_replaced_add_r %>%
  filter(!redcap_event_name %in% c("previsit_sp_arm_1",
                                  "postvisit_research_arm_1",
                                  "postvisit_research_arm_1b"))


library(data.table)
setDT(tmp)  # è½¬æ¢ä¸º data.table

# å®šä¹‰è¯ç‰©ç›¸å…³åˆ—èŒƒå›´
drug_start <- which(names(tmp) == "prescription_confirm")
drug_end <- which(names(tmp) == "drug_info_complete")
drug_cols <- names(tmp)[drug_start:drug_end]

# å®šä¹‰éœ€è¦å¡«å……çš„åˆ—ï¼ˆæ’é™¤ redcap_event_name å’Œè¯ç‰©ç›¸å…³åˆ—ï¼‰
fill_cols <- setdiff(names(tmp), c("redcap_event_name", drug_cols))

# æŒ‰ record_id åˆ†ç»„ï¼Œå¡«å……éè¯ç‰©åˆ—
tmp[, (fill_cols) := lapply(.SD, function(x) {
  if (all(is.na(x))) NA else first(na.omit(x))
}), by = record_id, .SDcols = fill_cols]




tmp <- tmp %>%
  filter(redcap_event_name == "afterclinic_sp_arm_1")





# åˆ é™¤å°è¯å‡†ç¡®ç‡æ‰€åœ¨åˆ—
data <- tmp %>%
  dplyr::select(-(migraine_active1:active_diabetes_complete))










# # åˆ›å»ºç—…ä¾‹ç¼–å·ä¸è‹±æ–‡åçš„æ˜ å°„
# case_mapping <- tibble(
#   visit_case = as.character(c(1, 2, 3, 4, 6, 7, 8, 9, 10, 11, 12)),
#   case_name = c("migraine", "postpartum_depression", "pediatric_diarrhea",
#                "common_cold", "gastritis", "asthma", "angina",
#                "back_pain", "stress_incontinence", "hypertension",
#                "diabetes")
# )
#
# # â€”â€” æ‹†åˆ†å…·ä½“ç—…ä¾‹åˆ—è¿˜æ˜¯æœ‰é—®é¢˜
#
# # æ‹†åˆ†æ•°æ®å¹¶åˆ›å»ºç‹¬ç«‹çš„æ•°æ®æ¡†
# tmp %>%
#   inner_join(case_mapping, by = "visit_case") %>%  # å…³è”ç—…ä¾‹å
#   group_by(visit_case, case_name) %>%              # æŒ‰ç—…ä¾‹åˆ†ç»„
#   group_split() %>%                                # æ‹†åˆ†æˆåˆ—è¡¨
#   walk(~{
#     case_num <- unique(.x$visit_case)
#     case_name <- unique(.x$case_name)
#
#     # åˆ›å»ºåŠ¨æ€å˜é‡åå¹¶èµ‹å€¼åˆ°å…¨å±€ç¯å¢ƒ
#     assign(paste0("tmp_", case_name),
#            as.data.frame(.x),
#            envir = .GlobalEnv)
#
#     message(sprintf("å·²åˆ›å»ºæ•°æ®æ¡†: tmp_%s (å¯¹åº”visit_case=%d)",
#                    case_name, case_num))
#   })









# # åœ¨RStudioä¸­å¼¹å‡ºåˆ—åæŸ¥çœ‹çª—å£
# View(as.data.frame(colnames(tmp)))
# View(as.data.frame(colnames(data)))




```



## æ•´ç†å¤„æ–¹è¯„ä»·çš„æ¸…å•â€”â€”è¯ç‰©ä¿¡æ¯
```{r}






data_visit_summary_2 <- data_national_survey_replaced_add_r %>%
  filter(redcap_event_name=="previsit_researche_arm_1") %>%
  dplyr::select(record_id, visit_case, case_name)





# æå–è¯ç‰©ä¿¡æ¯

data_national_survey_replaced_add_r %>%
  filter(redcap_event_name=="afterclinic_sp_arm_1") %>%
  filter(!is.na(redcap_repeat_instrument)) ->t1

list_file <- list()

for (case_var in unique(data_visit_summary_2$case_name)) {

  drug_var_first <- "prescription_confirm"
  drug_var_final <- "drug_info_complete"

  data_visit_summary_2 %>%
    filter(case_name==case_var) %>%
    left_join(t1, by="record_id") %>%
    dplyr::select(record_id, drug_var_first:drug_var_final) %>%
    mutate(web_link=paste0("https://www.wcrcnet.cn/redcap/redcap_v15.3.1/DataEntry/record_home.php?pid=292&arm=1&id=",record_id))->t_result

  current_list <- list(case_var = t_result)
  names(current_list) <- case_var
  list_file <- append(list_file,current_list)

}


# ç”Ÿæˆå¸¦æœ‰å½“å‰æ—¥æœŸçš„æ–‡ä»¶å
output_filename <- paste("antibotic_drug_info_by_cases-", format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")

# ä¿å­˜Excelæ–‡ä»¶ï¼Œå¹¶åŒ…å«æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶å
write.xlsx(list_file, file = output_filename)

rm(output_filename)







```


ç”¨`antibotic_drug_info_by_cases-2025-05-14.xlsx`è¿›è¡Œåˆ†æï¼›



## æ•´ç†å¤„æ–¹è¯„ä»·çš„æ¸…å•â€”â€”å¤„ç½®ä¿¡æ¯
```{r}


## æŠŠå¤„ç½®æ‰€æœ‰çš„ä¿¡æ¯éƒ½æ•´ç†å‡ºæ¥
### Treatment
data_national_survey_replaced_add_r %>%
        filter(redcap_event_name=="afterclinic_sp_arm_1") %>%
        filter(is.na(redcap_repeat_instrument)) ->t1

list_file <- list()

for (case_var in unique(data_visit_summary_2$case_name)) {

        checklist_var_first <- switch(case_var,
                                      "å‹åŠ›æ€§å°¿å¤±ç¦"="sui_treat1",
                                      "åå¤´ç—›"="migraine_treat1",
                                      "äº§åæŠ‘éƒ"="ppd_treat1",
                                      "å°å„¿è…¹æ³»"="diarrhea_treat1",
                                      "æ™®é€šæ„Ÿå†’"="cold_treat1",
                                      "èƒƒç‚"="cng_treat1",
                                      "å“®å–˜"="asthma_treat1",
                                      "å¿ƒç»ç—›"="angina_treat1",
                                      "è…°èƒŒç—›"="lbp_treat1",
                                      "é«˜è¡€å‹"="eh_treat1",
                                      "ç³–å°¿ç—…"="diabetes_treat3")

        treatment_var_final <- switch(case_var,
                                      "å‹åŠ›æ€§å°¿å¤±ç¦"="sui_treat14",
                                      "åå¤´ç—›"="migraine_treat7",
                                      "äº§åæŠ‘éƒ"="ppd_treat10",
                                      "å°å„¿è…¹æ³»"="diarrhea_treat11",
                                      "æ™®é€šæ„Ÿå†’"="cold_treat12",
                                      "èƒƒç‚"="cng_treat17",
                                      "å“®å–˜"="asthma_treat5",
                                      "å¿ƒç»ç—›"="angina_treat6",
                                      "è…°èƒŒç—›"="lbp_treat12",
                                      "é«˜è¡€å‹"="eh_treat18",
                                      "ç³–å°¿ç—…"="diabetes_treat11")

        data_visit_summary_2 %>%
                filter(case_name==case_var) %>%
                left_join(t1,by="record_id") %>%
                dplyr::select(record_id,checklist_var_first:treatment_var_final) ->t_result

        current_list <- list(case_var = t_result)
        names(current_list) <- case_var
        list_file <- append(list_file,current_list)
}


# ç”Ÿæˆå¸¦æœ‰å½“å‰æ—¥æœŸçš„æ–‡ä»¶å
output_filename <- paste("antibotic_treatments_by_cases-", format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")

# ä¿å­˜Excelæ–‡ä»¶ï¼Œå¹¶åŒ…å«æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶å
write.xlsx(list_file, file = output_filename)

rm(output_filename)




```


ç”¨`antibotic_treatments_by_cases-2025-05-14.xlsx`è¿›è¡Œåˆ†æ




## æ•´ç†å˜é‡ï¼Œå‡†å¤‡åˆ†æ
```{r}



data_analysis <- data %>%
        group_by(record_id) %>%
        dplyr::slice(1) %>%  # å–æ¯ç»„çš„ç¬¬ä¸€è¡Œ
        ungroup()



# missing_in_unique <- setdiff(data_analysis$record_id, unique_id_df$record_id)
#
# extra_in_unique <- setdiff(unique_id_df$record_id, data_analysis$record_id)




# missing_afterclinic_ids <- data_national_survey_replaced_add_r |>
#   group_by(record_id) |>
#   filter(!any(redcap_event_name == "afterclinic_sp_arm_1")) |>
#   pull(record_id) |>
#   unique()






```


`data_analysis`çš„`record_id`ï¼Œä¼šæ¯”`unique1_id_df`å°‘ï¼Œå› ä¸ºå‰è€…æœ‰çš„idå¹¶æ²¡æœ‰å¡«å†™`afterclinic_sp_arm_1`ã€‚æ‰“å¼€`gs_visit_7_r`å’Œ`gs_visit_114_r`æŸ¥çœ‹ï¼Œéƒ½æ²¡æœ‰æˆåŠŸè®¿é—®ã€‚

æ‰€ä»¥æœ€åçº³å…¥åˆ†æçš„ï¼Œåº”è¯¥å°±æ˜¯`data_analysis`çš„`record_id`ã€‚



```{r}




# View(as.data.frame(colnames(data_analysis)))

data_analysis <- data_analysis %>%
        dplyr::select( record_id, visit_case, sp_name, investigator_name,        # å•ä¸ªå˜é‡
                institution_name_register:visit_doctor,                   # å˜é‡èŒƒå›´
                ownership:ins_contractor,
                visit_complete, visit_tracking, whether_pharmarcy,
                migraine_q3:institution_work,
                doctor_name0:doctor_certificate2,
                time_arrive:drug_info_complete
                )


# åˆ›å»ºcase_nameæ˜ å°„
data_analysis <- data_analysis %>%
  mutate(
    case_name = case_when(
      visit_case == 1 ~ "åå¤´ç—›",
      visit_case == 2 ~ "äº§åæŠ‘éƒ",
      visit_case == 3 ~ "å°å„¿è…¹æ³»",
      visit_case == 4 ~ "æ™®é€šæ„Ÿå†’",
      visit_case == 5 ~ "è‚ºç»“æ ¸",
      visit_case == 6 ~ "èƒƒç‚",
      visit_case == 7 ~ "å“®å–˜",
      visit_case == 8 ~ "å¿ƒç»ç—›",
      visit_case == 9 ~ "è…°èƒŒç—›",
      visit_case == 10 ~ "å‹åŠ›æ€§å°¿å¤±ç¦",
      visit_case == 11 ~ "é«˜è¡€å‹",
      visit_case == 12 ~ "ç³–å°¿ç—…",
      TRUE ~ NA_character_  # å¤„ç†æœªåŒ¹é…çš„æƒ…å†µ
    ),
    .after = visit_case  # æ”¾åœ¨visit_caseåˆ—åé¢
  )

data_analysis <- data_analysis %>%
  mutate(
    # ä» record_id æå–çœä»½ç¼©å†™ï¼ˆå‰2æˆ–3ä¸ªå­—æ¯ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼‰
    province_abbr = str_extract(record_id, "^[A-Za-z]{2,3}") %>% toupper(),  # è½¬ä¸ºå¤§å†™ç»Ÿä¸€æ ¼å¼

    # æ ¹æ®çœä»½ç¼©å†™æ˜ å°„ä¸ºä¸­æ–‡åç§°
    province_name = case_when(
      province_abbr %in% c("NMG") ~ "å†…è’™å¤è‡ªæ²»åŒº",
      province_abbr %in% c("HN") ~ "æ¹–å—çœ",
      province_abbr %in% c("GD") ~ "å¹¿ä¸œçœ",
      province_abbr %in% c("SC") ~ "å››å·çœ",
      province_abbr %in% c("GZ") ~ "è´µå·çœ",
      province_abbr %in% c("SX") ~ "é™•è¥¿çœ",
      province_abbr %in% c("GS") ~ "ç”˜è‚ƒçœ",
      TRUE ~ NA_character_  # æœªåŒ¹é…çš„è®¾ä¸ºNA
    ),
    .after = record_id  # å°† province_name æ”¾åœ¨ record_id åˆ—å
  )





```

è¿™é‡Œæ˜¯æˆ‘æ•´ç†çš„é™¤äº†è¯ç‰©å’Œå¤„ç½®çš„å…¶ä»–æ‰€æœ‰åŸå§‹å˜é‡ï¼Œå†å’Œä½•æ–‡ä¿Šçš„`ACACIA-qualityresult-hwj-20231112.xlsx`ç»“åˆï¼Œå¹¶ä¸”åˆ é™¤å¯¹åº”åŸå§‹æ•°æ®å°±å¥½

ä½•æ–‡ä¿Šè¯´æœ€åçº³å…¥åˆ†æçš„æ•°æ®é‡ï¼š`2143æ¬¡`



```{r}



qualityresult <- import("ACACIA-qualityresult-hwj-20231112.xlsx", which = "èµµé’æ¸…æ´—åç”¨æ¥åˆ†æçš„æ•°æ®")

data_analysis_raw <- data_analysis



# åˆ é™¤ä½•æ–‡ä¿Šæ•´ç†çš„æœ€ç»ˆæ•°æ®ï¼Œæ‰€å¯¹åº”çš„åŸå§‹æ•°æ®
data_analysis <- data_analysis %>%
  dplyr::select(-c(migraine_q3:pppc_complete,
           accessibility1:pharmaceutical_satisfaction_complete,
           time_arrive:info_collection_complete,
           province_name, case_name))



# æ‰¾å‡ºåœ¨ qualityresult ä½†ä¸åœ¨ data_analysis ä¸­çš„ record_idâ€”â€”å€¼ä¸º0ï¼Œå¯ä»¥çº³å…¥åˆ†æ
missing_in_data <- setdiff(qualityresult$record_id, data_analysis$record_id)





tmp <- qualityresult %>%
  mutate(record_id = as.character(record_id)) %>%
  left_join(
    data_analysis %>% mutate(record_id = as.character(record_id)),
    by = "record_id"
  ) %>%
  dplyr::select(-(prescription_confirm:drug_info_complete))



```


ç›®å‰ï¼Œ`tmp`æ˜¯é™¤äº†è¯ç‰©ä¿¡æ¯è¡¨ä¹‹å¤–çš„æ‰€æœ‰å˜é‡





## è¿æ¥æ•°æ®

```{r}


library(openxlsx)

excel_file <- "antibotic_treatments_by_cases-2025-05-14.xlsx"
sheet_names <- getSheetNames(excel_file)

# å¾ªç¯è¯»å–æ¯ä¸ª sheet
data_list <- lapply(sheet_names, function(sheet) {
  read.xlsx(excel_file, sheet = sheet)
})

names(data_list) <- sheet_names



```









```{r}


library(writexl)


# 1. è¯»å–antibioticæ•°æ®â€”â€”æ¯æ¬¡æ›´æ”¹excelï¼Œéƒ½éœ€è¦æŠŠå‰é¢çš„allé‡æ–°æ”¹ä¸€ä¸‹
antibiotic_data <- read_excel("antibotic_treatments_by_cases-2025-05-14.xlsx",
                            sheet = "all") %>%
  # å…³é”®æ­¥éª¤ï¼šå¯¹record_idå»é‡ï¼ˆä¿ç•™æ¯ä¸ªIDçš„ç¬¬ä¸€æ¡è®°å½•ï¼‰
  distinct(record_id, .keep_all = TRUE)

# 2. æ‰¾å‡ºtmpä¸­æ²¡æœ‰çš„åˆ—
new_cols <- setdiff(names(antibiotic_data), names(tmp))

# 3. å®‰å…¨åˆå¹¶ï¼ˆç¡®ä¿è¡Œæ•°ä¸å˜ï¼‰
final_data <- tmp %>%
  left_join(
    antibiotic_data %>%
      dplyr::select(record_id, all_of(new_cols)),
    by = "record_id"
  )






final_data <- final_data %>%
  mutate(
    # è®¡ç®—å¼€äº†å‡ ç§è¯ï¼ˆæ–‡å­—éç©ºå°±ç®—1ç§ï¼‰
    prescribe_all_antibiotic = {
      # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡å­—å†…å®¹ï¼ˆNA/ç©ºå­—ç¬¦ä¸²ä¸ç®—ï¼‰
      v1 <- ifelse(is.na(antibiotic_1) | antibiotic_1 == "", 0, 1)
      v2 <- ifelse(is.na(antibiotic_2) | antibiotic_2 == "", 0, 1)
      v1 + v2
    },

    # è®¡ç®—æ€»ä»·æ ¼ï¼ˆç¡®ä¿ä»·æ ¼åˆ—ä¸ºæ•°å€¼å‹ï¼‰
    price_all_antibiotic = coalesce(as.numeric(antibiotic_1_price), 0) +
                          coalesce(as.numeric(antibiotic_2_price), 0)
  )

# éªŒè¯ç»“æœ
final_data %>%
  count(prescribe_all_antibiotic)  # æ£€æŸ¥å¼€è¯æ•°é‡åˆ†å¸ƒ



View(as.data.frame(colnames(final_data)))


write_xlsx(final_data, path = "final_data_output.xlsx")




```


prescribe_all_antibioticï¼šæŒ‡çš„æ˜¯å¼€äº†å‡ ç§æŠ—ç”Ÿç´ 




# è¿›å…¥æ­£å¼åˆ†æé˜¶æ®µ
## æ•°æ®å‡†å¤‡ä¸æ¢ç´¢
### å¤„ç†å˜é‡ç±»å‹
```{r}



# ä¸€èˆ¬åšæ³•ï¼šé¿å…ä¸­æ–‡å˜é‡å‡ºé”™ï¼Œç¡®ä¿ç¼–ç ä¸€è‡´
options(stringsAsFactors = FALSE)




# å¤„ç†æ•°æ®ç±»å‹
final_data$prescribe_any_antibiotic <- as.integer(final_data$prescribe_all_antibiotic > 0)

## åˆ†ç±»å‹å˜é‡ï¼ˆå› ç´ å˜é‡ï¼‰
factor_vars <- c(
  "province_name", "case_name", "doctor_ethnic", "ownership", "institution_type", "management_type", "hospital_level", "hospital_class", "univ_affiliation", "member_corporate", "member_alliance", "ins_contractor", "doctor_female", "prescribe_any_antibiotic"
)

final_data <- final_data %>%
  mutate(across(all_of(factor_vars), as.factor))


## diagnosis_quality è®¾ä¸ºåˆ†ç±»å› å­
# åˆå¹¶â€œå®Œå…¨æ­£ç¡®â€å’Œâ€œåŸºæœ¬æ­£ç¡®â€ä¸ºâ€œæ­£ç¡®â€
final_data$è¯Šæ–­è´¨é‡ <- as.character(final_data$è¯Šæ–­è´¨é‡)
final_data$è¯Šæ–­è´¨é‡[final_data$è¯Šæ–­è´¨é‡ %in% c("éƒ¨åˆ†æ­£ç¡®", "åŸºæœ¬æ­£ç¡®")] <- "éƒ¨åˆ†æ­£ç¡®"


final_data$è¯Šæ–­è´¨é‡ <- factor(final_data$è¯Šæ–­è´¨é‡,
         levels = c("å®Œå…¨æ­£ç¡®", "éƒ¨åˆ†æ­£ç¡®", "é”™è¯¯", "æ²¡æœ‰ä¸‹è¯Šæ–­")
)



## doctor_age è®¾ä¸ºæœ‰åºå› å­
final_data$doctor_age <- factor(
  final_data$doctor_age,
  levels = c(1, 2, 3),
  labels = c("<30", "30-50", "â‰¥50")
)

## doctor_titleè®¾ä¸ºæœ‰åºå› å­
### æ›¿æ¢ 9 ä¸º NA
final_data$doctor_title[final_data$doctor_title == 9] <- NA

### è½¬æ¢ä¸ºæœ‰åºå› å­
final_data$doctor_title <- factor(
  final_data$doctor_title,
  levels = c(1, 2, 3, 4, 5),
  labels = c("æ— èŒç§°", "ä½é™¢åŒ»å¸ˆ", "ä¸»æ²»åŒ»å¸ˆ", "å‰¯ä¸»ä»»åŒ»å¸ˆ", "ä¸»ä»»åŒ»å¸ˆ"),
  ordered = TRUE
)


## doctor_educationè®¾ä¸ºæœ‰åºå› å­
# å°†â€œæ— æ³•è·å–â€ç¼–ç ä¸º NA
final_data$doctor_education[final_data$doctor_education == 9] <- NA

# è½¬ä¸ºæœ‰åºå› å­ï¼ˆé«˜å­¦å† â†’ ä½å­¦å†ï¼‰
final_data$doctor_education <- factor(
  final_data$doctor_education,
  levels = c(1, 2, 3, 4, 5),
  labels = c("ä¸­ä¸“", "é«˜ä¸­åŠä»¥ä¸‹", "å¤§ä¸“", "å¤§å­¦æœ¬ç§‘", "ç ”ç©¶ç”Ÿ"),
  ordered = TRUE
)


## doctor_certificateè®¾ä¸ºæœ‰åºå› å­
# å°†â€œæ— æ³•è·å–â€ç¼–ç ä¸º NA
final_data$doctor_certificate[final_data$doctor_certificate == 9] <- NA

# è½¬ä¸ºæœ‰åºå› å­ï¼ˆä»é«˜åˆ°ä½ï¼‰
final_data$doctor_certificate <- factor(
  final_data$doctor_certificate,
  levels = c(1, 2, 3, 4),
  labels = c("æ— è¯ä¹¦", "ä¹¡æ‘åŒ»ç”Ÿ", "æ‰§ä¸šåŠ©ç†åŒ»å¸ˆ", "æ‰§ä¸šåŒ»å¸ˆ"),
  ordered = TRUE
)


## åˆ›å»º ownership_type äºŒå…ƒåˆ†ç±»
final_data <- final_data %>%
  # åˆ›å»º ownership_type äºŒå…ƒå˜é‡ï¼ˆ11/12ä¸º"å…¬ç«‹"ï¼Œå…¶ä»–ä¸º"ç§ç«‹"ï¼‰
  mutate(
    ownership_type = ifelse(ownership %in% c(11, 12), "å…¬ç«‹", "ç§ç«‹"),
    ownership_type = factor(ownership_type, levels = c("ç§ç«‹", "å…¬ç«‹"))
  ) %>%

  # åˆ é™¤åŸå§‹ ownership å˜é‡
  dplyr::select(-ownership)





## åˆ›å»º institution_type äº”å…ƒåˆ†ç±»
final_data <- final_data %>%
  mutate(
    institution_type_group = case_when(
      institution_type %in% c("A100", "A210", "A300") ~ "åŒ»é™¢",
      institution_type %in% c("B100", "B200") ~ "ç¤¾åŒºå«ç”Ÿä¸­å¿ƒï¼ˆç«™ï¼‰",
      institution_type %in% c("C210", "C220") ~ "ä¹¡é•‡å«ç”Ÿé™¢",
      institution_type %in% c("D110", "D121", "D122", "D130", "D211", "D212", "D213", "D229") ~ "è¯Šæ‰€",
      institution_type == "D600" ~ "æ‘å«ç”Ÿå®¤",
      TRUE ~ NA_character_  # å…¶ä»–æœªåˆ†ç±»çš„è®¾ä¸º NA
    ),
    institution_type_group = factor(institution_type_group,
                                    levels = c("åŒ»é™¢", "ç¤¾åŒºå«ç”Ÿä¸­å¿ƒï¼ˆç«™ï¼‰", "ä¹¡é•‡å«ç”Ÿé™¢", "è¯Šæ‰€", "æ‘å«ç”Ÿå®¤"))
  )


######## èµµåšå®‡è€å¸ˆå»ºè®®ï¼Œå†ä¿®æ”¹ä¸€ä¸‹åˆ†ç±»
## åˆ›å»º institution_type äº”å…ƒåˆ†ç±»
final_data <- final_data %>%
  mutate(
    institution_type_houyu = case_when(
      institution_type %in% c("A100", "A210", "A300") ~ "åŒ»é™¢",
      institution_type %in% c("B100") ~ "ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ",
      institution_type %in% c("B200") ~ "ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™",
      institution_type %in% c("C210", "C220") ~ "ä¹¡é•‡å«ç”Ÿé™¢",
      institution_type %in% c("D110", "D121", "D122", "D130") ~ "é—¨è¯Šéƒ¨",
      institution_type %in% c("D211", "D212", "D213", "D229") ~ "è¯Šæ‰€",
      institution_type %in% c("D600") ~ "æ‘å«ç”Ÿå®¤",
      TRUE ~ NA_character_  # å…¶ä»–æœªåˆ†ç±»çš„è®¾ä¸º NA
    ),
    institution_type_houyu = factor(institution_type_houyu,
                                    levels = c("åŒ»é™¢", "ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ", "ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™", "ä¹¡é•‡å«ç”Ÿé™¢", "è¯Šæ‰€", "æ‘å«ç”Ÿå®¤"))
  )


## åˆ›å»º rural_type äºŒå…ƒåˆ†ç±»
final_data <- final_data %>%
  mutate(
    rural_type = case_when(
      institution_type %in% c("C210", "C220", "D600") ~ "rural",
      institution_type %in% c(
        "A100", "A210", "A300",
        "B100", "B200",
        "D110", "D121", "D122", "D130",
        "D211", "D212", "D213", "D229"
      ) ~ "urban",
      TRUE ~ NA_character_
    ),
    rural_type = factor(rural_type, levels = c("urban", "rural"))
  )  %>%
  dplyr::select(-institution_type)




# ## æ˜¯å¦å¼€ä¸­è¯çš„äºŒå…ƒåˆ†ç±»
# final_data <- final_data %>%
#   mutate(
#     tm = factor(tm,
#     levels = c(0, 1),
#   labels = c("æ— ä¸­è¯æˆ–ä¸­æˆè¯", "æœ‰ä¸­è¯æˆ–ä¸­æˆè¯"))
#   )




# æ•°å€¼å‹å˜é‡åˆ—è¡¨ï¼ˆä¸­æ–‡ï¼‰
numeric_vars_cn <- c(
  "æ¨èé—®è¯Šä¸­å®é™…é—®è¯Šçš„æ¯”ä¾‹",
  "æ¨èä½“æ ¼æ£€æŸ¥ä¸­å®é™…æ‰§è¡Œçš„æ¯”ä¾‹",
  "æ¨èå®éªŒå®¤æˆ–å½±åƒæ£€æŸ¥ä¸­å®é™…å»ºè®®çš„æ¯”ä¾‹",
  "é—®è¯Šè´¹", "æ£€æŸ¥è´¹", "å¤„ç½®è´¹", "å…¶ä»–è´¹ç”¨",
  "è¯è´¹", "æ€»è´¹ç”¨",
  "ç­‰å¾…æ—¶é—´", "è¯Šå®¤æ—¶é—´", "æ€»æ—¶é—´", "PPPC"
)

# è½¬æ¢ä¸º numericï¼ˆæ³¨æ„ä¸­æ–‡åˆ—åçš„å¤„ç†æ–¹å¼ï¼‰
final_data[numeric_vars_cn] <- lapply(final_data[numeric_vars_cn], function(x) as.numeric(as.character(x)))



## doctor_ethnic æ°‘æ—å–å€¼9ä¸ºç¼ºå¤±
final_data$doctor_ethnic[final_data$doctor_ethnic == 9] <- NA



## management_type å–å€¼9ä¿®æ”¹ä¸º1
table(final_data$management_type)


result <- subset(final_data,
                 management_type == 9,
                 select = record_id)
print(result)


## æŸ¥è¯¢åå¾—çŸ¥ä¸‰å®¶æœºæ„ï¼Œåº”è¯¥éƒ½æ˜¯1. éè¥åˆ©æ€§
final_data$management_type[final_data$management_type == 9] <- 1


# è½¬ä¸ºæœ‰åºå› å­ï¼ˆä»é«˜åˆ°ä½ï¼‰
final_data$management_type <- factor(
  final_data$management_type,
  levels = c(1, 2),
  labels = c("éè¥åˆ©æ€§", "è¥åˆ©æ€§")
)



# å°†å››ä¸ªè´¹ç”¨å˜é‡ä¸­ç­‰äº0çš„å€¼æ›¿æ¢ä¸ºNA
final_data$`é—®è¯Šè´¹`[final_data$`é—®è¯Šè´¹` == 0] <- NA
final_data$`æ£€æŸ¥è´¹`[final_data$`æ£€æŸ¥è´¹` == 0] <- NA
final_data$`å¤„ç½®è´¹`[final_data$`å¤„ç½®è´¹` == 0] <- NA
final_data$`æ€»è´¹ç”¨`[final_data$`æ€»è´¹ç”¨` == 0] <- NA









```

250720ï¼šå®‹å†ä¼Ÿè€å¸ˆå»ºè®®`éè¥åˆ©`å’Œ`è¥åˆ©`å¯ä»¥ä¸çº³å…¥åˆ†æ




**ä»€ä¹ˆæ—¶å€™è½¬ä¸ºå› å­ï¼š**

1. æ— åºåˆ†ç±»å˜é‡éœ€è¦è½¬ä¸ºfactorï¼Œæ¯”å¦‚æ•°æ®ä¸­æ˜¯å­—ç¬¦å‹ï¼ˆcharacterï¼‰æˆ–ç”¨æ•°å­—ç¼–ç ï¼ˆå¦‚ 1=ç”·, 2=å¥³ï¼‰ï¼Œå¦‚æœä¸è½¬ä¸º factorï¼Œæ¨¡å‹ä¼šï¼šé”™è¯¯åœ°æŠŠå®ƒä»¬å½“æˆè¿ç»­å˜é‡è¿›è¡Œçº¿æ€§å»ºæ¨¡ï¼›

1. æœ‰åºåˆ†ç±»å˜é‡éœ€è¦è½¬ä¸º ordered factorï¼›

1. æ•°å€¼è¿ç»­å˜é‡ä¸ç”¨ï¼ŒäºŒåˆ†ç±»å› å˜é‡ä¸ç”¨ã€‚


**æ˜¯å¦å°†æœ‰åºå› å­çš„æ°´å¹³è®¾ç½®ä¸ºâ€œé«˜åˆ°ä½â€**

åœ¨ R ä¸­ä½¿ç”¨ GLMMï¼ˆå¦‚ glmer()ï¼‰å»ºæ¨¡æ—¶ï¼Œæœ‰åºå› å­é»˜è®¤çš„â€œç¬¬ä¸€ä¸ªæ°´å¹³â€æ˜¯å‚è€ƒç»„ï¼ˆbaselineï¼‰ï¼›



`record_id`

391	gd_visit_524	 â€”â€”ä¸œå¹³é•‡ä¸œæ–¹çº¢å«ç”Ÿç«™	           â€”â€”åº”è¯¥æ˜¯1ï¼Œéè¥åˆ©æ€§
1845	sc_visit_2160	 â€”â€”å¤§ç«¹å¿æ¬§å®¶ä¹¡æ™®å±±æ‘å«ç”Ÿç«™        â€”â€”åº”è¯¥æ˜¯1ï¼Œéè¥åˆ©æ€§
2024	sx_visit_1504    â€”â€”è¥¿å®‰å¸‚ä¸´æ½¼åŒºå‡¤å‡°ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒâ€”â€”åº”è¯¥æ˜¯1ï¼Œéè¥åˆ©æ€§





### æ£€æŸ¥æ•°æ®ç»“æ„ä¸ç¼ºå¤±



#### ç”Ÿæˆç¼ºå¤±ç‡è¡¨
```{r}

# æ ·æœ¬é‡å’Œå˜é‡æ•°
dim(final_data)

formal_data <- final_data %>%
  dplyr::select(
    # åºå·
    record_id,

    # å› å˜é‡
    antibiotic_prescribed_num = prescribe_all_antibiotic,  # é‡å‘½åä¸ºæ›´æ¸…æ™°çš„å˜é‡å
    antibiotic_prescribed = prescribe_any_antibiotic,

    # # æ˜¯å¦å¼€ä¸­è¯/ä¸­æˆè¯
    # tm,


    # åœ°åŒºå’Œç—…ä¾‹ç‰¹å¾
    province = province_name,
    case_type = case_name,

    # åŒ»ç–—è´¨é‡ç›¸å…³å˜é‡
    diagnosis_quality = è¯Šæ–­è´¨é‡,
    history_taking_ratio = `æ¨èé—®è¯Šä¸­å®é™…é—®è¯Šçš„æ¯”ä¾‹`,  # é¿å…ä½¿ç”¨ä¸­æ–‡å˜é‡å
    physical_exam_ratio = `æ¨èä½“æ ¼æ£€æŸ¥ä¸­å®é™…æ‰§è¡Œçš„æ¯”ä¾‹`,
    lab_imaging_ratio = `æ¨èå®éªŒå®¤æˆ–å½±åƒæ£€æŸ¥ä¸­å®é™…å»ºè®®çš„æ¯”ä¾‹`,
    PPPC,

    # åŒ»ç”Ÿç‰¹å¾
    doctor_title,
    doctor_age,
    doctor_ethnic,
    doctor_education,
    doctor_certificate,
    doctor_female,

    # æœºæ„ç‰¹å¾
    ownership_type,
    rural_type,
    management_type,
    institution_type_houyu,
    hospital_level,
    hospital_class,
    univ_affiliation,
    member_corporate,
    member_alliance,
    ins_contractor,

    # è´¹ç”¨ç›¸å…³
    consultation_fee = `é—®è¯Šè´¹`,
    examination_fee = `æ£€æŸ¥è´¹`,
    treatment_fee = `å¤„ç½®è´¹`,
    total_fee = `æ€»è´¹ç”¨`,

    # æ—¶é—´ç›¸å…³
    waiting_time = `ç­‰å¾…æ—¶é—´`,
    consultation_time = `è¯Šå®¤æ—¶é—´`,
    total_time = `æ€»æ—¶é—´`
  )




# è®¡ç®—ç¼ºå¤±æ•°å’Œç¼ºå¤±ç‡
missing_summary <- data.frame(
  variable = names(formal_data),
  missing_count = sapply(formal_data, function(x) sum(is.na(x))),
  total = nrow(formal_data)
)

# æ·»åŠ ç¼ºå¤±ç‡åˆ—
missing_summary$missing_rate <- round(missing_summary$missing_count / missing_summary$total, 4)

# æŒ‰ç¼ºå¤±ç‡é™åºæ’åˆ—
missing_summary <- missing_summary[order(-missing_summary$missing_rate), ]

# æ˜¾ç¤ºç»“æœ
print(missing_summary)




```


MICE å’Œå‰”é™¤å˜é‡çš„å¸¸ç”¨ç»éªŒé˜ˆå€¼

ç¼ºå¤±ç‡ï¼ˆMissing Rateï¼‰	å»ºè®®å¤„ç†æ–¹å¼
0â€“5%	å¯å¿½ç•¥æˆ–ç›´æ¥æ’è¡¥ï¼ˆå½±å“æå°ï¼‰
5â€“20%	æ¨èä½¿ç”¨ MICE ç­‰æ–¹æ³•è¿›è¡Œæ’è¡¥
20â€“30%	å¯ç”¨ MICE æ’è¡¥ï¼Œä½†éœ€è°¨æ…ï¼Œç‰¹åˆ«æ˜¯å˜é‡é‡è¦æ—¶
>30%	é€šå¸¸å»ºè®®å‰”é™¤ï¼ˆé™¤éè¯¥å˜é‡éå¸¸å…³é”®ï¼‰


treatment_feeï¼šå¤„ç½®è´¹
examination_feeï¼šæ£€æŸ¥è´¹
doctor_educationï¼šåŒ»ç”Ÿæ•™è‚²ç¨‹åº¦
member_allianceï¼šæ˜¯å¦æ˜¯æŸä¸ªåŒ»è”ä½“æˆ–åŒ»å…±ä½“çš„æˆå‘˜ï¼›
member_corporateï¼šæ˜¯å¦å±äºâ¼€ä¸ªåŒ»ç–—é›†å›¢/è¿é”æœºæ„ï¼›
univ_affiliationï¼šæ˜¯å¦æ˜¯â¼¤å­¦é™„å±åŒ»ç–—æœºæ„ï¼›
ins_contractorï¼šæ˜¯å¦æ˜¯åŒ»ä¿å®šç‚¹æœºæ„ï¼›
consultation_feeï¼šé—®è¯Šè´¹
doctor_certificateï¼šåŒ»ç”Ÿè¯ä¹¦ç±»åˆ«ï¼›
hospital_classï¼šåŒ»é™¢ç­‰æ¬¡ï¼›
hospital_levelï¼šåŒ»é™¢çº§åˆ«ï¼›
doctor_titleï¼šåŒ»ç”ŸèŒç§°
total_feeï¼šæ€»ä½“è´¹ç”¨









```{r}

# å‰”é™¤ç¼ºå¤±å€¼å¤šçš„æ•°æ®

## åˆ é™¤ç¼ºå¤±ç‡è¶…è¿‡60%çš„å˜é‡
vars_to_remove <- c("treatment_fee", "examination_fee", "doctor_education",
  "member_alliance", "member_corporate",
  "univ_affiliation", "ins_contractor", "consultation_fee", "doctor_certificate",
  "hospital_class", "hospital_level", "doctor_title", "total_fee"
)
formal_data_clean <- formal_data[, !(names(formal_data) %in% vars_to_remove)]


str(formal_data_clean)


```





```{r}




# è¿æ¥USPæ€§åˆ«å’Œå¹´é¾„ï¼Œå¹¶ä¿®æ”¹sp_ageçš„ä¸‰ç­‰çº§
supplemental_data <- read_csv("formal_data_clean_with_sp_name.csv") %>%
  dplyr::select(record_id, sp_gender, sp_age)  # åªä¿ç•™éœ€è¦çš„åˆ—


# åˆå¹¶æ•°æ®ï¼Œç¡®ä¿åªä¿ç•™formal_data_cleanä¸­çš„record_id
formal_data_clean <- formal_data_clean %>%
  left_join(supplemental_data, by = "record_id")




formal_data_clean$sp_gender <- factor(formal_data_clean$sp_gender,
         levels = c("å¥³", "ç”·")
)


# è®¾ç½® sp_age ä¸ºä¸‰ç­‰çº§åˆ†ç±»ï¼ˆsp_age_groupï¼‰
formal_data_clean <- formal_data_clean %>%
  mutate(sp_age_group = case_when(
    sp_age <= 30 ~ "â‰¤30",
    sp_age > 30 & sp_age < 50 ~ "30â€“49",
    sp_age >= 50 ~ "â‰¥50",
    TRUE ~ NA_character_
  )) %>%
  mutate(sp_age_group = factor(sp_age_group, levels = c("â‰¤30", "30â€“49", "â‰¥50")))


```







## è‡ªå˜é‡æ¢ç´¢ä¸é¢„å¤„ç†
### æè¿°æ€§ç»Ÿè®¡ï¼šè¿ç»­å‹æ•°æ®
```{r}


numeric_vars <- c(
  "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
   "waiting_time", "consultation_time", "total_time", "PPPC"
)


# è¿ç»­å˜é‡é¢‘æ•°ç»Ÿè®¡
formal_data_clean %>%
  dplyr::select(all_of(numeric_vars)) %>%
  summary()



str(formal_data_clean)







```


### æè¿°æ€§ç»Ÿè®¡ï¼šåˆ†ç±»å‹æ•°æ®
```{r}

# å‘ç° doctor_female å˜é‡ä¸­ "NI" å–å€¼
formal_data_clean$doctor_female <- as.character(formal_data_clean$doctor_female)
formal_data_clean$doctor_female[formal_data_clean$doctor_female == "NI"] <- NA
formal_data_clean$doctor_female <- as.factor(formal_data_clean$doctor_female)


# æ–¹æ³•1ï¼šä½¿ç”¨ forcats::fct_recode()ï¼ˆæœ€ç®€æ´ï¼‰
formal_data_clean <- formal_data_clean %>%
  mutate(
    sp_gender = fct_recode(sp_gender, NULL = "#N/A")  # å°† "#N/A" è½¬ä¸º NA
  )




# å‘ç° doctor_ethnic å˜é‡ä¸­ "9" å–å€¼
formal_data_clean$doctor_ethnic <- as.character(formal_data_clean$doctor_ethnic)
formal_data_clean$doctor_ethnic[formal_data_clean$doctor_ethnic == "9"] <- NA
formal_data_clean$doctor_ethnic <- as.factor(formal_data_clean$doctor_ethnic)




# factor_vars <- c(
#   "tm", "antibiotic_prescribed","province", "case_type", "diagnosis_quality", "doctor_age", "doctor_ethnic", "doctor_female", "ownership_type", "rural_type", "management_type", "sp_gender", "sp_age_group","institution_type_houyu"
# )


factor_vars <- c(
  "antibiotic_prescribed","province", "case_type", "diagnosis_quality", "doctor_age", "doctor_ethnic", "doctor_female", "ownership_type", "rural_type", "management_type", "sp_gender", "sp_age_group","institution_type_houyu"
)




# åˆ†ç±»å˜é‡é¢‘æ•°ç»Ÿè®¡
for (var in factor_vars) {
  cat("\nå˜é‡:", var, "\n")
  tab <- table(formal_data_clean[[var]], useNA = "ifany")
  prop <- prop.table(tab)
  df <- data.frame(
    ç±»åˆ« = names(tab),
    é¢‘æ•° = as.vector(tab),
    ç™¾åˆ†æ¯” = round(100 * as.vector(prop), 1)
  )
  print(df)
}







```


`antibiotic_prescribed` ç™¾åˆ†æ¯”æ˜¯9.5%ï¼Œå¯ä»¥ç”¨ORå€¼




### è‡ªå˜é‡é—´å¤šé‡å…±çº¿æ€§æ£€æµ‹
#### æ£€æµ‹è¿ç»­å˜é‡ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§
```{r}



# è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ
cor_matrix <- cor(formal_data_clean[, numeric_vars], use = "pairwise.complete.obs")
print(round(cor_matrix, 2))



# å››èˆäº”å…¥åå†™å…¥ CSV æ–‡ä»¶
write.csv(round(cor_matrix, 2), file = "correlation_matrix.csv", row.names = TRUE)








```

è¿ç»­å˜é‡é—´ï¼šç›¸å…³ç³»æ•° `|r| > 0.8` å¯è§†ä¸ºå­˜åœ¨è¾ƒå¼ºå…±çº¿æ€§ã€‚

`total_fee` å’Œ `medication_fee` ç›¸å…³æ€§å¾ˆå¤§


#### æ£€æµ‹åˆ†ç±»å˜é‡ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§
```{r}





library(car)

# # æ„é€ ä¸€ä¸ªåªå«å›ºå®šæ•ˆåº”çš„é€»è¾‘å›å½’æ¨¡å‹
# glm_model <- glm(antibiotic_prescribed ~  tm + province + case_type + diagnosis_quality + doctor_age+doctor_ethnic+doctor_female+ownership_type+rural_type+institution_type_houyu+management_type+sp_gender+sp_age_group, data = formal_data_clean, family = binomial)


# æ„é€ ä¸€ä¸ªåªå«å›ºå®šæ•ˆåº”çš„é€»è¾‘å›å½’æ¨¡å‹
glm_model <- glm(antibiotic_prescribed ~ province + case_type + diagnosis_quality + doctor_age+doctor_ethnic+doctor_female+ownership_type+rural_type+institution_type_houyu+management_type+sp_gender+sp_age_group, data = formal_data_clean, family = binomial)




library(correlation)
correlation::correlation(formal_data_clean[, c("province","case_type","diagnosis_quality",
                                               "doctor_age","doctor_ethnic","doctor_female",
                                               "ownership_type","rural_type",
                                               "institution_type_houyu","management_type",
                                               "sp_gender","sp_age_group")], 
                         method = "cramer")  # åˆ†ç±»å˜é‡ç”¨ CramÃ©r's V









# è®¡ç®— VIF
vif(glm_model)


alias(glm_model)




# è®¡ç®— VIF å¹¶ä¿ç•™ä¸¤ä½å°æ•°
# vif_df <- data.frame(round(vif(glm_model), 2))

# ä¿å­˜ä¸º CSV æ–‡ä»¶
write.csv(vif_df, "vif_results.csv", row.names = TRUE)



# table(formal_data_clean$institution_type_houyu)



# å®‰è£…ä¸€æ¬¡å³å¯
install.packages("lsr")

# åŠ è½½åŒ…
library(lsr)
library(dplyr)
library(tidyr)
library(purrr)

# å®šä¹‰å‡½æ•°ï¼šç”Ÿæˆ CramÃ©r's V çŸ©é˜µ
cramers_v_matrix <- function(data, vars) {
  comb <- combn(vars, 2, simplify = FALSE)
  
  results <- purrr::map_df(comb, ~{
    tibble(
      var1 = .x[1],
      var2 = .x[2],
      cramers_v = lsr::cramersV(table(data[[.x[1]]], data[[.x[2]]]))
    )
  })
  
  # è½¬ä¸ºçŸ©é˜µå½¢å¼
  mat <- results %>%
    pivot_wider(names_from = var2, values_from = cramers_v) %>%
    column_to_rownames("var1")
  
  mat <- as.matrix(mat)
  mat[lower.tri(mat)] <- t(mat)[lower.tri(mat)]
  diag(mat) <- 1
  
  return(mat)
}

# ğŸ”¹ å˜é‡é›†åˆï¼ˆå…¨æ˜¯åˆ†ç±»å˜é‡ï¼‰
vars <- c("province","case_type","diagnosis_quality",
          "doctor_age","doctor_ethnic","doctor_female",
          "ownership_type","rural_type",
          "institution_type_houyu","management_type",
          "sp_gender","sp_age_group")

# è®¡ç®— CramÃ©r's V çŸ©é˜µ
cramer_matrix <- cramers_v_matrix(formal_data_clean, vars)

# è¾“å‡ºç»“æœï¼Œä¿ç•™ä¸¤ä½å°æ•°
print(round(cramer_matrix, 2))


write.csv(round(cramer_matrix, 2), "cramers_v_matrix.csv")






```

å¯¹äºå¤šç±»åˆ«çš„åˆ†ç±»å˜é‡ï¼Œ**åªè¾“å‡ºæ€»çš„ GVIFï¼ˆä»¥åŠå…¶è°ƒæ•´å€¼ï¼‰**æ˜¯æ¨èåšæ³•ï¼Œä¸éœ€è¦æ¯ä¸ªè™šæ‹Ÿå˜é‡éƒ½å•ç‹¬è¾“å‡º VIFã€‚â€”â€”æ³¨æ„ï¼Œè¿™ä¸ªæ˜¯å’Œç®¡è€å¸ˆé‚£ç¯‡æ–‡ç« ä¸ä¸€æ ·çš„åœ°æ–¹



**è®¡ç®—åˆ†ç±»å˜é‡çš„æ–¹å·®è†¨èƒ€å› å­ï¼ˆVIFï¼‰ï¼Œæ˜¯åœ¨å»ºç«‹glmmæ¨¡å‹æ—¶è¿›è¡Œå—?**

VIF çš„è®¡ç®—å»ºè®®åœ¨ GLMM å»ºç«‹ä¹‹å‰è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨å»ºç«‹ GLMM æ—¶è¿›è¡Œã€‚
åŸå› å¦‚ä¸‹ï¼š

1. VIF æ˜¯è¯„ä¼°å›ºå®šæ•ˆåº”å˜é‡ä¹‹é—´çš„å¤šé‡å…±çº¿æ€§å·¥å…·ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡æ‹Ÿåˆä¸€ä¸ªæ™®é€šçš„çº¿æ€§ï¼ˆæˆ–å¹¿ä¹‰çº¿æ€§ï¼‰æ¨¡å‹è®¡ç®—å‡ºæ¥çš„ï¼›

1. GLMM å¼•å…¥äº†éšæœºæ•ˆåº”ï¼ˆå¦‚ (1 | province_id)ï¼‰ä¹‹åï¼Œæ¨¡å‹ç»“æ„å˜å¤æ‚ï¼ŒVIF çš„å®šä¹‰å’Œè®¡ç®—å°±ä¸å†ç›´æ¥é€‚ç”¨ï¼›

1. å› æ­¤ï¼Œæ¨èåœ¨å»ºç«‹ GLMM ä¹‹å‰ï¼Œä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„é€»è¾‘å›å½’æ¨¡å‹ï¼ˆå¦‚ glm()ï¼‰è¿›è¡Œ VIF æ£€æŸ¥ã€‚


**ç»“æœè§£è¯»**
1. æ²¡æœ‰å˜é‡ GVIF^(1/(2*Df)) 5
   - é€šå¸¸æˆ‘ä»¬çœ‹çš„æ˜¯æœ€åä¸€åˆ— GVIF^(1/(2*Df))ï¼Œå®ƒæ ‡å‡†åŒ–äº†è§£é‡Šå˜é‡çš„è‡ªç”±åº¦ã€‚
   - å®åŠ¡ä¸­è‹¥è¯¥å€¼ > 5ï¼ˆæœ‰äº›ç ”ç©¶æ›´ä¸¥ä¸€ç‚¹ç”¨ 2 æˆ– 3ï¼‰ï¼Œè¯´æ˜å…±çº¿æ€§ä¸¥é‡ã€‚

1. ä½ çš„æ‰€æœ‰å˜é‡éƒ½ < 3ï¼Œå¤§å¤šæ•° < 1.3ï¼Œè¯´æ˜ï¼š
   - ğŸ’¡å½“å‰å›ºå®šæ•ˆåº”å˜é‡ä¹‹é—´çš„å¤šé‡å…±çº¿æ€§é—®é¢˜å¾ˆè½»å¾®ï¼Œæ— éœ€åˆ é™¤æˆ–åˆå¹¶å˜é‡ã€‚



## æ¨¡å‹æ„å»º



### æ‰§è¡Œä¼—æ•°æ’è¡¥
```{r}


# å®šä¹‰ä¼—æ•°å‡½æ•°ï¼ˆè¿”å›å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼ï¼‰
get_mode <- function(v) {
  v <- na.omit(v)
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}




library(tidyverse)


formal_data_final_modeimputed <- formal_data_clean %>%
  mutate(
    # åˆ†ç±»å˜é‡ï¼šä¿æŒç±»å‹ä¸€è‡´ï¼Œä½¿ç”¨ coalesce + get_mode æ›´ç¨³å¦¥
    diagnosis_quality   = coalesce(diagnosis_quality, get_mode(diagnosis_quality)),
    doctor_age          = coalesce(doctor_age, get_mode(doctor_age)),
    doctor_ethnic       = coalesce(doctor_ethnic, get_mode(doctor_ethnic)),
    doctor_female       = coalesce(doctor_female, get_mode(doctor_female)),
    rural_type          = coalesce(rural_type, get_mode(rural_type)),
    ownership_type      = coalesce(ownership_type, get_mode(ownership_type)),
    management_type     = coalesce(management_type, get_mode(management_type)),
    sp_gender     = coalesce(sp_gender , get_mode(sp_gender )),
    sp_age_group = coalesce(sp_age_group, get_mode(sp_age_group)),
    institution_type_houyu = coalesce(institution_type_houyu, get_mode(institution_type_houyu)),
#    tm,

    # è¿ç»­å˜é‡ï¼šç”¨ä¸­ä½æ•°æ’è¡¥
    physical_exam_ratio = coalesce(physical_exam_ratio, median(physical_exam_ratio, na.rm = TRUE)),
    lab_imaging_ratio   = coalesce(lab_imaging_ratio, median(lab_imaging_ratio, na.rm = TRUE)),
    waiting_time        = coalesce(waiting_time, median(waiting_time, na.rm = TRUE)),
    consultation_time   = coalesce(consultation_time, median(consultation_time, na.rm = TRUE)),
    total_time          = coalesce(total_time, median(total_time, na.rm = TRUE)),
    sp_age              = coalesce(sp_age, median(sp_age, na.rm = TRUE)),
  )




str(formal_data_final_modeimputed)





colSums(is.na(formal_data_final_modeimputed))








```









### æ„å»ºglmæ¨¡å‹ï¼š
#### å…ˆå•å› ç´ å†å¤šå› ç´ 






```{r}


# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

library(dplyr)
library(broom)
library(car)
library(purrr)

# è®¾ç½®å‚è€ƒç»„
formal_data_final_modeimputed$case_type <- relevel(factor(formal_data_final_modeimputed$case_type), ref = "åå¤´ç—›")

# å°† sp_age è½¬ä¸ºä¸‰åˆ†ç±»å˜é‡
formal_data_final_modeimputed <- formal_data_final_modeimputed %>%
  mutate(sp_age_group = case_when(
    sp_age <= 30 ~ "â‰¤30",
    sp_age > 30 & sp_age < 50 ~ "30-49",
    sp_age >= 50 ~ "â‰¥50",
    TRUE ~ NA_character_
  )) %>%
  mutate(sp_age_group = factor(sp_age_group, levels = c("â‰¤30", "30-49", "â‰¥50")))

# æ‰€æœ‰è‡ªå˜é‡ï¼ˆæ³¨æ„æ›¿æ¢ sp_age ä¸º sp_age_groupï¼‰
# all_vars <- c(
#   "tm", "province", "case_type", "diagnosis_quality",
#   "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
#   "doctor_age", "doctor_ethnic", "doctor_female",
#   "ownership_type", "rural_type", "management_type",
#   "waiting_time", "consultation_time", "total_time", "institution_type_houyu",
#   "sp_gender", "sp_age_group", "PPPC"
# )


all_vars <- c(
  "province", "case_type", "diagnosis_quality",
  "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
  "doctor_age", "doctor_ethnic", "doctor_female",
  "ownership_type", "rural_type", "management_type",
  "waiting_time", "consultation_time", "total_time", "institution_type_houyu",
  "sp_gender", "sp_age_group", "PPPC"
)




# å‡½æ•°ï¼šè·‘å•å› ç´ åˆ†æå¹¶æå–ORã€95%CIã€På€¼
get_univ_results <- function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = formal_data_final_modeimputed, family = binomial)

  tidy_result <- broom::tidy(model, conf.int = TRUE, exponentiate = TRUE)
  tidy_result$variable <- var

  # æå–æ•´ä½“På€¼
  overall_p <- tryCatch({
    p_val <- car::Anova(model, type = "II")$`Pr(>Chisq)`[1]
    p_val
  }, error = function(e) NA)

  tidy_result$overall_p <- overall_p
  return(tidy_result)
}

# æ‰¹é‡å¤„ç†
univ_all_results <- map_dfr(all_vars, get_univ_results)

# æ•´ç†è¾“å‡ºï¼ˆå‰”é™¤æˆªè·ï¼‰å¹¶å››èˆäº”å…¥
univ_clean <- univ_all_results %>%
  filter(term != "(Intercept)") %>%
  dplyr::select(variable, term, estimate, conf.low, conf.high, p.value, overall_p) %>%
  mutate(across(c(estimate, conf.low, conf.high, p.value, overall_p), ~ round(., 2))) %>%
  arrange(overall_p)

# æ‰“å°æŸ¥çœ‹
print(univ_clean)

# ä¿å­˜ä¸º CSVï¼ŒåŠ æ—¶é—´æˆ³
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("univariate_logistic_results_", timestamp, ".csv")
write.csv(univ_clean, filename, row.names = FALSE)

str(formal_data_final_modeimputed)


```


æ•°æ®æ¡†é‡Œï¼Œestimate â†’ å°±æ˜¯ OR
æœ€ç»ˆæ–‡æ¡£è§`univariate_logistic_results_20250619_151247`




å•å› ç´ åˆ†æåœ¨æµè¡Œç—…å­¦ç ”ç©¶ä¸­çš„æ ‡å‡†åšæ³•ï¼š

1. ç­›é€‰ä¸ç»“å±€å˜é‡ï¼ˆæ¯”å¦‚ antibiotic_prescribedï¼‰æ˜¾è‘—ç›¸å…³çš„å› ç´ ï¼Œä¸ºåç»­å¤šå› ç´ åˆ†æåšå‡†å¤‡ï¼›

2. å•å› ç´ åˆ†ææ—¶ï¼Œæ˜¯æŠŠ11ä¸ªç—…ä¾‹æ”¾å…¥ï¼Œè¿˜æ˜¯ä»€ä¹ˆï¼Ÿ
ç­”ï¼šR ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªå› å­å˜é‡ï¼ŒæŠŠå…¶ä¸­ 1 ç±»è®¾ä¸ºå‚è€ƒç»„ï¼Œå¦å¤– 10 ç±»åˆ†åˆ«ä¸å‚è€ƒç»„æ¯”è¾ƒï¼Œè¾“å‡ºæ¯ä¸€ç±»çš„ OR å’Œ P å€¼ã€‚

3. å¦å¤–ï¼Œ11ä¸ªç—…ä¾‹å¦‚æœåªæœ‰å‡ ä¸ªæœ‰æ˜¾è‘—æ„ä¹‰ï¼Œé‚£æ€ä¹ˆå¤„ç†ï¼Ÿ
ç­”ï¼šæŠŠæ•´ä¸ªå˜é‡ case_type æ”¾å…¥å¤šå› ç´ æ¨¡å‹ä¸­ï¼Œä¸ç®¡å…·ä½“å“ªä¸ªç±»æ˜¾è‘—ã€å“ªä¸ªä¸æ˜¾è‘—ã€‚


è¿™å„¿åªæœ‰waiting timeï¼ŒPPPCè¿˜æœ‰doctor ethnicæ˜¯éœ€è¦åˆ é™¤çš„ï¼Œä½†æ˜¯åä¸¤è€…æ˜¯åŒ»ç”Ÿçš„ä¸ªäººç‰¹å¾ï¼Œè¿˜æ˜¯å…ˆçº³å…¥å§














### æ„å»ºglmæ¨¡å‹ï¼ŒäºŒåˆ†ç±»å˜é‡â€”â€”ä¸ç”¨è¿™ä¸ªä»£ç ï¼Œç”¨ä¸‹é¢çš„Firth æƒ©ç½šé€»è¾‘å›å½’
medication_feeã€other_feeæ²¡æœ‰æ”¾






case_typeå„åˆ†ç±»çš„ORå€¼å¼‚å¸¸é«˜ï¼ˆå¦‚æ™®é€šæ„Ÿå†’çš„OR=2.8äº¿ï¼‰,å½“æŸäº›ç—…ä¾‹ç±»å‹ï¼ˆå¦‚"æ™®é€šæ„Ÿå†’"ï¼‰çš„æ‰€æœ‰æ‚£è€…è¦ä¹ˆå…¨éƒ¨å¼€æŠ—ç”Ÿç´ ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å¼€æŠ—ç”Ÿç´ æ—¶ï¼Œä¼šå¯¼è‡´é€»è¾‘å›å½’ç³»æ•°æ— é™å¤§ï¼ˆORå€¼çˆ†ç‚¸ï¼‰ã€‚éœ€è¦ä½¿ç”¨ Firthæ ¡æ­£é€»è¾‘å›å½’ è§£å†³åˆ†ç¦»é—®é¢˜ï¼š

å¦å¤–ï¼Œå…³äºç”¨RRè¿˜æ˜¯ORå€¼ï¼š
1. ä¼˜å…ˆä½¿ç”¨ OR çš„æƒ…å†µ
âœ… ç ”ç©¶ç›®æ ‡ä¸ºæ¢ç´¢æ€§åˆ†æï¼ˆå¦‚å˜é‡ç­›é€‰ï¼‰
âœ… å­˜åœ¨ç½•è§äº‹ä»¶ï¼ˆ<10%ï¼‰æˆ–æ•°æ®åˆ†ç¦»ï¼ˆå¦‚æŸäº›ç—…ä¾‹ç±»å‹100%å¼€æŠ—ç”Ÿç´ ï¼‰
âœ… éœ€è¦ä¸æ—¢å¾€æ–‡çŒ®ä¿æŒä¸€è‡´ï¼ˆå¤šæ•°ç—…ä¾‹å¯¹ç…§ç ”ç©¶é»˜è®¤æŠ¥å‘ŠORï¼‰

1. ä¼˜å…ˆä½¿ç”¨ RR çš„æƒ…å†µ
âœ… ç ”ç©¶ç›®æ ‡ä¸ºä¸´åºŠå†³ç­–æ”¯æŒï¼ˆéœ€ç›´æ¥è§£é‡Šé£é™©å˜åŒ–ï¼‰
âœ… å‘ç”Ÿç‡æ¥è¿‘10%é˜ˆå€¼ï¼ˆå¦‚ä½ çš„9.5%ï¼‰ä¸”æ¨¡å‹æ”¶æ•›è‰¯å¥½
âœ… è¯»è€…ç¾¤ä½“æ›´ç†Ÿæ‚‰RRï¼ˆå¦‚å…¬å…±å«ç”Ÿæˆ–æ”¿ç­–ç ”ç©¶ï¼‰



ä»¥ä¸Šå…¨å¤±æ•ˆï¼Œåº”è¯¥ç”¨åå¤´ç—›ç—…ä¾‹ä½œä¸ºreferenceç»„â€”â€”ç»“è®ºå¯ä»¥ç”¨ï¼š

1. case_typeæ™®é€šæ„Ÿå†’
2. case_typeèƒƒç‚
3. case_typeå“®å–˜
4. diagnosis_qualityé”™è¯¯
5. lab_imaging_ratio
6. case_typeå‹åŠ›æ€§å°¿å¤±ç¦
7. rural_typerural
8. consultation_time
9. diagnosis_qualityéƒ¨åˆ†æ­£ç¡®









### ä½¿ç”¨ Firthæ ¡æ­£é€»è¾‘å›å½’ è§£å†³åˆ†ç¦»é—®é¢˜ï¼šå¿…é¡»è¦ç”¨Firthæ ¡æ­£ï¼Œå› ä¸ºäº§åæŠ‘éƒæŠ—ç”Ÿç´ æ•°é‡æ˜¯0â€”â€”
```{r}


# å®‰è£…å¹¶åŠ è½½å¿…è¦åŒ…
if (!requireNamespace("logistf", quietly = TRUE)) {
  install.packages("logistf")
}
library(logistf)

if (!requireNamespace("openxlsx", quietly = TRUE)) {
  install.packages("openxlsx")
}
library(openxlsx)

# è®¾ç½®å‚è€ƒæ°´å¹³
formal_data_final_modeimputed$case_type <- relevel(
  factor(formal_data_final_modeimputed$case_type),
  ref = "åå¤´ç—›"
)

# æŸ¥çœ‹ case_type ä¸ antibiotic_prescribed çš„åˆ†å¸ƒ
table(formal_data_final_modeimputed$case_type, formal_data_final_modeimputed$antibiotic_prescribed)


# ### å˜é‡1ï¼šä¸­è¯ã€åˆ é™¤è¥åˆ©éè¥åˆ©ã€èµµåšå®‡æ¨èçš„æœºæ„åˆ†ç±»
# # æ‹Ÿåˆ Firth æ ¡æ­£ logistic å›å½’æ¨¡å‹
# firth_model <- logistf(
#   antibiotic_prescribed ~
#     tm +
#     case_type +
#     consultation_time +
#     diagnosis_quality +
#     doctor_female +
#     history_taking_ratio +
#     lab_imaging_ratio +
#     ownership_type +
#     institution_type_houyu +
#     physical_exam_ratio +
#     province +
#     rural_type +
#     sp_gender +
#     sp_age_group +
#     total_time +
#     doctor_age +
#     doctor_ethnic,
#   data = formal_data_final_modeimputed
# )

#
# ### å˜é‡2ï¼šå‘ç°èµµåšå®‡è€å¸ˆå»ºè®®çš„ç»“æœï¼Œè·‘å‡ºæ¥ä¹‹åä¸»ä½“ç ”ç©¶å’Œæ•æ„Ÿæ€§åˆ†æç»“æœç›¸å·®å¾ˆå¤§ã€‚æœ€ç»ˆå»é™¤tmï¼ŒåŠ ä¸Šæœºæ„åˆ†ç±»ï¼Œå»é™¤è¥åˆ©å’Œéè¥åˆ©
# firth_model <- logistf(
#   antibiotic_prescribed ~
#     case_type +
#     consultation_time +
#     diagnosis_quality +
#     doctor_female +
#     history_taking_ratio +
#     lab_imaging_ratio +
#     ownership_type +
#     institution_type_houyu +
#     physical_exam_ratio +
#     province +
#     rural_type +
#     sp_gender +
#     sp_age_group +
#     total_time +
#     doctor_age +
#     doctor_ethnic,
#   data = formal_data_final_modeimputed
# )



### å˜é‡3ï¼šå‘ç°å˜é‡2è·‘å‡ºæ¥ä¹‹åä¸»ä½“ç ”ç©¶å’Œæ•æ„Ÿæ€§åˆ†æç»“æœç›¸å·®å¾ˆå¤§ã€‚æœ€ç»ˆå»é™¤tmï¼Œå»é™¤æœºæ„åˆ†ç±»ï¼Œå»é™¤è¥åˆ©å’Œéè¥åˆ©
firth_model <- logistf(
  antibiotic_prescribed ~
    case_type +
    consultation_time +
    diagnosis_quality +
    doctor_female +
    history_taking_ratio +
    lab_imaging_ratio +
    ownership_type +
    physical_exam_ratio +
    province +
    rural_type +
    sp_gender +
    sp_age_group +
    total_time +
    doctor_age +
    doctor_ethnic,
  data = formal_data_final_modeimputed
)






# æŸ¥çœ‹æ¨¡å‹æ‘˜è¦
summary(firth_model)

# æå–ä¼°è®¡ç³»æ•°ï¼ˆlog ORï¼‰
coef_est <- coef(firth_model)

# è®¡ç®— ORï¼Œä¿ç•™3ä½å°æ•°
or <- round(exp(coef_est), 3)

# æå–ç½®ä¿¡åŒºé—´ï¼Œä½¿ç”¨ confint()ï¼Œå¹¶è½¬æ¢ä¸º OR èŒƒå›´ï¼Œä¿ç•™3ä½å°æ•°
ci <- confint(firth_model)
ci_lower <- round(exp(ci[, 1]), 3)
ci_upper <- round(exp(ci[, 2]), 3)

# æå– P å€¼ï¼Œæ ¼å¼åŒ–ï¼Œä¿ç•™3ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœï¼Œä¿å­˜ä¸º or_table_firth
or_table_firth <- data.frame(
  Variable = names(coef_est),
  OR = or,
  CI_lower = ci_lower,
  CI_upper = ci_upper,
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼å‡åºæ’åº
or_table_firth <- or_table_firth[order(as.numeric(gsub("<", "", or_table_firth$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table_firth)

# ç”Ÿæˆå¸¦å½“å‰æ—¥æœŸçš„æ–‡ä»¶å
output_filename <- paste0("or_table_firth-", format(Sys.time(), "%Y-%m-%d"), ".xlsx")

# ä¿å­˜ä¸º Excel æ–‡ä»¶
write.xlsx(or_table_firth, file = output_filename)

# æ¸…ç†ä¸´æ—¶å˜é‡
rm(output_filename)



or_table_firth




# æå– log-likelihoodï¼ˆå®Œæ•´æ¨¡å‹çš„å¯¹æ•°ä¼¼ç„¶ï¼‰
logLik_firth <- firth_model$loglik["full"]

# å‚æ•°ä¸ªæ•°ï¼ˆåŒ…å«æˆªè·ï¼‰
k <- length(coef(firth_model))

# æ ·æœ¬é‡
n <- nrow(formal_data_final_modeimputed)

# æ‰‹åŠ¨è®¡ç®— AIC å’Œ BIC
AIC_firth <- -2 * logLik_firth + 2 * k
BIC_firth <- -2 * logLik_firth + log(n) * k

# æ‰“å°ç»“æœ
AIC_firth
BIC_firth








```

OR > 1ï¼šè¯¥å˜é‡æ°´å¹³è¶Šé«˜ï¼Œæ›´æœ‰å¯èƒ½å‘ç”Ÿå› å˜é‡ä¸º 1ï¼ˆå¦‚å¼€æŠ—ç”Ÿç´ ï¼‰

OR < 1ï¼šè¯¥å˜é‡æ°´å¹³è¶Šé«˜ï¼Œæ›´ä¸å¯èƒ½å‘ç”Ÿå› å˜é‡ä¸º 1

OR = 1ï¼šè¯¥å˜é‡ä¸å› å˜é‡æ²¡æœ‰å…³è”

lab_imaging_ratioï¼šOR = 0.39ï¼Œp = 0.0069
æ¯å•ä½æå‡ lab_imaging_ratioï¼Œå¤„æ–¹æŠ—ç”Ÿç´ çš„å¯èƒ½æ€§ä¸‹é™äº†çº¦ 61%ï¼ˆ1 - 0.39ï¼‰

ç½®ä¿¡åŒºé—´ï¼ˆ0.18â€“0.78ï¼‰ä¸åŒ…å« 1ï¼Œè¯´æ˜æ˜¾è‘—ç›¸å…³

ğŸ‘‰ è§£é‡Šï¼šæ£€æŸ¥ç‡è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“å¼€æŠ—ç”Ÿç´ ï¼Œå¯èƒ½å› ä¸ºè¯Šæ–­æ›´æ˜ç¡®äº†ã€‚


1. case_typeæ™®é€šæ„Ÿå†’
1. case_typeèƒƒç‚
1. case_typeå“®å–˜
1. lab_imaging_ratio
1. diagnosis_qualityé”™è¯¯
1. case_typeäº§åæŠ‘éƒ
1. rural_typerural
1. case_typeå‹åŠ›æ€§å°¿å¤±ç¦
1. consultation_time
1. diagnosis_qualityéƒ¨åˆ†æ­£ç¡®





### æ„å»ºglmæ¨¡å‹ï¼Œè¿ç»­å‹å˜é‡â€”â€”åˆ¤æ–­æ•æ„Ÿæ€§â€”â€”åŸç‰ˆ
```{r}

# å…ˆå•å› ç´ 

library(car)
library(dplyr)
library(openxlsx)

# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®¾ç½®å› å˜é‡
outcome_var <- "antibiotic_prescribed_num"

# æ‰€æœ‰è‡ªå˜é‡
all_vars <- c("tm", "province", "case_type", "diagnosis_quality",
              "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
              "doctor_age", "doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type", "institution_type_houyu",
              "waiting_time", "consultation_time", "total_time",
              "sp_gender", "sp_age_group", "PPPC")

# åˆ†ç±»å˜é‡åˆ—è¡¨
categorical_vars <- c("province", "case_type", "diagnosis_quality", "doctor_age",
                      "doctor_ethnic", "doctor_female", "ownership_type", "institution_type_houyu",
                      "rural_type", "management_type", "sp_gender", "sp_age_group")

# ç¡®ä¿åˆ†ç±»å˜é‡æ˜¯å› å­
formal_data_final_modeimputed <- formal_data_final_modeimputed %>%
  mutate(across(all_of(categorical_vars), as.factor))

# æå–æ¯ä¸ªå˜é‡çš„å›å½’ç»“æœ
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste(outcome_var, "~", var))
  model <- tryCatch(
    glm(formula_uni, data = formal_data_final_modeimputed, family = gaussian),
    error = function(e) return(NULL)
  )
  if (is.null(model)) return(NULL)

  coefs <- summary(model)$coefficients
  ci <- tryCatch(confint(model), error = function(e) return(NULL))
  if (is.null(ci)) return(NULL)

  # æ’é™¤æˆªè·
  terms <- rownames(coefs)[-1]
  data.frame(
    Variable = var,
    Term = terms,
    Beta = round(coefs[-1, 1], 3),
    CI_lower = round(ci[-1, 1], 3),
    CI_upper = round(ci[-1, 2], 3),
    P_value = round(coefs[-1, 4], 4)
  )
})

# åˆå¹¶æ‰€æœ‰å˜é‡çš„ç»“æœ
univ_table <- bind_rows(univ_results) %>% arrange(P_value)

# è¾“å‡ºç»“æœ
cat("===== å•å› ç´ çº¿æ€§å›å½’ï¼šBeta, CI å’Œ P å€¼ =====\n")
print(univ_table)



# ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("robustness_univ_results_", timestamp, ".xlsx")

# ä¿å­˜ä¸º Excel
write.xlsx(univ_table, file = filename)



```

æœ€ç»ˆæ–‡æ¡£è§`robustness_univ_results.xlsx`




ä¿ç•™<0.2çš„

wait time å’ŒPPPCåˆ é™¤





```{r}

# å†å¤šå› ç´ åˆ†æâ€”â€”åŸç‰ˆ


library(dplyr)
library(openxlsx)




## å› å˜é‡
## outcome_var <- "antibiotic_prescribed_num"


formal_data_final_modeimputed <- formal_data_final_modeimputed %>%
  mutate(antibiotic_prescribed = as.numeric(as.character(antibiotic_prescribed)))


# å› å˜é‡â€”â€”äºŒå…ƒè½¬ä¸ºæ•°å€¼â€”â€”è¿˜æ˜¯è¦å˜æˆäºŒå…ƒçš„
outcome_var <- "antibiotic_prescribed"


# æœ€ç»ˆå˜é‡åˆ—è¡¨ï¼ˆå«å¼ºåˆ¶çº³å…¥ + p<0.2ï¼‰
final_vars <- c("tm", "province", "case_type", "diagnosis_quality",
              "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
              "doctor_age", "doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "institution_type_houyu",
              "consultation_time", "total_time",
              "sp_gender", "sp_age_group"
)

# æ„å»ºå…¬å¼
formula_multi <- as.formula(
  paste(outcome_var, "~", paste(final_vars, collapse = " + "))
)

# æ‹Ÿåˆå¤šå…ƒçº¿æ€§å›å½’æ¨¡å‹
multi_model <- lm(formula_multi, data = formal_data_final_modeimputed)

# æå–æ¨¡å‹æ‘˜è¦å’Œç½®ä¿¡åŒºé—´
model_summary <- summary(multi_model)

summary(multi_model)


model_ci <- confint(multi_model)

# æ„å»ºç»“æœè¡¨æ ¼ï¼Œä¿ç•™ 6 ä½å°æ•°
multi_results <- data.frame(
  Term = rownames(model_summary$coefficients),
  Coef = round(model_summary$coefficients[, "Estimate"], 6),
  CI_lower = round(model_ci[, 1], 6),
  CI_upper = round(model_ci[, 2], 6),
  P_value = round(model_summary$coefficients[, "Pr(>|t|)"], 6)
)

# å»æ‰æˆªè·å¹¶æŒ‰ P å€¼æ’åº
multi_results <- multi_results %>%
  filter(Term != "(Intercept)") %>%
  arrange(P_value)

# è¾“å‡º
print(multi_results)

# ä¿å­˜ä¸º Excel æ–‡ä»¶ï¼ˆå¸¦æ—¥æœŸï¼‰
output_filename <- paste0("multi_results2-", format(Sys.time(), "%Y-%m-%d"), ".xlsx")
write.xlsx(multi_results, file = output_filename)

# æ¸…ç†å˜é‡ï¼ˆå¯é€‰ï¼‰
rm(output_filename)


print(multi_model)



AIC(multi_model)
BIC(multi_model)





```
æœ€åè¾“å‡ºç»“æœè§`multi_results2-2025-06-26`





### æ„å»ºglmæ¨¡å‹ï¼Œè¿ç»­å‹å˜é‡â€”â€”åˆ¤æ–­æ•æ„Ÿæ€§â€”â€”èµµåšå®‡è€å¸ˆå»ºè®®æŠŠæ•°æ®å‰”é™¤äº§åæŠ‘éƒçš„å†è·‘
```{r}

library(car)
library(dplyr)
library(openxlsx)

# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®¾ç½®å› å˜é‡
outcome_var <- "antibiotic_prescribed_num"

# æ‰€æœ‰è‡ªå˜é‡
all_vars <- c("tm", "province", "case_type", "diagnosis_quality",
              "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
              "doctor_age", "doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type", "institution_type_houyu",
              "waiting_time", "consultation_time", "total_time",
              "sp_gender", "sp_age_group", "PPPC")

# åˆ†ç±»å˜é‡åˆ—è¡¨
categorical_vars <- c("province", "case_type", "diagnosis_quality", "doctor_age",
                      "doctor_ethnic", "doctor_female", "ownership_type", "institution_type_houyu",
                      "rural_type", "management_type", "sp_gender", "sp_age_group")

# ç¡®ä¿åˆ†ç±»å˜é‡æ˜¯å› å­
formal_data_final_modeimputed <- formal_data_final_modeimputed %>%
  mutate(across(all_of(categorical_vars), as.factor))



formal_data_final_modeimputed_houyu <- formal_data_final_modeimputed %>%
  filter(case_type != "äº§åæŠ‘éƒ")




# æå–æ¯ä¸ªå˜é‡çš„å›å½’ç»“æœ
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste(outcome_var, "~", var))
  model <- tryCatch(
    glm(formula_uni, data = formal_data_final_modeimputed_houyu, family = gaussian),
    error = function(e) return(NULL)
  )
  if (is.null(model)) return(NULL)

  coefs <- summary(model)$coefficients
  ci <- tryCatch(confint(model), error = function(e) return(NULL))
  if (is.null(ci)) return(NULL)

  # æ’é™¤æˆªè·
  terms <- rownames(coefs)[-1]
  data.frame(
    Variable = var,
    Term = terms,
    Beta = round(coefs[-1, 1], 3),
    CI_lower = round(ci[-1, 1], 3),
    CI_upper = round(ci[-1, 2], 3),
    P_value = round(coefs[-1, 4], 4)
  )
})

# åˆå¹¶æ‰€æœ‰å˜é‡çš„ç»“æœ
univ_table <- bind_rows(univ_results) %>% arrange(P_value)

# è¾“å‡ºç»“æœ
cat("===== å•å› ç´ çº¿æ€§å›å½’ï¼šBeta, CI å’Œ P å€¼ =====\n")
print(univ_table)



# ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("robustness_univ_results_houyu", timestamp, ".xlsx")

# ä¿å­˜ä¸º Excel
write.xlsx(univ_table, file = filename)



```

æœ€ç»ˆæ–‡æ¡£è§`robustness_univ_results.xlsx`




ä¿ç•™<0.2çš„

wait time å’ŒPPPCåˆ é™¤





```{r}

# å†å¤šå› ç´ åˆ†æ


library(dplyr)
library(openxlsx)




## å› å˜é‡
## outcome_var <- "antibiotic_prescribed_num"


formal_data_final_modeimputed_houyu <- formal_data_final_modeimputed_houyu %>%
  mutate(antibiotic_prescribed = as.numeric(as.character(antibiotic_prescribed)))


# å› å˜é‡â€”â€”äºŒå…ƒè½¬ä¸ºæ•°å€¼â€”â€”è¿˜æ˜¯è¦å˜æˆäºŒå…ƒçš„
outcome_var <- "antibiotic_prescribed"




# # ### ä¸­è¯ã€åˆ é™¤è¥åˆ©éè¥åˆ©ã€èµµåšå®‡æ¨èçš„æœºæ„åˆ†ç±»
# # æœ€ç»ˆå˜é‡åˆ—è¡¨ï¼ˆå«å¼ºåˆ¶çº³å…¥ + p<0.2ï¼‰
# final_vars <- c("tm", "province", "case_type", "diagnosis_quality",
#               "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
#               "doctor_age", "doctor_ethnic", "doctor_female",
#               "ownership_type", "rural_type", "institution_type_houyu",
#               "consultation_time", "total_time",
#               "sp_gender", "sp_age_group"
# )



### å‘ç°èµµåšå®‡è€å¸ˆå»ºè®®çš„ç»“æœï¼Œè·‘å‡ºæ¥ä¹‹åä¸»ä½“ç ”ç©¶å’Œæ•æ„Ÿæ€§åˆ†æç»“æœç›¸å·®å¾ˆå¤§ã€‚æœ€ç»ˆå»é™¤tmï¼ŒåŠ ä¸Šæœºæ„åˆ†ç±»ï¼Œå»é™¤è¥åˆ©å’Œéè¥åˆ©
# # æœ€ç»ˆå˜é‡åˆ—è¡¨ï¼ˆå«å¼ºåˆ¶çº³å…¥ + p<0.2ï¼‰
# final_vars <- c("province", "case_type", "diagnosis_quality",
#               "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
#               "doctor_age", "doctor_ethnic", "doctor_female",
#               "ownership_type", "rural_type", "institution_type_houyu",
#               "consultation_time", "total_time",
#               "sp_gender", "sp_age_group"
# )


### å‘ç°èµµåšå®‡è€å¸ˆå»ºè®®çš„ç»“æœï¼Œè·‘å‡ºæ¥ä¹‹åä¸»ä½“ç ”ç©¶å’Œæ•æ„Ÿæ€§åˆ†æç»“æœç›¸å·®å¾ˆå¤§ã€‚æœ€ç»ˆå»é™¤tmï¼Œå»é™¤æœºæ„åˆ†ç±»ï¼Œå»é™¤è¥åˆ©å’Œéè¥åˆ©
final_vars <- c("province", "case_type", "diagnosis_quality",
              "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
              "doctor_age", "doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type",
              "consultation_time", "total_time",
              "sp_gender", "sp_age_group"
)



# æ„å»ºå…¬å¼
formula_multi <- as.formula(
  paste(outcome_var, "~", paste(final_vars, collapse = " + "))
)

# # æ‹Ÿåˆå¤šå…ƒçº¿æ€§å›å½’æ¨¡å‹
# multi_model <- lm(formula_multi, data = formal_data_final_modeimputed_houyu)


### å‘ç°èµµåšå®‡è€å¸ˆå»ºè®®çš„ç»“æœï¼Œè·‘å‡ºæ¥ä¹‹åä¸»ä½“ç ”ç©¶å’Œæ•æ„Ÿæ€§åˆ†æç»“æœç›¸å·®å¾ˆå¤§ã€‚æœ€ç»ˆå»é™¤tmï¼ŒåŠ ä¸Šæœºæ„åˆ†ç±»ï¼Œå»é™¤è¥åˆ©å’Œéè¥åˆ©/ä¸‰è€…å…¨å»é™¤
formal_data_final_modeimputed <- formal_data_final_modeimputed %>%
  mutate(antibiotic_prescribed = as.numeric(as.character(antibiotic_prescribed)))





multi_model <- lm(formula_multi, data = formal_data_final_modeimputed)


# æå–æ¨¡å‹æ‘˜è¦å’Œç½®ä¿¡åŒºé—´
model_summary <- summary(multi_model)

summary(multi_model)


model_ci <- confint(multi_model)

# æ„å»ºç»“æœè¡¨æ ¼ï¼Œä¿ç•™ 6 ä½å°æ•°
multi_results <- data.frame(
  Term = rownames(model_summary$coefficients),
  Coef = round(model_summary$coefficients[, "Estimate"], 6),
  CI_lower = round(model_ci[, 1], 6),
  CI_upper = round(model_ci[, 2], 6),
  P_value = round(model_summary$coefficients[, "Pr(>|t|)"], 6)
)

# å»æ‰æˆªè·å¹¶æŒ‰ P å€¼æ’åº
multi_results <- multi_results %>%
  filter(Term != "(Intercept)") %>%
  arrange(P_value)

# è¾“å‡º
print(multi_results)

# ä¿å­˜ä¸º Excel æ–‡ä»¶ï¼ˆå¸¦æ—¥æœŸï¼‰
output_filename <- paste0("multi_results_houyu-", format(Sys.time(), "%Y-%m-%d"), ".xlsx")
write.xlsx(multi_results, file = output_filename)

# æ¸…ç†å˜é‡ï¼ˆå¯é€‰ï¼‰
rm(output_filename)


print(multi_model)



AIC(multi_model)
BIC(multi_model)





```
æœ€åè¾“å‡ºç»“æœè§`multi_results_houyu-2025-07-20`




1. case_typeå“®å–˜
2. case_typeæ™®é€šæ„Ÿå†’
3. case_typeèƒƒç‚
4. lab_imaging_ratio
5. case_typeå‹åŠ›æ€§å°¿å¤±ç¦
6. diagnosis_qualityé”™è¯¯
7. case_typeç³–å°¿ç—…
8. case_typeé«˜è¡€å‹
9. consultation_time
10. sp_age
11. case_typeè…°èƒŒç—›
12. case_typeå¿ƒç»ç—›
13. diagnosis_qualityéƒ¨åˆ†æ­£ç¡®
14. rural_typerural











### æ„å»ºglmæ¨¡å‹ï¼šåŸå§‹æ•°æ®â€”â€”æ¯”è¿ç»­å‹å˜é‡åŒºåˆ«æ›´å¤§ï¼Œè¿˜æ˜¯å°±ç”¨è¿ç»­å‹å˜é‡å§
#### å…ˆå•å› ç´ å†å¤šå› ç´ 

```{r}


library(car)
library(dplyr)

# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®¾å®šå‚è€ƒæ°´å¹³ï¼ˆå¯é€‰ï¼Œå¦‚ä½ éœ€è¦ï¼‰
formal_data_clean$case_type <- relevel(factor(formal_data_clean$case_type), ref = "åå¤´ç—›")

# æ‰€æœ‰å˜é‡
all_vars <- c( "province", "case_type", "diagnosis_quality",
  "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio",
  "doctor_age", "doctor_ethnic", "doctor_female",
  "ownership_type", "rural_type", "management_type",
  "waiting_time", "consultation_time", "total_time",
  "sp_gender", "sp_age_group", "PPPC")




# å•å› ç´ åˆ†æï¼Œæå–æ¯ä¸ªå˜é‡çš„æ•´ä½“På€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = formal_data_final_modeimputed, family = binomial)
  # ç”¨car::Anovaæå–æ•´ä½“æ£€éªŒçš„på€¼
  p_val <- tryCatch({
    Anova(model, type = "II")$`Pr(>Chisq)`[1]
  }, error = function(e) NA)
  return(p_val)
})

# åˆ›å»ºpå€¼è¡¨æ ¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)
) %>% arrange(P_value)

print(univ_table)

# æå–ORå€¼ã€ç½®ä¿¡åŒºé—´å’ŒPå€¼
or_ci <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = formal_data_final_modeimputed, family = binomial)
  coefs <- coef(summary(model))

  # æå–å…¨éƒ¨éæˆªè·é¡¹çš„ORå’ŒCI
  ci <- suppressMessages(confint(model))
  OR <- exp(coef(model))
  lower <- exp(ci[,1])
  upper <- exp(ci[,2])

  # ç»„ç»‡ä¸ºæ•°æ®æ¡†
  df <- data.frame(
    Variable = var,
    Term = rownames(coefs)[-1],  # å»æ‰æˆªè·
    OR = round(OR[-1], 3),
    CI_lower = round(lower[-1], 3),
    CI_upper = round(upper[-1], 3),
    P_value = round(coefs[-1, 4], 4)
  )
  return(df)
})

# åˆå¹¶æ‰€æœ‰å•å› ç´ ç»“æœ
or_ci_table <- do.call(rbind, or_ci)

# æŒ‰På€¼å‡åºæ’åˆ— OR+CI è¡¨æ ¼
or_ci_table <- or_ci_table %>% arrange(P_value)

print(or_ci_table)







```


åˆ é™¤wait timeå’ŒPPPC



```{r}


# è®¾ç½®å‚è€ƒæ°´å¹³ï¼ˆå¦‚æœéœ€è¦ï¼‰
formal_data_clean$case_type <- relevel(
  factor(formal_data_clean$case_type),
  ref = "åå¤´ç—›"
)

# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# æ‹Ÿåˆå¤šå˜é‡ logistic å›å½’æ¨¡å‹
final_or <- glm(
  antibiotic_prescribed ~
    case_type +
    physical_exam_ratio +
    lab_imaging_ratio +
    sp_gender +
    sp_age +
    diagnosis_quality +
    ownership_type +
    rural_type +
    history_taking_ratio +
    total_time +
    province +
    management_type +
    consultation_time +
    doctor_female,
  data = formal_data_clean,
  family = binomial
)

# æå–æ¨¡å‹æ‘˜è¦
model_summary <- summary(final_or)

# æå– OR å’Œ 95% CIï¼Œå¹¶ä¿ç•™ 3 ä½å°æ•°
or <- round(exp(coef(final_or)), 3)
ci <- round(exp(confint(final_or)), 3)

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•ï¼Œä¿ç•™ 3 ä½å°æ•°
p_values <- format.pval(model_summary$coefficients[, "Pr(>|z|)"], digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœ
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# è¾“å‡ºç»“æœ
print(or_table)






```


lab_imaging_ratio	lab_imaging_ratio	0.310	0.138	0.644	0.003
consultation_time	consultation_time	1.033	1.006	1.062	0.016
case_typeå°å„¿è…¹æ³»	case_typeå°å„¿è…¹æ³»	0.165	0.030	0.876	0.037
diagnosis_qualityé”™è¯¯	diagnosis_qualityé”™è¯¯	1.806	0.995	3.311	0.053




### æ„å»ºä¸­ä»‹æ¨¡å‹ï¼šé—®è¯Šæ—¶é•¿ è¯Šæ–­æ­£ç¡®ç‡ æŠ—ç”Ÿç´ å¤„ç½®æ­£ç¡®ç‡ã€‚
```{r}

# diagnosis_binary: æ­£ç¡®è¯Šæ–­ = 1ï¼Œå…¶å®ƒ = 0
formal_data_final_modeimputed$diagnosis_binary <- ifelse(
  formal_data_final_modeimputed$diagnosis_quality %in% c("å®Œå…¨æ­£ç¡®"),
  1, 0
)


# äºŒå€¼åŒ–ä¸­ä»‹å˜é‡ diagnosis_qualityï¼Œæ­£ç¡®=1ï¼Œå…¶ä½™=0â€”â€”è¿™è¡Œä»£ç å…¶å®æ²¡ç”¨ä¸Š
formal_data_final_modeimputed$diagnosis_quality <- ifelse(
  formal_data_final_modeimputed$diagnosis_quality %in% c("å®Œå…¨æ­£ç¡®", "åŸºæœ¬æ­£ç¡®"), 1, 0
)





library(mediation)



# ä¸­ä»‹æ¨¡å‹ï¼šé—®è¯Šæ—¶é•¿ â†’ è¯Šæ–­æ­£ç¡®æ€§ï¼ˆM ~ Xï¼‰
model.M <- glm(
  diagnosis_binary ~ consultation_time +
    sp_gender + sp_age + province + case_type +
    doctor_female + doctor_age + doctor_ethnic +
    ownership_type + rural_type + management_type,
  family = binomial,
  data = formal_data_final_modeimputed
)

# ç»“æœæ¨¡å‹ï¼šé—®è¯Šæ—¶é•¿ + è¯Šæ–­æ­£ç¡®æ€§ â†’ æŠ—ç”Ÿç´ å¤„ç½®æ˜¯å¦æ­£ç¡®ï¼ˆY ~ X + Mï¼‰
model.Y <- glm(
  antibiotic_prescribed ~ consultation_time + diagnosis_binary +
    sp_gender + sp_age + province + case_type +
    doctor_female + doctor_age + doctor_ethnic +
    ownership_type + rural_type + management_type,
  family = binomial,
  data = formal_data_final_modeimputed
)



set.seed(1234)  # å¯å¤ç°çš„ç»“æœ
med.out <- mediate(
  model.m = model.M,
  model.y = model.Y,
  treat = "consultation_time",     # è‡ªå˜é‡
  mediator = "diagnosis_binary",  # ä¸­ä»‹å˜é‡
  boot = TRUE,
  sims = 1000
)

summary(med.out)


plot(med.out)


# ç”Ÿæˆå¸¦æœ‰å½“å‰æ—¥æœŸçš„æ–‡ä»¶å
output_filename <- paste("med.out-", format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")

# ä¿å­˜Excelæ–‡ä»¶ï¼Œå¹¶åŒ…å«æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶å
write.xlsx(med.out, file = output_filename)

rm(output_filename)






```



```{r}


print_mediation_summary <- function(med.out, digits = 6) {
  cat("===== Causal Mediation Analysis Summary =====\n\n")

  extract_row <- function(name, est, ci, p) {
    est_str <- format(est, digits = digits, nsmall = digits)
    ci_str  <- paste0("[", format(ci[1], digits = digits, nsmall = digits),
                      ", ", format(ci[2], digits = digits, nsmall = digits), "]")
    p_str   <- format(p, digits = digits, nsmall = digits)
    data.frame(Effect = name, Estimate = est_str, `95% CI` = ci_str, `p-value` = p_str)
  }

  result_table <- do.call(rbind, list(
    extract_row("ACME (control)",   med.out$d0,         med.out$d0.ci,         med.out$d0.p),
    extract_row("ACME (treated)",   med.out$d1,         med.out$d1.ci,         med.out$d1.p),
    extract_row("ACME (average)",   med.out$d.avg,      med.out$d.avg.ci,      med.out$d.avg.p),
    extract_row("ADE (control)",    med.out$z0,         med.out$z0.ci,         med.out$z0.p),
    extract_row("ADE (treated)",    med.out$z1,         med.out$z1.ci,         med.out$z1.p),
    extract_row("ADE (average)",    med.out$z.avg,      med.out$z.avg.ci,      med.out$z.avg.p),
    extract_row("Total Effect",     med.out$tau.coef,   med.out$tau.coef.ci,   med.out$tau.p),
    extract_row("Prop. Mediated (control)", med.out$n0, med.out$n0.ci,         med.out$n0.p),
    extract_row("Prop. Mediated (treated)", med.out$n1, med.out$n1.ci,         med.out$n1.p),
    extract_row("Prop. Mediated (average)", med.out$n.avg, med.out$n.avg.ci,   med.out$n.avg.p)
  ))

  print(result_table, row.names = FALSE)
}

# å‡è®¾ä½ çš„ä¸­ä»‹åˆ†æç»“æœå« med.out
print_mediation_summary(med.out)




```


```{r}


## Total Effect æ²¡æœ‰è¾“å‡º95%CIï¼Œä¸‹é¢è‡ªå·±æ„å»º

# æå– bootstrap æ ·æœ¬
acme_samples <- med.out$d.avg.sim
ade_samples <- med.out$z.avg.sim

# é€ä¸€ç›¸åŠ å¾—åˆ° Total Effect çš„ bootstrap æ ·æœ¬
total_effect_samples <- acme_samples + ade_samples

# æ„é€  95% CI
total_effect_ci <- quantile(total_effect_samples, probs = c(0.025, 0.975))

# æ‰“å°ç»“æœ
cat("Total Effect (from mediate):", med.out$tau.coef, "\n")
cat("95% CI: [", total_effect_ci[1], ", ", total_effect_ci[2], "]\n")




```












1. ACMEï¼ˆAverage Causal Mediation Effectï¼‰= -0.000462ï¼Œp = 0.89
è¡¨ç¤ºé€šè¿‡ä¸­ä»‹å˜é‡ diagnosis_correctï¼ˆè¯Šæ–­æ˜¯å¦æ­£ç¡®ï¼‰çš„é—´æ¥æ•ˆåº”éå¸¸å°ä¸”ä¸æ˜¾è‘—ã€‚

å³ï¼šconsultation_time å¯¹ antibiotic_prescribed çš„å½±å“å¹¶ä¸æ˜¯é€šè¿‡â€œè¯Šæ–­æ˜¯å¦æ­£ç¡®â€è¿™ä¸ªè·¯å¾„èµ·ä½œç”¨çš„ã€‚


2. ADEï¼ˆAverage Direct Effectï¼‰= 0.002043ï¼Œp < 0.0000000000000002*
è¡¨ç¤º consultation_time å¯¹ antibiotic_prescribed çš„ç›´æ¥æ•ˆåº”æ˜¾è‘—ä¸ºæ­£ã€‚

å³ï¼šåŒ»ç”Ÿåœ¨è¯Šå®¤åœç•™æ—¶é—´è¶Šé•¿ï¼Œç›´æ¥é™ä½å¤„æ–¹æŠ—ç”Ÿç´ çš„æ¦‚ç‡ï¼ˆå› ä¸ºå› å˜é‡æ˜¯â€œæ˜¯å¦å¼€æŠ—ç”Ÿç´ â€ï¼Œæ•°å€¼è¶Šå°è¡¨ç¤ºè¶Šå°‘å¤„æ–¹æŠ—ç”Ÿç´ ï¼‰ã€‚



3. Total Effectï¼ˆæ€»æ•ˆåº”ï¼‰= 0.001581ï¼Œp = 0.02*
è¡¨æ˜ consultation_time å¯¹ antibiotic_prescribed çš„æ€»æ•ˆåº”ä¹Ÿæ˜¯æ˜¾è‘—çš„ã€‚


4. Proportion Mediatedï¼ˆé—´æ¥è·¯å¾„æ‰€å æ¯”ä¾‹ï¼‰â‰ˆ -29%ï¼Œp = 0.91
è™½ç„¶å€¼æ˜¯è´Ÿçš„ï¼ˆå¯èƒ½å› é—´æ¥æ•ˆåº”æ–¹å‘ç›¸åï¼‰ï¼Œä½†p å€¼éå¸¸ä¸æ˜¾è‘—ã€‚

è¡¨æ˜â€œè¯Šæ–­æ˜¯å¦æ­£ç¡®â€è¿™ä¸€ä¸­ä»‹è·¯å¾„åŸºæœ¬æ²¡æœ‰ä¸­ä»‹ä½œç”¨ã€‚


æœ¬ç ”ç©¶é‡‡ç”¨ éå‚æ•°Bootstrap æ–¹æ³•è¿›è¡Œä¸­ä»‹åˆ†æï¼Œç»“æœæ˜¾ç¤ºï¼Œâ€œè¯Šå®¤æ—¶é—´â€å¯¹â€œä¸åˆç†ä½¿ç”¨æŠ—ç”Ÿç´ â€çš„å½±å“ä¸»è¦é€šè¿‡ç›´æ¥è·¯å¾„äº§ç”Ÿï¼ˆç›´æ¥æ•ˆåº” ADE = 0.0020ï¼Œp < 0.001ï¼‰ï¼Œè€Œéé€šè¿‡â€œè¯Šæ–­æ˜¯å¦æ­£ç¡®â€è¿™ä¸€ä¸­ä»‹å˜é‡ï¼ˆé—´æ¥æ•ˆåº” ACME = -0.00046ï¼Œp = 0.89ï¼‰ã€‚é—´æ¥è·¯å¾„ä¸æ˜¾è‘—ï¼Œè¯´æ˜æé«˜è¯Šæ–­æ­£ç¡®æ€§å¹¶éâ€œè¯Šå®¤æ—¶é—´â€å½±å“å¤„æ–¹è¡Œä¸ºçš„ä¸»è¦æœºåˆ¶ã€‚


å¦‚ä½•æ±‡æŠ¥ï¼š

åœ¨ä¸­ä»‹åˆ†æçš„è®ºæ–‡å†™ä½œä¸­ï¼Œä¸€èˆ¬åªæŠ¥å‘Š averageï¼ˆå¹³å‡ï¼‰å€¼ï¼Œä¸ç”¨æ±‡æŠ¥control/treatedã€‚è¿™æ˜¯å¤§å¤šæ•°åŒ»å­¦ã€å…¬å…±å«ç”Ÿå’Œç¤¾ä¼šç§‘å­¦æœŸåˆŠçš„æƒ¯ä¾‹






### æ„å»ºé“¾å¼ä¸­ä»‹æ¨¡å‹ï¼ˆé™ˆæ±ŸèŠ¸è€å¸ˆæŒ‡å¯¼ï¼‰ï¼šé—®è¯Šæ—¶é•¿ æ£€æŸ¥æƒ…å†µ è¯Šæ–­æ­£ç¡®ç‡ æŠ—ç”Ÿç´ å¤„ç½®æ­£ç¡®ç‡ã€‚
#### history_taking_ratioä½œä¸ºM1
```{r}

library(lavaan)

mediation <- formal_data_final_modeimputed %>%
  select(
    consultation_time,
    antibiotic_prescribed,
    history_taking_ratio,
    physical_exam_ratio,
    lab_imaging_ratio,
    diagnosis_quality,
    diagnosis_binary,
    case_type,
    doctor_female,
    management_type,
    ownership_type,
    province,
    rural_type,
    sp_gender,
    sp_age_group,
    doctor_age,
    doctor_ethnic
  )


write.csv(mediation, "mediation_data.csv", row.names = FALSE)



# å®šä¹‰åå˜é‡åç§°ï¼ˆç”¨äºé‡å¤æ’å…¥ï¼‰
covariates <- "case_type + doctor_female + management_type + ownership_type +
               province + rural_type + sp_gender + sp_age_group + doctor_age + doctor_ethnic"

# æ„å»ºå¸¦åå˜é‡çš„å¤šé‡ä¸­ä»‹æ¨¡å‹
multipleMediation_cov <- paste0('
  antibiotic_prescribed ~ b1*history_taking_ratio + b2*diagnosis_binary + c1*consultation_time + ', covariates, '
  history_taking_ratio ~ a1*consultation_time + ', covariates, '
  diagnosis_binary ~ a2*consultation_time + d1*history_taking_ratio + ', covariates, '

  Indirect1 := a1*b1
  Indirect2 := a2*b2
  secondInd1 := a1*d1*b2
  c := c1 + a1*b1 + a2*b2 + a1*d1*b2
')

# æ‹Ÿåˆæ¨¡å‹
fit_cov <- sem(model = multipleMediation_cov,
               data = mediation,
               se = "bootstrap",
               bootstrap = 1000)

# è¾“å‡ºç»“æœ
summary(fit_cov, ci = TRUE, standardized = TRUE)
inspect(fit_cov, "r2")






```


æ£€éªŒä¸­ä»‹æ¨¡å‹ä¸­çš„ç³»æ•° c'ï¼Œå¦‚æœä¸æ˜¾è‘—,å³ç›´æ¥æ•ˆåº”ä¸æ˜¾è‘—ï¼Œè¯´æ˜åªæœ‰ä¸­ä»‹æ•ˆåº”







#### physical_exam_ratioä½œä¸ºM1
```{r}




library(lavaan) # è½½å…¥lavaanåŒ…



### physical_exam_ratioä½œä¸ºM1ï¼Œdiagnosis_qualityä½œä¸ºM2


multipleMediation <- '
antibiotic_prescribed~b1*physical_exam_ratio+b2*diagnosis_binary+c1*consultation_time
physical_exam_ratio~a1*consultation_time
diagnosis_binary~a2*consultation_time+d1*physical_exam_ratio
Indirect1:=a1*b1
Indirect2:=a2*b2
secondInd1:=a1*d1*b2
c:=c1+a1*b1+a2*b2+a1*d1*b2
'


fit <- sem(model = multipleMediation,data = mediation,se = "bootstrap",bootstrap = 1000)



summary(fit,ci=T)




```


æ£€éªŒä¸­ä»‹æ¨¡å‹ä¸­çš„ç³»æ•° c'ï¼Œå¦‚æœä¸æ˜¾è‘—,å³ç›´æ¥æ•ˆåº”ä¸æ˜¾è‘—ï¼Œè¯´æ˜åªæœ‰ä¸­ä»‹æ•ˆåº”





#### lab_imaging_ratioä½œä¸ºM1
```{r}




library(lavaan) # è½½å…¥lavaanåŒ…



### physical_exam_ratioä½œä¸ºM1ï¼Œdiagnosis_qualityä½œä¸ºM2


multipleMediation <- '
antibiotic_prescribed~b1*lab_imaging_ratio+b2*diagnosis_binary+c1*consultation_time
lab_imaging_ratio~a1*consultation_time
diagnosis_binary~a2*consultation_time+d1*lab_imaging_ratio
Indirect1:=a1*b1
Indirect2:=a2*b2
secondInd1:=a1*d1*b2
c:=c1+a1*b1+a2*b2+a1*d1*b2
'


fit <- sem(model = multipleMediation,data = mediation,se = "bootstrap",bootstrap = 1000)



summary(fit,ci=T)




```


æ£€éªŒä¸­ä»‹æ¨¡å‹ä¸­çš„ç³»æ•° c'ï¼Œå¦‚æœä¸æ˜¾è‘—,å³ç›´æ¥æ•ˆåº”ä¸æ˜¾è‘—ï¼Œè¯´æ˜åªæœ‰ä¸­ä»‹æ•ˆåº”






















### åˆ†ç—…ä¾‹æ„å»ºglmæ¨¡å‹


åå¤´ç—›åªæœ‰ä¸€ä¸ªå–å€¼ï¼šlab_imaging_ratio
äº§åæŠ‘éƒåªæœ‰ä¸€ä¸ªå–å€¼ï¼š"physical_exam_ratioï¼Œlab_imaging_ratio
è…°èƒŒç—›ï¼šsp_gender, lab_imaging_ratio
å“®å–˜ï¼šsp_gender
å¿ƒç»ç—›ï¼šsp_gender
å‹åŠ›æ€§å°¿å¤±ç¦ï¼šsp_gender
é«˜è¡€å‹ï¼šæ— 
ç³–å°¿ç—…ï¼šæ— 


```{r}



library(dplyr)

# æ›¿æ¢ç—…ä¾‹åç§°
case_to_check <- "ç³–å°¿ç—…"

# è¿‡æ»¤è¯¥ç—…ä¾‹æ•°æ®
data_case <- formal_data_final_modeimputed %>%
  filter(case_type == case_to_check)

# æ‹†åˆ†å˜é‡ç±»å‹
is_categorical <- sapply(data_case, function(x) is.factor(x) || is.character(x))
is_continuous <- sapply(data_case, is.numeric)

# ç»Ÿè®¡å”¯ä¸€å€¼ä¸ªæ•°
n_unique <- sapply(data_case, function(x) dplyr::n_distinct(x))

# æ‰¾å‡ºåªæœ‰ä¸€ä¸ªæ°´å¹³çš„åˆ†ç±»å˜é‡
cat_one_level <- names(n_unique[is_categorical & n_unique <= 1])

# æ‰¾å‡ºåªæœ‰ä¸€ä¸ªå–å€¼çš„è¿ç»­å˜é‡
cont_one_value <- names(n_unique[is_continuous & n_unique <= 1])

# è¾“å‡ºç»“æœ
cat("ã€åˆ†ç±»å˜é‡ä¸­ä»…æœ‰ä¸€ä¸ªæ°´å¹³çš„å˜é‡ã€‘ï¼š\n")
print(cat_one_level)

cat("\nã€è¿ç»­å˜é‡ä¸­ä»…æœ‰ä¸€ä¸ªå–å€¼çš„å˜é‡ã€‘ï¼š\n")
print(cont_one_value)





```


firth_model <- logistf(
  antibiotic_prescribed ~ physical_exam_ratio + sp_gender + sp_age +
    consultation_fee + ownership_type +
    diagnosis_quality + history_taking_ratio + rural_type + total_time +
    consultation_time + management_type + examination_fee +
    province + case_type+doctor_female+doctor_age,
  data = migraine_data
)

all_vars <- c("province", "case_type", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type",
              "consultation_fee", "examination_fee", "treatment_fee",
              "total_fee", "waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

#### åå¤´ç—›â€”â€”æ²¡å¼€æŠ—ç”Ÿç´ ï¼Œæ‰€ä»¥æ²¡æ³•åˆ†æ
#### äº§åæŠ‘éƒâ€”â€”æ²¡å¼€æŠ—ç”Ÿç´ ï¼Œæ‰€ä»¥æ²¡æ³•åˆ†æ
#### å°å„¿è…¹æ³»â€”â€”å¼€äº†ï¼Œä½†æ˜¯ä¸æ”¶æ•›ï¼Œæ‰€ä»¥è¦ç”¨Firth æƒ©ç½šé€»è¾‘å›å½’ï¼šå…¨éƒ½æ²¡æœ‰ç»Ÿè®¡å­¦æ•ˆæœ
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}



# 1. è¿‡æ»¤å‡ºäº§åæŠ‘éƒæ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "å°å„¿è…¹æ³»")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type",
              "waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

å°å„¿è…¹æ³»ï¼šPï¼œ0.2
consultation_time	0.0044
total_time	0.0239
history_taking_ratio	0.0344
physical_exam_ratio	0.0602
management_type	0.1188
sp_gender	0.1533



##### Firth æƒ©ç½šé€»è¾‘å›å½’
```{r}



# æ‹Ÿåˆ Firth æƒ©ç½šé€»è¾‘å›å½’æ¨¡å‹
firth_model <- logistf(
  formula = antibiotic_prescribed ~ consultation_time + total_time +
    history_taking_ratio + physical_exam_ratio + management_type +
    doctor_female + doctor_age + doctor_ethnic + sp_gender + sp_age,
  data = migraine_data
)

# æå– ORã€ç½®ä¿¡åŒºé—´å’Œ P å€¼
or <- exp(coef(firth_model))                           # OR
ci <- exp(confint(firth_model))                        # ç½®ä¿¡åŒºé—´
p <- firth_model$prob                                  # P å€¼

# æ•´ç†æˆä¸€ä¸ªæ•°æ®æ¡†
result <- data.frame(
  Variable = names(or),
  OR = round(or, 3),
  CI_lower = round(ci[, 1], 3),
  CI_upper = round(ci[, 2], 3),
  P_value = round(p, 4)
)

# æŒ‰ P å€¼å‡åºæ’åº
result_sorted <- result[order(result$P_value), ]

# æ‰“å°ç»“æœ
print(result_sorted)





```

æ²¡æœ‰ç»Ÿè®¡å­¦æ„ä¹‰


















#### æ™®é€šæ„Ÿå†’â€”â€”å¼€äº†ï¼Œå½±å“å› ç´ ï¼šdiagnosis_qualityé”™è¯¯
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºäº§åæŠ‘éƒæ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "æ™®é€šæ„Ÿå†’")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type",
              "waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


table(migraine_data$treatment_fee)



```

æ™®é€šæ„Ÿå†’ï¼šPï¼œ0.2
management_type	0.0075
ownership_type	0.0454
consultation_time	0.0572
lab_imaging_ratio	0.0581
diagnosis_quality	0.0940






```{r}




firth_model <- glm(
  antibiotic_prescribed ~ management_type+ownership_type+consultation_time+lab_imaging_ratio+diagnosis_quality			+doctor_female+doctor_age+doctor_ethnic+sp_gender+sp_age,
  data = migraine_data,
    family = binomial
)

# æå–æ¨¡å‹æ‘˜è¦
model_summary <- summary(firth_model)

# æå– OR (RR) å’Œ 95% CIï¼Œå¹¶ä¿ç•™3ä½å°æ•°
or <- round(exp(coef(firth_model)), 3)
ci <- round(exp(confint(firth_model)), 3)

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º3ä½å°æ•°
p_values <- format.pval(model_summary$coefficients[, "Pr(>|z|)"], digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœå±•ç¤º
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", p_values))), ]
print(or_table)





```

diagnosis_qualityé”™è¯¯


















#### èƒƒç‚â€”â€”å¼€äº†
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºèƒƒç‚æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "èƒƒç‚")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

èƒƒç‚ï¼šPï¼œ0.2
sp_age	0.0052
sp_gender	0.0101
ownership_type	0.0374
rural_type	0.0491
lab_imaging_ratio	0.1464





```{r}



firth_model <- glm(
  antibiotic_prescribed ~ sp_age+sp_gender+ownership_type+rural_type+lab_imaging_ratio+doctor_female+doctor_age+doctor_ethnic,
  data = migraine_data,
    family = binomial
)

# æå–æ¨¡å‹æ‘˜è¦
model_summary <- summary(firth_model)

# æå– OR (RR) å’Œ 95% CIï¼Œå¹¶ä¿ç•™3ä½å°æ•°
or <- round(exp(coef(firth_model)), 3)
ci <- round(exp(confint(firth_model)), 3)

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º3ä½å°æ•°
p_values <- format.pval(model_summary$coefficients[, "Pr(>|z|)"], digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœå±•ç¤º
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", p_values))), ]
print(or_table)





```

å½±å“å› ç´ ï¼š

1. ownership_typeå…¬ç«‹
1. rural_typerural








#### å“®å–˜â€”â€”å¼€äº†ï¼šdoctor_ethnic2å®Œå…¨åˆ†ç¦»ï¼Œæ‰€ä»¥è¦ç”¨Firth æƒ©ç½šé€»è¾‘å›å½’
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºèƒƒç‚æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "å“®å–˜")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

å“®å–˜ï¼šPï¼œ0.2
lab_imaging_ratio	0.0091
consultation_time	0.0136
rural_type	0.0530
waiting_time	0.0836
ownership_type	0.1711


```{r}



# ä½¿ç”¨ logistf è¿›è¡Œ Firth æƒ©ç½šé€»è¾‘å›å½’
firth_model <- logistf(
  formula = antibiotic_prescribed ~ lab_imaging_ratio + consultation_time +
    rural_type + waiting_time + ownership_type + doctor_female +
    doctor_age + doctor_ethnic + sp_age,
  data = migraine_data,
  pl = TRUE  # å¯ç”¨ç²¾ç¡® profile likelihood CIï¼ˆé»˜è®¤å»ºè®®å¯ç”¨ï¼‰
)

# æå– OR å’Œ CI
or <- round(exp(firth_model$coefficients), 3)
ci <- round(exp(confint(firth_model)), 3)  # logistf è‡ªå¸¦ confint æ–¹æ³•

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º 3 ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœè¡¨æ ¼
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table)





```

å½±å“å› ç´ ï¼š

1. consultation_time
1. lab_imaging_ratio












#### å¿ƒç»ç—›â€”â€”å¼€äº†ï¼šdoctor_ageå®Œå…¨åˆ†ç¦»ï¼Œæ‰€ä»¥è¦ç”¨Firthæƒ©ç½šé€»è¾‘å›å½’
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºå¿ƒç»ç—›æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "å¿ƒç»ç—›")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

å¿ƒç»ç—›ï¼šPï¼œ0.2
total_time	0.0198
waiting_time	0.1194


```{r}




# ä½¿ç”¨ logistf è¿›è¡Œ Firth æƒ©ç½šé€»è¾‘å›å½’
firth_model <- logistf(
  formula = antibiotic_prescribed ~ total_time+waiting_time+doctor_female+doctor_age+doctor_ethnic+sp_age,
  data = migraine_data,
  pl = TRUE  # å¯ç”¨ç²¾ç¡® profile likelihood CIï¼ˆé»˜è®¤å»ºè®®å¯ç”¨ï¼‰
)

# æå– OR å’Œ CI
or <- round(exp(firth_model$coefficients), 3)
ci <- round(exp(confint(firth_model)), 3)  # logistf è‡ªå¸¦ confint æ–¹æ³•

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º 3 ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœè¡¨æ ¼
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table)





```

å½±å“å› ç´ ï¼š

1. total_time
1. doctor_female1










#### è…°èƒŒç—›â€”â€”å¼€äº†ï¼šdoctor_ageï¼Œdoctor_ethnic2å®Œå…¨åˆ†ç¦»ï¼Œæ‰€ä»¥è¦ç”¨Firthæƒ©ç½šé€»è¾‘å›å½’
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}



# 1. è¿‡æ»¤å‡ºå¿ƒç»ç—›æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "è…°èƒŒç—›")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

è…°èƒŒç—›ï¼šPï¼œ0.2
management_type	0.0042
ownership_type	0.0609
history_taking_ratio	0.1425


1. doctor_female
1. doctor_age
1. doctor_ethnic
1. sp_gender
1. sp_age

```{r}



# ä½¿ç”¨ logistf è¿›è¡Œ Firth æƒ©ç½šé€»è¾‘å›å½’
firth_model <- logistf(
  formula = antibiotic_prescribed ~ management_type+ownership_type+history_taking_ratio+doctor_female+doctor_age+doctor_ethnic+sp_age,
  data = migraine_data,
  pl = TRUE  # å¯ç”¨ç²¾ç¡® profile likelihood CIï¼ˆé»˜è®¤å»ºè®®å¯ç”¨ï¼‰
)

# æå– OR å’Œ CI
or <- round(exp(firth_model$coefficients), 3)
ci <- round(exp(confint(firth_model)), 3)  # logistf è‡ªå¸¦ confint æ–¹æ³•

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º 3 ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœè¡¨æ ¼
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table)





```

å½±å“å› ç´ ï¼š

æ— 


















#### å‹åŠ›æ€§å°¿å¤±ç¦â€”â€”å¼€äº†ï¼šæ²¡æœ‰sp_genderã€‚æ²¡æœ‰å½±å“å› ç´ 
##### å…ˆå•å› ç´ å†å¤šå› ç´ â€”â€”å•å› ç´ ä¹Ÿæ²¡æœ‰ç»Ÿè®¡å­¦æ„ä¹‰
```{r}



# 1. è¿‡æ»¤å‡ºå‹åŠ›æ€§å°¿å¤±ç¦æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "å‹åŠ›æ€§å°¿å¤±ç¦")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

å‹åŠ›æ€§å°¿å¤±ç¦ï¼šPï¼œ0.2
æ— 



1. doctor_female
1. doctor_age
1. doctor_ethnic
1. sp_gender
1. sp_age






















#### é«˜è¡€å‹â€”â€”å¼€äº†ï¼šdoctor_age,doctor_ethnicå®Œå…¨åˆ†ç¦»ï¼Œæ‰€ä»¥è¦ç”¨Firthæƒ©ç½šé€»è¾‘å›å½’ã€‚æ²¡æœ‰å½±å“å› ç´ 
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºèƒƒç‚æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "é«˜è¡€å‹")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

é«˜è¡€å‹ï¼šPï¼œ0.2
diagnosis_quality	0.1420
sp_age	0.1716





```{r}



# ä½¿ç”¨ logistf è¿›è¡Œ Firth æƒ©ç½šé€»è¾‘å›å½’
firth_model <- logistf(
  formula = antibiotic_prescribed ~ sp_age+sp_gender+diagnosis_quality+doctor_female+doctor_age+doctor_ethnic,
  data = migraine_data,
  pl = TRUE  # å¯ç”¨ç²¾ç¡® profile likelihood CIï¼ˆé»˜è®¤å»ºè®®å¯ç”¨ï¼‰
)

# æå– OR å’Œ CI
or <- round(exp(firth_model$coefficients), 3)
ci <- round(exp(confint(firth_model)), 3)  # logistf è‡ªå¸¦ confint æ–¹æ³•

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º 3 ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœè¡¨æ ¼
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table)





```

æ²¡æœ‰å½±å“å› ç´ 














#### ç³–å°¿ç—…â€”â€”å¼€äº†ï¼šdoctor_age,doctor_ethnicå®Œå…¨åˆ†ç¦»ï¼Œæ‰€ä»¥è¦ç”¨Firthæƒ©ç½šé€»è¾‘å›å½’ã€‚æ²¡æœ‰å½±å“å› ç´ 
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}


# 1. è¿‡æ»¤å‡ºèƒƒç‚æ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "ç³–å°¿ç—…")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type","waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

ç³–å°¿ç—…ï¼šPï¼œ0.2
sp_age





```{r}




# ä½¿ç”¨ logistf è¿›è¡Œ Firth æƒ©ç½šé€»è¾‘å›å½’
firth_model <- logistf(
  formula = antibiotic_prescribed ~ sp_age+sp_gender+doctor_female+doctor_age+doctor_ethnic,
  data = migraine_data,
  pl = TRUE  # å¯ç”¨ç²¾ç¡® profile likelihood CIï¼ˆé»˜è®¤å»ºè®®å¯ç”¨ï¼‰
)

# æå– OR å’Œ CI
or <- round(exp(firth_model$coefficients), 3)
ci <- round(exp(confint(firth_model)), 3)  # logistf è‡ªå¸¦ confint æ–¹æ³•

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º 3 ä½å°æ•°
p_values <- format.pval(firth_model$prob, digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœè¡¨æ ¼
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", or_table$P_value))), ]

# æ‰“å°ç»“æœ
print(or_table)





```

æ²¡æœ‰å½±å“å› ç´ 
















### åˆ†ç³»ç»Ÿæ„å»ºglmæ¨¡å‹
1. ç¥ç»ç³»ç»Ÿ
åå¤´ç—›ï¼ˆ1ï¼‰ï¼šä¸å¤§è„‘ç¥ç»å’Œè¡€ç®¡åŠŸèƒ½å¼‚å¸¸ç›¸å…³ã€‚

äº§åæŠ‘éƒï¼ˆ2ï¼‰ï¼šå±äºç²¾ç¥å¿ƒç†éšœç¢ï¼Œä¸ç¥ç»é€’è´¨å¤±è¡¡æœ‰å…³ã€‚

2. æ¶ˆåŒ–ç³»ç»Ÿ
â¼©â¼‰è…¹æ³»ï¼ˆ3ï¼‰ï¼šé€šå¸¸ç”±è‚ é“æ„ŸæŸ“æˆ–æ¶ˆåŒ–åŠŸèƒ½ç´Šä¹±å¼•èµ·ã€‚

èƒƒç‚ï¼ˆ6ï¼‰ï¼šèƒƒé»è†œçš„ç‚ç—‡ï¼Œå±äºæ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…ã€‚

3. å‘¼å¸ç³»ç»Ÿ
æ™®é€šæ„Ÿå†’ï¼ˆ4ï¼‰ï¼šä¸Šå‘¼å¸é“æ„ŸæŸ“ï¼ˆé¼»ã€å’½ã€å–‰ï¼‰ã€‚

å“®å–˜ï¼ˆ7ï¼‰ï¼šæ…¢æ€§æ°”é“ç‚ç—‡æ€§ç–¾ç—…ã€‚

4. å¾ªç¯ç³»ç»Ÿï¼ˆå¿ƒè¡€ç®¡ç³»ç»Ÿï¼‰
â¼¼ç»ç—›ï¼ˆ8ï¼‰ï¼šå† çŠ¶åŠ¨è„‰ä¾›è¡€ä¸è¶³å¯¼è‡´çš„å¿ƒè„ç—…ã€‚

â¾¼â¾å‹ï¼ˆ11ï¼‰ï¼šæ¶‰åŠè¡€ç®¡å‹åŠ›å¼‚å¸¸ï¼Œå±äºå¿ƒè¡€ç®¡ç–¾ç—…ã€‚

5. å†…åˆ†æ³Œç³»ç»Ÿ
ç³–å°¿ç—…ï¼ˆ12ï¼‰ï¼šèƒ°å²›ç´ åˆ†æ³Œæˆ–ä½œç”¨å¼‚å¸¸å¯¼è‡´çš„ä»£è°¢æ€§ç–¾ç—…ã€‚

6. æ³Œå°¿ç³»ç»Ÿ
å‹â¼’æ€§å°¿å¤±ç¦ï¼ˆ10ï¼‰ï¼šä¸è†€èƒ±å’Œå°¿é“æ§åˆ¶åŠŸèƒ½å¼‚å¸¸ç›¸å…³ã€‚

7. è¿åŠ¨ç³»ç»Ÿï¼ˆè‚Œè‚‰éª¨éª¼ç³»ç»Ÿï¼‰
è…°èƒŒç—›ï¼ˆ9ï¼‰ï¼šå¯èƒ½ç”±è‚Œè‚‰ã€éª¨éª¼æˆ–ç¥ç»é—®é¢˜å¼•èµ·ï¼Œå¦‚è…°æ¤é—´ç›˜çªå‡ºã€è‚Œè‚‰æ‹‰ä¼¤ç­‰ã€‚


#### ç¥ç»ç³»ç»Ÿâ€”â€”åå¤´ç—›+äº§åæŠ‘éƒ
##### å…ˆå•å› ç´ å†å¤šå› ç´ 
```{r}

# 1. è¿‡æ»¤å‡ºäº§åæŠ‘éƒæ•°æ®
migraine_data <- formal_data_final_modeimputed %>%
  filter(case_type == "å°å„¿è…¹æ³»")


# å…ˆå•å› ç´ å†å¤šå› ç´ 
# ç¦ç”¨ç§‘å­¦è®¡æ•°æ³•
options(scipen = 999)

# è®°å½•æ‰€æœ‰å˜é‡åç§°
all_vars <- c("province", "diagnosis_quality", "history_taking_ratio", "physical_exam_ratio", "lab_imaging_ratio", "doctor_age","doctor_ethnic", "doctor_female",
              "ownership_type", "rural_type", "management_type",
              "consultation_fee", "total_fee", "waiting_time", "consultation_time",
              "total_time", "sp_gender","sp_age")

# æ‰§è¡Œå•å› ç´ GLMå¹¶æå–på€¼
univ_results <- lapply(all_vars, function(var) {
  formula_uni <- as.formula(paste("antibiotic_prescribed ~", var))
  model <- glm(formula_uni, data = migraine_data, family = binomial)
  p_val <- summary(model)$coefficients[2, 4]
  return(p_val)
})

# åˆ›å»ºæ±‡æ€»è¡¨å¹¶æ ¼å¼åŒ–på€¼
univ_table <- data.frame(
  Variable = all_vars,
  P_value = round(unlist(univ_results), 4)  # ä¿ç•™å››ä½å°æ•°
)

# ï¼ˆå¯é€‰ï¼‰æŒ‰På€¼å‡åºæ’åˆ—
univ_table <- univ_table %>% arrange(P_value)

# æ‰“å°ç»“æœ
print(univ_table)


```

å°å„¿è…¹æ³»ï¼šPï¼œ0.2
consultation_time	0.0044
total_fee	0.0048
total_time	0.0239
history_taking_ratio	0.0344
physical_exam_ratio	0.0602
management_type	0.1188
sp_gender	0.1533






```{r}



firth_model <- glm(
  antibiotic_prescribed ~ consultation_time + total_fee + total_time + history_taking_ratio+physical_exam_ratio+management_type+sp_gender,
  data = migraine_data,
    family = binomial
)

# æå–æ¨¡å‹æ‘˜è¦
model_summary <- summary(firth_model)

# æå– OR (RR) å’Œ 95% CIï¼Œå¹¶ä¿ç•™3ä½å°æ•°
or <- round(exp(coef(firth_model)), 3)
ci <- round(exp(confint(firth_model)), 3)

# æå– P å€¼ï¼Œç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º3ä½å°æ•°
p_values <- format.pval(model_summary$coefficients[, "Pr(>|z|)"], digits = 3, eps = 0.001)

# åˆå¹¶ç»“æœå±•ç¤º
or_table <- data.frame(
  Variable = names(or),
  OR = or,
  CI_lower = ci[, 1],
  CI_upper = ci[, 2],
  P_value = p_values,
  stringsAsFactors = FALSE
)

# æŒ‰ P å€¼æ’åº
or_table <- or_table[order(as.numeric(gsub("<", "", p_values))), ]
print(or_table)




```




antibotic_treatments_by_cases.xlsx







## æŠ—ç”Ÿç´ åˆ†å¸ƒ
### å¯¼å…¥æŠ—èŒè¯ç‰©åˆ†å¸ƒçš„æ•°æ®
```{r}

library(readxl)
library(dplyr)

# è¯»å– Excel ä¸­çš„ record_idï¼ˆå‡è®¾åªæœ‰ä¸€ä¸ª sheetï¼‰
excel_data <- read_excel("antibotic_treatments_by_cases-2025-05-14.xlsx", sheet = "all")
excel_ids <- unique(excel_data$record_id)

# è¯»å– formal_data_final_modeimputed ä¸­çš„ record_id
data_ids <- unique(formal_data_final_modeimputed$record_id)

# æ¯”è¾ƒå·®å¼‚
only_in_excel <- setdiff(excel_ids, data_ids)
only_in_data <- setdiff(data_ids, excel_ids)

# è¾“å‡ºç»“æœ
cat("åªåœ¨ Excel ä¸­çš„ record_id æ•°é‡ï¼š", length(only_in_excel), "\n")
print(only_in_excel)

cat("åªåœ¨æ•°æ®æ¡† formal_data_final_modeimputed ä¸­çš„ record_id æ•°é‡ï¼š", length(only_in_data), "\n")
print(only_in_data)





```





### æ•´ä½“å¤„æ–¹ç‡

1. `formal_data_clean` æ˜¯åŸºç¡€æ•°æ®ï¼›

1. `formal_data_final_modeimputed` æ˜¯åœ¨åŸºç¡€æ•°æ®ä¸Šè¿›è¡Œå¤šé‡æ’è¡¥çš„æ•°æ®ï¼›

1. `excel_data` æ˜¯å¯¼å…¥æŠ—èŒè¯ç‰©åˆ†å¸ƒçš„æ•°æ®


```{r}
# å¯¼å…¥æ•°æ®

prescription_rate_data <- formal_data_clean %>%
  left_join(excel_data, by = "record_id")


colnames(prescription_rate_data)

table(prescription_rate_data$antibiotic_prescribed)






```





#### å…¨æ ·æœ¬å¤„æ–¹ç‡
```{r}

prescription_rate_data %>%
  summarise(prescription_rate = mean(antibiotic_prescribed == "1", na.rm = TRUE)) %>%
  kable(digits = 3, caption = "è¡¨1ï¼šå…¨æ ·æœ¬æŠ—ç”Ÿç´ å¤„æ–¹ç‡") %>%
  kable_styling(full_width = FALSE)




```





#### Table 2. Characteristics of Antibiotic Prescribing Across 11 Conditions in Primary Healthcare Facilities in China
```{r}

library(dplyr)
library(tidyr)
library(openxlsx)

# æ‰€æœ‰ç—…ä¾‹ç±»å‹
all_case_types <- c(
  "åå¤´ç—›", "å‹åŠ›æ€§å°¿å¤±ç¦", "å“®å–˜", "å°å„¿è…¹æ³»", "å¿ƒç»ç—›",
  "æ™®é€šæ„Ÿå†’", "ç³–å°¿ç—…", "èƒƒç‚", "è…°èƒŒç—›", "é«˜è¡€å‹", "äº§åæŠ‘éƒ"
)

# æ·»åŠ SPå¹´é¾„åˆ†ç»„
prescription_rate_data <- prescription_rate_data %>%
  mutate(sp_age_group = case_when(
    sp_age < 30 ~ "<30å²",
    sp_age >= 30 & sp_age < 50 ~ "30-49å²",
    sp_age >= 50 ~ "â‰¥50å²",
    TRUE ~ NA_character_
  ))

# åˆ†ç»„å˜é‡åˆ—è¡¨
group_vars <- list(
  "çœä»½" = "province",
  "åŸä¹¡ç±»å‹" = "rural_type",
  "å…¬ç§ç«‹" = "management_type",
  "åŒ»ç”Ÿå¹´é¾„" = "doctor_age",
  "åŒ»ç”Ÿæ€§åˆ«" = "doctor_female",
  "SPæ€§åˆ«" = "sp_gender",
  "SPå¹´é¾„" = "sp_age_group"
)

results_list <- list()

# æ€»ä½“æ ·æœ¬æ•°
total_n <- prescription_rate_data %>%
  filter(!is.na(antibiotic_prescribed)) %>%
  nrow()

abx_n <- prescription_rate_data %>%
  filter(antibiotic_prescribed == 1) %>%
  nrow()

# æ¯ç§ç—…ä¾‹ç±»å‹æ€»è®¿é—®å’ŒæŠ—ç”Ÿç´ å¼€å…·æ•°ï¼ˆç”¨äºå‰ä¸¤è¡Œï¼‰
overall_visit_row <- prescription_rate_data %>%
  filter(!is.na(antibiotic_prescribed)) %>%
  group_by(case_type) %>%
  summarise(n = n(), .groups = "drop") %>%
  complete(case_type = all_case_types, fill = list(n = 0)) %>%
  mutate(
    ç‰¹å¾ç±»å‹ = "æ€»ä½“æ±‡æ€»",
    ç‰¹å¾åç§° = "Overall Visit"
  ) %>%
  pivot_wider(names_from = case_type, values_from = n, values_fill = 0)

overall_abx_row <- prescription_rate_data %>%
  filter(!is.na(antibiotic_prescribed)) %>%
  group_by(case_type) %>%
  summarise(abx_n = sum(antibiotic_prescribed == 1), .groups = "drop") %>%
  complete(case_type = all_case_types, fill = list(abx_n = 0)) %>%
  left_join(
    prescription_rate_data %>%
      filter(!is.na(antibiotic_prescribed)) %>%
      group_by(case_type) %>%
      summarise(total_n = n(), .groups = "drop"),
    by = "case_type"
  ) %>%
  mutate(
    n = paste0(abx_n, " (", ifelse(total_n == 0, "NA", sprintf("%.2f", abx_n / total_n * 100)), "%)"),
    ç‰¹å¾ç±»å‹ = "æ€»ä½“æ±‡æ€»",
    ç‰¹å¾åç§° = "Overall Antibiotics"
  ) %>%
  dplyr::select(-abx_n, -total_n) %>%
  pivot_wider(names_from = case_type, values_from = n, values_fill = "0 (0.00%)")

# è®¡ç®—æ¯ç§ç—…ä¾‹ä¸‹å¼€æŠ—ç”Ÿç´ æ¯”ä¾‹
case_totals <- prescription_rate_data %>%
  filter(!is.na(antibiotic_prescribed)) %>%
  group_by(case_type) %>%
  summarise(
    total_n = n(),
    abx_n = sum(antibiotic_prescribed == 1),
    .groups = "drop"
  ) %>%
  complete(case_type = all_case_types, fill = list(total_n = 0, abx_n = 0))

case_cols_total <- case_totals %>%
  mutate(
    text = paste0(abx_n, " (", ifelse(total_n == 0, "NA", sprintf("%.2f", abx_n / total_n * 100)), "%)")
  ) %>%
  dplyr::select(case_type, text) %>%
  deframe()

total_summary <- tibble(
  ç‰¹å¾ç±»å‹ = "æ€»ä½“æ±‡æ€»",
  ç‰¹å¾åç§° = "å…¨éƒ¨æ ·æœ¬",
  æ€»æ ·æœ¬æ•° = paste0(total_n, " (100%)"),
  å¼€æŠ—ç”Ÿç´ æ•° = paste0(abx_n, " (", sprintf("%.2f", abx_n / total_n * 100), "%)")
)

for (case_name in names(case_cols_total)) {
  total_summary[[case_name]] <- case_cols_total[[case_name]]
}

# ç»Ÿä¸€ç©ºå­—æ®µåˆ—
fill_cols <- setdiff(names(total_summary), c("ç‰¹å¾ç±»å‹", "ç‰¹å¾åç§°"))
for (col in fill_cols) {
  if (!col %in% names(overall_visit_row)) {
    overall_visit_row[[col]] <- ""
    overall_abx_row[[col]] <- ""
  }
}

# å°†ç—…ä¾‹åˆ—ç»Ÿä¸€è½¬æ¢ä¸ºå­—ç¬¦å‹ï¼ˆcharacterï¼‰
cols_to_fix <- intersect(names(overall_visit_row), names(total_summary))
overall_visit_row[cols_to_fix] <- lapply(overall_visit_row[cols_to_fix], as.character)
overall_abx_row[cols_to_fix] <- lapply(overall_abx_row[cols_to_fix], as.character)

# åŠ å…¥æ€»ä½“æ±‡æ€»å‰ä¸¤è¡Œ
summary_block <- bind_rows(overall_visit_row, overall_abx_row, total_summary)

# å„å­ç»„åˆ†æ
for (group_label in names(group_vars)) {
  var <- group_vars[[group_label]]

  chisq_result <- tryCatch({
    tbl <- table(prescription_rate_data[[var]], prescription_rate_data$antibiotic_prescribed)
    expected <- suppressWarnings(chisq.test(tbl)$expected)
    if (all(expected >= 1) && mean(expected >= 5) >= 0.8) {
      test <- chisq.test(tbl)
      list(p = test$p.value, method = "Chi-squared", statistic = round(test$statistic, 2))
    } else {
      test <- fisher.test(tbl)
      list(p = test$p.value, method = "Fisher", statistic = if (!is.null(test$estimate)) round(test$estimate, 2) else NA)
    }
  }, error = function(e) list(p = NA, method = "Error", statistic = NA))

  sig_label <- case_when(
    is.na(chisq_result$p) ~ "",
    chisq_result$p < 0.001 ~ "***",
    chisq_result$p < 0.01 ~ "**",
    chisq_result$p < 0.05 ~ "*",
    TRUE ~ ""
  )

  formatted_p <- if (!is.na(chisq_result$p)) formatC(chisq_result$p, format = "f", digits = 4) else NA

  total_df <- prescription_rate_data %>%
    filter(!is.na(antibiotic_prescribed), !is.na(.data[[var]])) %>%
    group_by(group = as.character(.data[[var]])) %>%
    summarise(
      total_n = n(),
      abx_n = sum(antibiotic_prescribed == 1),
      .groups = "drop"
    )

  case_df <- prescription_rate_data %>%
    filter(!is.na(antibiotic_prescribed), !is.na(.data[[var]])) %>%
    group_by(group = as.character(.data[[var]]), case_type) %>%
    summarise(
      case_total = n(),
      abx_n = sum(antibiotic_prescribed == 1),
      .groups = "drop"
    ) %>%
    complete(group, case_type = all_case_types, fill = list(case_total = 0, abx_n = 0)) %>%
    mutate(
      cell = paste0(abx_n, " (", ifelse(case_total == 0, "NA", sprintf("%.2f", abx_n / case_total * 100)), "%)")
    ) %>%
    dplyr::select(group, case_type, cell) %>%
    pivot_wider(names_from = case_type, values_from = cell, values_fill = "0 (0.00%)")

  combined <- total_df %>%
    left_join(case_df, by = "group") %>%
    mutate(
      æ€»æ ·æœ¬æ•° = paste0(total_n, " (100%)"),
      å¼€æŠ—ç”Ÿç´ æ•° = paste0(abx_n, " (", sprintf("%.2f", abx_n / total_n * 100), "%)")
    )

  combined <- combined %>%
    dplyr::select(-total_n, -abx_n) %>%
    mutate(
      ç‰¹å¾ç±»å‹ = group_label,
      på€¼ = formatted_p,
      æ˜¾è‘—æ€§ = sig_label,
      æ£€éªŒæ–¹æ³• = chisq_result$method,
      ç»Ÿè®¡å€¼ = chisq_result$statistic
    ) %>%
    rename(ç‰¹å¾åç§° = group) %>%
    dplyr::select(ç‰¹å¾ç±»å‹, ç‰¹å¾åç§°, everything())

  results_list[[group_label]] <- combined
}

# åˆå¹¶æ‰€æœ‰
final_table <- bind_rows(results_list)
final_table_with_total <- bind_rows(summary_block, final_table)

# ä¿å­˜æ–‡ä»¶
output_filename_csv <- paste0("æŠ—ç”Ÿç´ å¤„æ–¹ç»Ÿè®¡è¡¨-", format(Sys.Date(), "%Y%m%d"), ".csv")
write.csv(final_table_with_total, file = output_filename_csv, row.names = FALSE)

cat("âœ… å¯¼å‡ºå®Œæˆï¼Œæ–‡ä»¶åä¸ºï¼š", output_filename_csv, "\n")




```

æ³¨æ„è¾“å‡ºçš„è¡¨ï¼Œdoctor_female1å’Œdoctor_ageæ˜¯æœ‰ç¼ºå¤±å€¼çš„ï¼Œç¼º4ä¸ª





```{r}

library(dplyr)
library(tidyr)
library(openxlsx)

# æ‰€æœ‰ç—…ä¾‹ç±»å‹
all_case_types <- c(
  "åå¤´ç—›", "å‹åŠ›æ€§å°¿å¤±ç¦", "å“®å–˜", "å°å„¿è…¹æ³»", "å¿ƒç»ç—›",
  "æ™®é€šæ„Ÿå†’", "ç³–å°¿ç—…", "èƒƒç‚", "è…°èƒŒç—›", "é«˜è¡€å‹", "äº§åæŠ‘éƒ"
)

# æ·»åŠ  SP å¹´é¾„åˆ†ç»„
prescription_rate_data <- prescription_rate_data %>%
  mutate(sp_age_group = case_when(
    sp_age < 30 ~ "<30å²",
    sp_age >= 30 & sp_age < 50 ~ "30-49å²",
    sp_age >= 50 ~ "â‰¥50å²",
    TRUE ~ NA_character_
  ))

# åˆ†ç»„å˜é‡åˆ—è¡¨
group_vars <- list(
  "çœä»½" = "province",
  "åŸä¹¡ç±»å‹" = "rural_type",
  "å…¬ç§ç«‹" = "management_type",
  "åŒ»ç”Ÿå¹´é¾„" = "doctor_age",
  "åŒ»ç”Ÿæ€§åˆ«" = "doctor_female",
  "SPæ€§åˆ«" = "sp_gender",
  "SPå¹´é¾„" = "sp_age_group"
)

results_list <- list()

# æ€»ä½“æ ·æœ¬æ•°ä¸æŠ—ç”Ÿç´ å¤„æ–¹æ•°
total_n <- prescription_rate_data %>%
  filter(!is.na(antibiotic_prescribed)) %>% nrow()

abx_n <- prescription_rate_data %>%
  filter(antibiotic_prescribed == 1) %>% nrow()

# æ¯ç§ç—…ä¾‹çš„è®¿é—®æ•°ï¼ˆåˆ†æ¯ï¼‰
case_visits <- prescription_rate_data %>%
  group_by(case_type) %>%
  summarise(visit_n = n(), .groups = "drop") %>%
  complete(case_type = all_case_types, fill = list(visit_n = 0))

# æ¯ç§ç—…ä¾‹çš„æŠ—ç”Ÿç´ å¤„æ–¹æ•°ï¼ˆåˆ†å­ï¼‰
case_abx <- prescription_rate_data %>%
  filter(antibiotic_prescribed == 1) %>%
  group_by(case_type) %>%
  summarise(abx_n = n(), .groups = "drop") %>%
  complete(case_type = all_case_types, fill = list(abx_n = 0))

# è®¡ç®—æŠ—ç”Ÿç´ å¤„æ–¹æ¯”ä¾‹
case_summary <- left_join(case_abx, case_visits, by = "case_type") %>%
  mutate(
    abx_text = ifelse(visit_n == 0, "0 (0%)",
                      paste0(abx_n, " (", round(abx_n / visit_n * 100, 1), "%)")),
    visit_text = paste0(visit_n, " (", round(visit_n / total_n * 100, 1), "%)")
  )

# æ„å»º Overall Summary è¡Œ
total_summary <- tibble(
  ç‰¹å¾ç±»å‹ = "æ€»ä½“æ±‡æ€»",
  ç‰¹å¾åç§° = "å…¨éƒ¨æ ·æœ¬",
  æ€»æ ·æœ¬æ•° = paste0(total_n, " (100%)"),
  å¼€æŠ—ç”Ÿç´ æ•° = paste0(abx_n, " (", round(abx_n / total_n * 100, 1), "%)")
)
for (i in seq_along(all_case_types)) {
  total_summary[[all_case_types[i]]] <- case_summary$abx_text[i]
}

# æ„å»º Over Visit è¡Œ
visit_summary <- tibble(
  ç‰¹å¾ç±»å‹ = "è®¿é—®æ¬¡æ•°",
  ç‰¹å¾åç§° = "å…¨éƒ¨æ ·æœ¬",
  æ€»æ ·æœ¬æ•° = paste0(total_n, " (100%)"),
  å¼€æŠ—ç”Ÿç´ æ•° = ""  # ä¸æ˜¾ç¤ºè¿™åˆ—
)
for (i in seq_along(all_case_types)) {
  visit_summary[[all_case_types[i]]] <- case_summary$visit_text[i]
}

# ç»„åˆæˆé¡¶éƒ¨ä¸¤è¡Œ
header_summary <- bind_rows(total_summary, visit_summary)

# ä¸»å¾ªç¯ï¼šæ¯ä¸ªç‰¹å¾å˜é‡
for (group_label in names(group_vars)) {
  var <- group_vars[[group_label]]

  chisq_result <- tryCatch({
    tbl <- table(prescription_rate_data[[var]], prescription_rate_data$antibiotic_prescribed)
    expected <- suppressWarnings(chisq.test(tbl)$expected)

    if (all(expected >= 1) && mean(expected >= 5) >= 0.8) {
      test <- chisq.test(tbl)
      list(p = test$p.value, method = "Chi-squared", statistic = round(as.numeric(test$statistic), 2))
    } else {
      test <- fisher.test(tbl)
      list(p = test$p.value, method = "Fisher", statistic = if (!is.null(test$estimate)) round(as.numeric(test$estimate), 2) else NA)
    }
  }, error = function(e) list(p = NA, method = "Error", statistic = NA))

  sig_label <- case_when(
    is.na(chisq_result$p) ~ "",
    chisq_result$p < 0.001 ~ "***",
    chisq_result$p < 0.01 ~ "**",
    chisq_result$p < 0.05 ~ "*",
    TRUE ~ ""
  )
  formatted_p <- if (!is.na(chisq_result$p)) formatC(chisq_result$p, format = "f", digits = 4) else NA

  total_df <- prescription_rate_data %>%
    filter(!is.na(antibiotic_prescribed), !is.na(.data[[var]])) %>%
    group_by(group = as.character(.data[[var]])) %>%
    summarise(
      total_n = n(),
      abx_n = sum(antibiotic_prescribed == 1),
      .groups = "drop"
    )

  case_df <- prescription_rate_data %>%
    filter(!is.na(antibiotic_prescribed), antibiotic_prescribed == 1, !is.na(.data[[var]])) %>%
    group_by(group = as.character(.data[[var]]), case_type) %>%
    summarise(n = n(), .groups = "drop") %>%
    complete(group, case_type = all_case_types, fill = list(n = 0)) %>%
    pivot_wider(names_from = case_type, values_from = n, values_fill = 0)

  combined <- total_df %>%
    left_join(case_df, by = "group") %>%
    mutate(
      æ€»æ ·æœ¬æ•° = paste0(total_n, " (100%)"),
      å¼€æŠ—ç”Ÿç´ æ•° = paste0(abx_n, " (", round(abx_n / total_n * 100, 1), "%)")
    )

  case_cols <- setdiff(names(combined), c("group", "total_n", "abx_n", "æ€»æ ·æœ¬æ•°", "å¼€æŠ—ç”Ÿç´ æ•°"))
  for (col in case_cols) {
    combined[[col]] <- paste0(
      combined[[col]], " (",
      round(as.numeric(combined[[col]]) / combined$total_n * 100, 1), "%)"
    )
  }

  combined <- combined %>%
    dplyr::select(-total_n, -abx_n) %>%
    mutate(
      ç‰¹å¾ç±»å‹ = group_label,
      på€¼ = formatted_p,
      æ˜¾è‘—æ€§ = sig_label,
      æ£€éªŒæ–¹æ³• = chisq_result$method,
      ç»Ÿè®¡å€¼ = chisq_result$statistic
    ) %>%
    rename(ç‰¹å¾åç§° = group) %>%
    dplyr::select(ç‰¹å¾ç±»å‹, ç‰¹å¾åç§°, dplyr::everything())

  results_list[[group_label]] <- combined
}

# æœ€ç»ˆåˆå¹¶æ‰€æœ‰ç»“æœ
final_table <- bind_rows(results_list)
final_table_all <- bind_rows(header_summary, final_table)

# è¾“å‡ºæ–‡ä»¶å
output_filename_csv <- paste0("æŠ—ç”Ÿç´ å¤„æ–¹ç»Ÿè®¡è¡¨0623-", format(Sys.Date(), "%Y%m%d"), ".csv")
write.csv(final_table_all, file = output_filename_csv, row.names = FALSE)

cat("âœ… å¯¼å‡ºå®Œæˆï¼Œæ–‡ä»¶åä¸ºï¼š", output_filename_csv, "\n")




```


```{r}

library(dplyr)

case_visits <- tmp %>%
  count(case_name, name = "è®¿é—®æ¬¡æ•°") %>%
  arrange(desc(è®¿é—®æ¬¡æ•°))

print(case_visits)



```














##### æŒ‰çœä»½/æœºæ„ç±»å‹åˆ†å±‚çš„ç¼ºå¤±å€¼
```{r}

# æ‰¾å‡ºprovinceã€rural_type æˆ– management_type ç¼ºå¤±çš„è®°å½•
library(dplyr)

missing_info <- prescription_rate_data %>%
  filter(is.na(province) | is.na(rural_type) | is.na(management_type)) %>%
  dplyr::select(record_id, province, rural_type, management_type, antibiotic_prescribed)


# æ‰“å°ç»“æœ
print(missing_info)







```









### åŸºäºç–¾ç—…çš„å¤„æ–¹ç‡

```{r}

prescription_rate_data %>%
  group_by(case_type) %>%
  summarise(
    n = n(),
    prescription_rate = mean(antibiotic_prescribed == "1", na.rm = TRUE)
  ) %>%
  arrange(desc(prescription_rate)) %>%
  kable(digits = 3, caption = "è¡¨4ï¼šæŒ‰ç–¾ç—…ç±»å‹åˆ†å±‚æŠ—ç”Ÿç´ å¤„æ–¹ç‡") %>%
  kable_styling(full_width = FALSE)



```







### å¤„æ–¹çš„æŠ—èŒè¯ç‰©åˆ†å¸ƒ
#### åŸºè¯ç›®å½•
```{r}


abx_1 <- prescription_rate_data %>%
  filter(!is.na(antibiotic_1)) %>%
  transmute(record_id = record_id, essential = as.character(essential_medicine_1))

abx_2 <- prescription_rate_data %>%
  filter(!is.na(antibiotic_2)) %>%
  transmute(record_id = record_id, essential = as.character(essential_medicine_2))

abx_all <- bind_rows(abx_1, abx_2)

# è¾“å‡ºåˆ†å¸ƒè¡¨
abx_all %>%
  group_by(essential) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count)) %>%
  kable(digits = 3, caption = "è¡¨5aï¼šæŠ—èŒè¯ç‰©åŸºè¯ç›®å½•åˆ†å¸ƒ") %>%
  kable_styling(full_width = FALSE)







```

ä¸¤ä¸ªæ˜¯NAï¼Œå› ä¸ºè¯å“åç§°åªæ˜¯è®°å½•ä¸ºå¤´å­¢ï¼Œæ²¡æ³•åˆ¤æ–­å…·ä½“æ˜¯å“ªä¸ªè¯å“ï¼Œæ‰€ä»¥åŸºè¯è®¾ç½®ä¸º`NA`ã€‚










#### AWaRe åˆ†ç±»åˆ†å¸ƒ
```{r}

library(dplyr)
library(knitr)
library(kableExtra)
library(stringr)

abx_1 <- prescription_rate_data %>%
  filter(!is.na(antibiotic_1)) %>%
  transmute(AWaRe = AWaRe_1)

abx_2 <- prescription_rate_data %>%
  filter(!is.na(antibiotic_2)) %>%
  transmute(AWaRe = AWaRe_2)

abx_all <- bind_rows(abx_1, abx_2)

abx_all %>%
  mutate(AWaRe = str_to_title(AWaRe)) %>%  # ç»Ÿä¸€æˆ Access/Watch/Reserve
  group_by(AWaRe) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count)) %>%
  kable(digits = 3, caption = "è¡¨5bï¼šæŠ—èŒè¯ç‰©AWaReç›®å½•åˆ†å¸ƒ") %>%
  kable_styling(full_width = FALSE)




# åˆå¹¶ antibiotic_1 å’Œ antibiotic_2 çš„ AWaRe åˆ†ç±»åŠ record_id
abx_cleaned <- prescription_rate_data %>%
  dplyr::select(record_id, AWaRe_1, AWaRe_2) %>%
  pivot_longer(cols = c(AWaRe_1, AWaRe_2), names_to = "source", values_to = "AWaRe_raw") %>%
  filter(!is.na(AWaRe_raw)) %>%
  mutate(
    AWaRe_clean = case_when(
      str_to_lower(AWaRe_raw) %in% c("access", "acess") ~ "Access",
      str_to_lower(AWaRe_raw) %in% c("watch", "wacth") ~ "Watch",
      str_to_lower(AWaRe_raw) == "reserve" ~ "Reserve",
      TRUE ~ "Other"
    )
  )

# æŸ¥çœ‹æ¸…æ´—åçš„ç»“æœ
abx_cleaned %>%
  head()






```

ä¸¤ä¸ªæ˜¯NAï¼Œå› ä¸ºè¯å“åç§°åªæ˜¯è®°å½•ä¸ºå¤´å­¢ï¼Œæ²¡æ³•åˆ¤æ–­å…·ä½“æ˜¯å“ªä¸ªè¯å“ï¼Œæ‰€ä»¥åŸºè¯è®¾ç½®ä¸º`NA`ã€‚





#### Table 3 AWareåˆ†ç±»
```{r}

library(dplyr)
library(stringr)
library(tidyr)
library(openxlsx)

# å‡½æ•°ï¼šè®¡ç®—æ¯ä¸ªcaseçš„AWaReåˆ†ç±»é¢‘æ•°ä¸æ¯”ä¾‹
summarise_aware_by_case <- function(data) {
  data_clean <- data %>%
    mutate(
      AWaRe_1 = str_to_title(AWaRe_1),
      AWaRe_2 = str_to_title(AWaRe_2)
    )

  # åˆå¹¶ antibiotic_1 å’Œ 2
  aware_1 <- data_clean %>%
    filter(!is.na(antibiotic_1)) %>%
    mutate(AWaRe = AWaRe_1) %>%
    dplyr::select(case_type, AWaRe)

  aware_2 <- data_clean %>%
    filter(!is.na(antibiotic_2)) %>%
    mutate(AWaRe = AWaRe_2) %>%
    dplyr::select(case_type, AWaRe)

  aware_all <- bind_rows(aware_1, aware_2) %>%
    filter(AWaRe %in% c("Access", "Watch", "Reserve"))

  result <- aware_all %>%
    group_by(case_type, AWaRe) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(case_type) %>%
    mutate(p = round(n / sum(n), 3),
           value = paste0(n, " (", sprintf("%.3f", p), ")")) %>%
    dplyr::select(case_type, AWaRe, value) %>%
    pivot_wider(names_from = AWaRe, values_from = value, values_fill = "0 (0.000)") %>%
    arrange(case_type)

  return(result)
}

# è¿è¡Œä¸»å‡½æ•°
aware_summary <- summarise_aware_by_case(prescription_rate_data)

# ä¿å­˜ç»“æœä¸º Excel
time_str <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("AWaRe_Case_Summary_", time_str, ".xlsx")

wb <- createWorkbook()
addWorksheet(wb, "AWaRe_Summary")
writeData(wb, "AWaRe_Summary", aware_summary)
saveWorkbook(wb, filename, overwrite = TRUE)

message("æ±‡æ€»è¡¨å·²ä¿å­˜ï¼š", filename)





```






#### Table 3 AWareåˆ†ç±»ï¼ˆå¤‡é€‰ï¼Œå› ä¸ºä¸åŒç‰¹å¾æœ‰ç¼ºå¤±å€¼ï¼Œæœ‰ç¼ºå¤±å€¼çš„åœ°æ–¹æ•°å€¼æ˜¯0ï¼‰

```{r}

library(dplyr)
library(tidyr)
library(openxlsx)
library(stringr)

# å®šä¹‰å®Œæ•´çš„ç‰¹å¾-æ°´å¹³ç»„åˆå…¨é›†
feature_level_full <- tribble(
  ~ç‰¹å¾, ~æ°´å¹³,
  "province", "Gansu",
  "province", "Guangdong",
  "province", "Guizhou",
  "province", "Hunan",
  "province", "InnerMongolia",
  "province", "Shaanx",
  "province", "Sichuan",
  "doctor_age", "30-50",
  "doctor_age", "<30",
  "doctor_age", "â‰¥50",
  "doctor_female", "å¥³",
  "doctor_female", "ç”·",
  "ownership_type", "ç§ç«‹",
  "ownership_type", "å…¬ç«‹",
  "rural_type", "urban",
  "rural_type", "rural",
  "management_type", "éè¥åˆ©æ€§",
  "management_type", "è¥åˆ©æ€§",
  "sp_gender", "å¥³",
  "sp_gender", "ç”·",
  "sp_age_group", "30-50",
  "sp_age_group", "â‰¥50"
)

group_vars <- c("province", "doctor_age", "doctor_female",
                "ownership_type", "rural_type", "management_type", "sp_gender")

generate_aware_table <- function(data, case) {
  data_case <- data %>% filter(case_type == case)

  # æ¸…æ´—å˜é‡
  data_case <- data_case %>%
    mutate(
      doctor_age = case_when(
        doctor_age == "1" ~ "<30",
        doctor_age == "2" ~ "30-50",
        doctor_age == "3" ~ "â‰¥50",
        TRUE ~ as.character(doctor_age)
      ),
      sp_age_group = case_when(
        sp_age < 30 ~ "<30",
        sp_age >= 30 & sp_age <= 50 ~ "30-50",
        sp_age > 50 ~ "â‰¥50",
        TRUE ~ NA_character_
      ),
      doctor_female = case_when(
        doctor_female == 0 ~ "ç”·",
        doctor_female == 1 ~ "å¥³",
        TRUE ~ as.character(doctor_female)
      ),
      sp_gender = as.character(sp_gender)
    )

  # åˆå¹¶ antibiotic_1 å’Œ antibiotic_2
  aware_1 <- data_case %>%
    filter(!is.na(antibiotic_1)) %>%
    mutate(AWaRe = AWaRe_1) %>%
    dplyr::select(all_of(group_vars), sp_age_group, AWaRe)

  aware_2 <- data_case %>%
    filter(!is.na(antibiotic_2)) %>%
    mutate(AWaRe = AWaRe_2) %>%
    dplyr::select(all_of(group_vars), sp_age_group, AWaRe)

  aware_all <- bind_rows(aware_1, aware_2) %>%
    mutate(AWaRe = case_when(
      str_to_lower(AWaRe) == "access" ~ "Access",
      str_to_lower(AWaRe) == "watch" ~ "Watch",
      str_to_lower(AWaRe) == "reserve" ~ "Reserve",
      TRUE ~ NA_character_
    ))

  if (nrow(aware_all) == 0) {
    message(paste0("Case '", case, "' ä¸­æ— æœ‰æ•ˆæ•°æ®ï¼Œè·³è¿‡ç”Ÿæˆè¡¨æ ¼"))
    return(NULL)
  }

  all_aware_levels <- c("Access", "Watch", "Reserve")
  total_n <- aware_all %>% filter(!is.na(AWaRe)) %>% nrow()

  result_df <- data.frame()

  for (feature_name in c(group_vars, "sp_age_group")) {
    tmp_df <- aware_all %>%
      filter(!is.na(.data[[feature_name]]), !is.na(AWaRe)) %>%
      group_by(characteristic = feature_name,
               level = .data[[feature_name]],
               AWaRe) %>%
      summarise(n = n(), .groups = "drop") %>%
      mutate(percentage = round(n / total_n, 3)) %>%
      complete(characteristic, level, AWaRe = all_aware_levels,
               fill = list(n = 0, percentage = 0)) %>%
      mutate(value = paste0(n, " (", sprintf("%.3f", percentage), ")")) %>%
      dplyr::select(characteristic, level, AWaRe, value) %>%
      pivot_wider(names_from = AWaRe, values_from = value,
                  values_fill = "0 (0.000)") %>%
      arrange(characteristic, level)

    result_df <- bind_rows(result_df, tmp_df)
  }

  # å‘½ååˆ—
  colnames(result_df) <- c("ç‰¹å¾", "æ°´å¹³", "Access", "Watch", "Reserve")

  # å¼ºåˆ¶ä¿ç•™æ‰€æœ‰ç‰¹å¾æ°´å¹³
  result_df <- feature_level_full %>%
    left_join(result_df, by = c("ç‰¹å¾", "æ°´å¹³")) %>%
    mutate(across(c("Access", "Watch", "Reserve"), ~replace_na(., "0 (0.000)")))

  # æ·»åŠ æ€»è®¡è¡Œ
  aware_summary <- aware_all %>%
    filter(!is.na(AWaRe)) %>%
    group_by(AWaRe) %>%
    summarise(n = n(), .groups = "drop") %>%
    mutate(percentage = round(n / total_n, 3),
           value = paste0(n, " (", sprintf("%.3f", percentage), ")")) %>%
    dplyr::select(AWaRe, value) %>%
    pivot_wider(names_from = AWaRe, values_from = value) %>%
    mutate(ç‰¹å¾ = "æ€»è®¡", æ°´å¹³ = "å…¨éƒ¨")

  for (level in all_aware_levels) {
    if (!(level %in% colnames(aware_summary))) {
      aware_summary[[level]] <- "0 (0.000)"
    }
  }

  aware_summary <- aware_summary %>% dplyr::select(ç‰¹å¾, æ°´å¹³, all_of(all_aware_levels))
  result_df <- bind_rows(result_df, aware_summary)

  return(result_df)
}

# ä¸»æµç¨‹
case_list <- unique(prescription_rate_data$case_type)
result_list <- list()

for (case in case_list) {
  message("æ­£åœ¨å¤„ç†ç–¾ç—…ï¼š", case)
  df_case <- generate_aware_table(prescription_rate_data, case)
  if (!is.null(df_case)) {
    result_list[[case]] <- df_case
  }
}

# ä¿å­˜ Excel
time_str <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("AWaRe_Usage_By_Case_", time_str, ".xlsx")

wb <- createWorkbook()
for (case in names(result_list)) {
  sheet_name <- substr(case, 1, 31)
  addWorksheet(wb, sheetName = sheet_name)
  writeData(wb, sheet = sheet_name, result_list[[case]])
}
saveWorkbook(wb, file = filename, overwrite = TRUE)
message(paste0("æ‰€æœ‰è¡¨æ ¼å·²ä¿å­˜åˆ° ", filename))




```

```{r}

generate_AWaRe_table(prescription_rate_data, unique(prescription_rate_data$case_type)[1])




```


##### è½¬æˆæ¨ªå‘å †ç§¯å›¾ï¼šFugure 1. Distribution of prescribed antibiotic by WHO AWaRe categories for 11 case at primary healthcare

```{r}

# library(ggplot2)
# library(dplyr)
# library(tidyr)
# library(scales)
#
# # åŸå§‹æ•°æ®
# data <- data.frame(
#   case_type_cn = c("åå¤´ç—›", "å‹åŠ›æ€§å°¿å¤±ç¦", "å“®å–˜", "å°å„¿è…¹æ³»", "å¿ƒç»ç—›", "æ™®é€šæ„Ÿå†’",
#                    "ç³–å°¿ç—…", "èƒƒç‚", "è…°èƒŒç—›", "é«˜è¡€å‹"),
#   Access = c(5, 6, 19, 6, 8, 48, 1, 27, 5, 6),
#   Watch = c(4, 9, 25, 0, 1, 46, 4, 6, 3, 4)
# )
#
# case_type_en <- c("Migraine", "Stress Urinary Incontinence", "Asthma", "Pediatric Diarrhea",
#                   "Angina", "Common Cold", "Diabetes", "Gastritis", "Low Back Pain", "Hypertension")
# data$case_type <- factor(case_type_en, levels = rev(case_type_en))
#
# data <- data %>%
#   mutate(
#     Total = Access + Watch,
#     Access_pct = Access / Total,
#     Watch_pct = Watch / Total
#   )
#
# plot_data <- data %>%
#   dplyr::select(case_type, Access, Watch, Access_pct, Watch_pct) %>%
#   pivot_longer(cols = c(Access, Watch),
#                names_to = "Category", values_to = "Count") %>%
#   mutate(
#     Percent = ifelse(Category == "Access", Access_pct, Watch_pct),
#     label = ifelse(Percent > 0, paste0(round(Percent * 100, 1), "%"), "")
#   )
#
# # æ³¨æ„è¿™é‡Œè°ƒæ•´é¡ºåºï¼Œå…ˆWatchåAccess
# plot_data <- plot_data %>%
#   group_by(case_type) %>%
#   arrange(case_type, factor(Category, levels = c("Watch", "Access"))) %>%
#   mutate(
#     xmin = cumsum(lag(Percent, default = 0)),
#     xmax = xmin + Percent,
#     label_pos = xmin + Percent / 2
#   ) %>%
#   ungroup()
#
# # é¢œè‰²ï¼Œé¡ºåºå¯¹åº”
# custom_colors <- c("Watch" = "#024B7A", "Access" = "#FFAE49")
#
# p <- ggplot(plot_data, aes(x = Percent, y = case_type, fill = Category)) +
#   geom_bar(stat = "identity", position = "stack") +
#   geom_text(aes(x = label_pos, label = label), color = "white", size = 4.2) +
#   scale_fill_manual(values = custom_colors, breaks = c("Watch", "Access")) +  # breaksç¡®å®šå›¾ä¾‹é¡ºåº
#   scale_x_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0, 0)) +
#   labs(
#     title = "Distribution of Antibiotic Classes by Case Type",
#     x = "Percentage (%)",
#     y = "Case Type",
#     fill = ""
#   ) +
#   theme_minimal(base_size = 14) +
#   theme(legend.position = "bottom")
#
# ggsave(
#   plot = p,
#   filename = "antibiotic_distribution.pdf",
#   width = 10,
#   height = 6,
#   dpi = 400,
#   units = "in"
# )




library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)

# åŸå§‹æ•°æ®
data <- data.frame(
  case_type_cn = c("åå¤´ç—›", "å‹åŠ›æ€§å°¿å¤±ç¦", "å“®å–˜", "å°å„¿è…¹æ³»", "å¿ƒç»ç—›", "æ™®é€šæ„Ÿå†’",
                   "ç³–å°¿ç—…", "èƒƒç‚", "è…°èƒŒç—›", "é«˜è¡€å‹"),
  Access = c(5, 6, 19, 6, 8, 48, 1, 27, 5, 6),
  Watch = c(4, 9, 25, 0, 1, 46, 4, 6, 3, 4)
)

case_type_en <- c("Migraine", "Stress Urinary Incontinence", "Asthma", "Pediatric Diarrhea",
                  "Angina", "Common Cold", "Diabetes", "Gastritis", "Low Back Pain", "Hypertension")
data$case_type <- factor(case_type_en, levels = rev(case_type_en))

data <- data %>%
  mutate(
    Total = Access + Watch,
    Access_pct = Access / Total,
    Watch_pct = Watch / Total
  )

plot_data <- data %>%
  dplyr::select(case_type, Access, Watch, Access_pct, Watch_pct) %>%
  pivot_longer(cols = c(Access, Watch),
               names_to = "Category", values_to = "Count") %>%
  mutate(
    Percent = ifelse(Category == "Access", Access_pct, Watch_pct),
    label = ifelse(Percent > 0, paste0(round(Percent * 100, 1), "%"), "")
  )

# æ³¨æ„è¿™é‡Œè°ƒæ•´é¡ºåºï¼Œå…ˆWatchåAccess
plot_data <- plot_data %>%
  group_by(case_type) %>%
  arrange(case_type, factor(Category, levels = c("Watch", "Access"))) %>%
  mutate(
    xmin = cumsum(lag(Percent, default = 0)),
    xmax = xmin + Percent,
    label_pos = xmin + Percent / 2
  ) %>%
  ungroup()

# é¢œè‰²ï¼Œé¡ºåºå¯¹åº”
custom_colors <- c("Watch" = "#1C366A", "Access" = "#AF060F")

p <- ggplot(plot_data, aes(x = Percent, y = case_type, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(x = label_pos, label = label), color = "white", size = 4.2) +
  scale_fill_manual(values = custom_colors, breaks = c("Watch", "Access")) +  # breaksç¡®å®šå›¾ä¾‹é¡ºåº
  scale_x_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0, 0)) +
  labs(
    title = "Distribution of Antibiotic Classes by Case Type",
    x = "Percentage (%)",
    y = "Case Type",
    fill = ""
  ) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom")

ggsave(
  plot = p,
  filename = "antibiotic_distribution.pdf",
  width = 14,
  height = 6,
  dpi = 400,
  units = "in"
)




```











#### Table 4 ATCåˆ†ç±»



```{r}


library(dplyr)
library(tidyr)
library(stringr)

# Step 1: æ•´ç†æ•°æ®ä¸ºé•¿æ ¼å¼
atc_long <- prescription_rate_data %>%
  dplyr::select(case_type, ATC_1, ATC_2) %>%
  pivot_longer(cols = c(ATC_1, ATC_2), values_to = "ATC") %>%
  filter(!is.na(ATC))

# Step 2: å„ case_type æ€»æŠ—ç”Ÿç´ æ•°
case_totals <- atc_long %>%
  count(case_type, name = "total")

# Step 3: å„ ATC Ã— case_type çš„é¢‘æ•° + æ¯”ä¾‹
atc_summary <- atc_long %>%
  group_by(case_type, ATC) %>%
  summarise(n = n(), .groups = "drop") %>%
  left_join(case_totals, by = "case_type") %>%
  mutate(
    p = round(n / total * 100, 1),
    cell = paste0(n, " (", p, "%)")
  ) %>%
  dplyr::select(ATC, case_type, cell)

# Step 4: è¡¥å…¨æ‰€æœ‰ç»„åˆ
all_cases <- unique(prescription_rate_data$case_type)
all_atcs <- unique(c(prescription_rate_data$ATC_1, prescription_rate_data$ATC_2)) %>% na.omit()

complete_table <- expand.grid(
  ATC = all_atcs,
  case_type = all_cases,
  stringsAsFactors = FALSE
) %>%
  left_join(atc_summary, by = c("ATC", "case_type")) %>%
  mutate(cell = replace_na(cell, "0 (0.0%)"))

# âœ… Step 5: è®¡ç®—æ¯ä¸ª ATC çš„æ€»è®¡åˆ—
total_by_atc <- atc_long %>%
  group_by(ATC) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(
    p = round(n / sum(n) * 100, 1),
    `æ€»è®¡` = paste0(n, " (", p, "%)")
  ) %>%
  dplyr::select(ATC, æ€»è®¡)

# Step 6: è½¬å®½è¡¨ï¼ˆATC Ã— case_typeï¼‰
wide_table <- complete_table %>%
  pivot_wider(names_from = case_type, values_from = cell) %>%
  left_join(total_by_atc, by = "ATC") %>%
  relocate(æ€»è®¡, .after = ATC) %>%  # âœ… æŠŠæ€»è®¡åˆ—ç§»åˆ°ç–¾ç—…å‰
  arrange(ATC)

# Step 7: æ·»åŠ  Total è¡Œï¼ˆæŒ‰ç—…ä¾‹ç±»å‹æ€»æ•°ï¼‰
total_row <- case_totals %>%
  mutate(
    cell = paste0(total, " (100.0%)")
  ) %>%
  dplyr::select(case_type, cell) %>%
  pivot_wider(names_from = case_type, values_from = cell) %>%
  mutate(
    ATC = "Total",
    æ€»è®¡ = paste0(sum(case_totals$total), " (100.0%)")
  ) %>%
  dplyr::select(ATC, æ€»è®¡, everything())

# Step 8: åˆå¹¶æœ€ç»ˆè¡¨æ ¼
final_table <- bind_rows(wide_table, total_row)

# æŸ¥çœ‹å‰å‡ è¡Œç»“æœ
print(head(final_table))

# Step 9: å¯¼å‡ºä¸º CSVï¼ˆå¯é€‰ï¼‰
write.csv(final_table, "ATC_by_case_type_with_total_column.csv", row.names = FALSE)


write.csv(prescription_rate_data, "prescription_rate_data.csv", row.names = FALSE)



```










#### Table 5 åŸºè¯åˆ†ç±»



```{r}

library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(openxlsx)

# è¯»æ•°æ®
df <- read_excel("data/essentialmedicine.xlsx")

# è½¬å­—ç¬¦
df <- df %>%
  mutate(
    essential_medicine_1 = as.character(essential_medicine_1),
    essential_medicine_2 = as.character(essential_medicine_2)
  )

# é•¿æ ¼å¼åˆå¹¶ä¸¤åˆ—
essential_long <- df %>%
  pivot_longer(
    cols = c(essential_medicine_1, essential_medicine_2),
    names_to = "med_order",
    values_to = "essential"
  )

# åªä¿ç•™0å’Œ1
essential_filtered <- essential_long %>%
  filter(essential %in% c("0", "1"))

# ç»Ÿè®¡æ¯ä¸ª case_type å’Œ essential çš„æ•°é‡
count_df <- essential_filtered %>%
  group_by(case_type, essential) %>%
  summarise(count = n(), .groups = "drop")

# è®¡ç®—æ¯ä¸ª case_type çš„æ€»æ•°
total_df <- count_df %>%
  group_by(case_type) %>%
  summarise(total = sum(count), .groups = "drop")

# åˆå¹¶æ€»æ•°å¹¶è®¡ç®—ç™¾åˆ†æ¯”
count_df <- count_df %>%
  left_join(total_df, by = "case_type") %>%
  mutate(
    percent = sprintf("%.1f%%", count / total * 100),
    cell = paste0(count, " (", percent, ")")
  )

# åˆ›å»ºæ€»è®¡åˆ—ï¼ˆæ‰€æœ‰ case_type çš„åˆå¹¶ï¼‰
summary_total <- count_df %>%
  group_by(essential) %>%
  summarise(
    count = sum(count),
    total = sum(total),
    .groups = "drop"
  ) %>%
  mutate(
    percent = sprintf("%.1f%%", count / total * 100),
    æ€»è®¡ = paste0(count, " (", percent, ")")
  ) %>%
  dplyr::select(essential, æ€»è®¡)

# è½¬å®½æ ¼å¼è¡¨ï¼ˆæŒ‰ç—…ä¾‹åˆ†åˆ—ï¼‰
wide_df <- count_df %>%
  dplyr::select(case_type, essential, cell) %>%
  pivot_wider(
    names_from = case_type,
    values_from = cell,
    values_fill = "0 (0.0%)"
  ) %>%
  left_join(summary_total, by = "essential") %>%
  relocate(æ€»è®¡, .after = essential) %>%  # å°†â€œæ€»è®¡â€åˆ—æ”¾åœ¨ç—…ä¾‹æœ€å‰é¢
  rename(`åŸºè¯ä½¿ç”¨æƒ…å†µ` = essential)

# æ·»åŠ åˆè®¡è¡Œï¼ˆæ¯åˆ—åˆè®¡ï¼‰
total_row <- total_df %>%
  mutate(
    cell = paste0(total, " (100%)"),
    essential = "åˆè®¡"
  ) %>%
  dplyr::select(case_type, essential, cell) %>%
  pivot_wider(
    names_from = case_type,
    values_from = cell
  )

# æ·»åŠ æ€»è®¡åˆ—çš„åˆè®¡
total_count <- sum(total_df$total)
total_row <- total_row %>%
  mutate(
    æ€»è®¡ = paste0(total_count, " (100%)"),
    `åŸºè¯ä½¿ç”¨æƒ…å†µ` = "åˆè®¡"
  ) %>%
  dplyr::select(`åŸºè¯ä½¿ç”¨æƒ…å†µ`, æ€»è®¡, everything())

# åˆå¹¶è¡¨æ ¼
final_df <- bind_rows(wide_df, total_row)

# è¡Œæ’åº
final_df$`åŸºè¯ä½¿ç”¨æƒ…å†µ` <- factor(final_df$`åŸºè¯ä½¿ç”¨æƒ…å†µ`, levels = c("0", "1", "åˆè®¡"))
final_df <- final_df %>% arrange(`åŸºè¯ä½¿ç”¨æƒ…å†µ`)

# è¾“å‡º
print(final_df)

# å¯¼å‡ºExcel
time_str <- format(Sys.time(), "%Y%m%d_%H%M%S")
filename <- paste0("åŸºè¯ç»Ÿè®¡_å«åˆ—åˆè®¡_", time_str, ".xlsx")
write.xlsx(final_df, file = filename, rowNames = FALSE)
message("å¯¼å‡ºæ–‡ä»¶ï¼š", filename)




```






#### ATCåˆ†å¸ƒ


è¿™ä¸ªè¡¨æ ¼çš„ è¡Œæ˜¯ ATC ç¼–ç ï¼Œåˆ—æ˜¯ç–¾ç—…ç±»å‹ï¼ˆcase_typeï¼‰ï¼Œå•å…ƒæ ¼æ˜¯è¯¥ ATC åœ¨è¯¥ç–¾ç—…ä¸­çš„ä½¿ç”¨æ¯”ä¾‹ï¼Œå³ï¼š

æ¯”ä¾‹=è¯¥ç–¾ç—…ä¸­è¯¥ATCå‡ºç°æ¬¡æ•° / è¯¥ç–¾ç—…ä¸­æ‰€æœ‰ATCå‡ºç°æ€»æ¬¡æ•°



```{r}

library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)

# 1. æå– antibiotic_1 å’Œ antibiotic_2 çš„ case_type ä¸ ATC
abx_1 <- prescription_rate_data %>%
  dplyr::filter(!is.na(antibiotic_1)) %>%
  dplyr::rename(ATC = ATC_1) %>%
  dplyr::select(case_type, ATC)

abx_2 <- prescription_rate_data %>%
  dplyr::filter(!is.na(antibiotic_2)) %>%
  dplyr::rename(ATC = ATC_2) %>%
  dplyr::select(case_type, ATC)

# 2. åˆå¹¶
abx_all <- dplyr::bind_rows(abx_1, abx_2) %>%
  dplyr::filter(!is.na(ATC), !is.na(case_type))

# 3. è®¡ç®—æ¯ç§ç–¾ç—…æ¯ä¸ªATCçš„æ•°é‡
atc_case_count <- abx_all %>%
  dplyr::group_by(case_type, ATC) %>%
  dplyr::summarise(count = dplyr::n(), .groups = "drop")

# 4. è®¡ç®—æ¯ç§ç–¾ç—…çš„æ€»æŠ—ç”Ÿç´ æ•°é‡ï¼Œç”¨äºæ¯”ä¾‹è®¡ç®—
case_totals <- atc_case_count %>%
  dplyr::group_by(case_type) %>%
  dplyr::summarise(total = sum(count), .groups = "drop")

# 5. åˆå¹¶æ•°é‡ä¸æ€»æ•°ï¼Œè®¡ç®—æ¯”ä¾‹
atc_case_stats <- atc_case_count %>%
  dplyr::left_join(case_totals, by = "case_type") %>%
  dplyr::mutate(proportion = count / total) %>%
  dplyr::select(case_type, ATC, count, proportion)

# 6. æ ¼å¼åŒ–å•å…ƒæ ¼ï¼Œåˆå¹¶countå’Œproportion
atc_case_stats <- atc_case_stats %>%
  dplyr::mutate(count_prop = paste0(count, " (", sprintf("%.3f", proportion), ")"))

# 7. è½¬æˆå®½æ ¼å¼ï¼Œè¡Œæ˜¯ATCï¼Œåˆ—æ˜¯ç–¾ç—…ï¼Œå†…å®¹æ˜¯â€œæ•°é‡ (æ¯”ä¾‹)â€
atc_case_wide <- atc_case_stats %>%
  dplyr::select(case_type, ATC, count_prop) %>%
  tidyr::pivot_wider(names_from = case_type, values_from = count_prop, values_fill = "0 (0.000)")

# 8. è¾“å‡ºè¡¨æ ¼
atc_case_wide %>%
  knitr::kable(caption = "ATC ç¼–ç åœ¨å„ç–¾ç—…ç±»å‹ä¸­çš„æ•°é‡ä¸æ¯”ä¾‹ï¼ˆcount (proportion)ï¼‰") %>%
  kableExtra::kable_styling(full_width = TRUE)




# ç”Ÿæˆå¸¦æœ‰å½“å‰æ—¥æœŸçš„æ–‡ä»¶å
output_filename <- paste("ATC-", format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")

# ä¿å­˜Excelæ–‡ä»¶ï¼Œå¹¶åŒ…å«æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶å
write.xlsx(atc_case_wide, file = output_filename)

rm(output_filename)







```



```{r}

library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(openxlsx)

# 1. æå– antibiotic_1 å’Œ antibiotic_2 çš„ case_type ä¸ ATC
abx_1 <- prescription_rate_data %>%
  dplyr::filter(!is.na(antibiotic_1)) %>%
  dplyr::rename(ATC = ATC_1) %>%
  dplyr::select(case_type, ATC)

abx_2 <- prescription_rate_data %>%
  dplyr::filter(!is.na(antibiotic_2)) %>%
  dplyr::rename(ATC = ATC_2) %>%
  dplyr::select(case_type, ATC)

# 2. åˆå¹¶æ‰€æœ‰æŠ—ç”Ÿç´ è®°å½•
abx_all <- dplyr::bind_rows(abx_1, abx_2) %>%
  dplyr::filter(!is.na(ATC), !is.na(case_type))

# 3. è®¡ç®—æ¯ç§ç–¾ç—…æ¯ä¸ªATCçš„æ•°é‡
atc_case_count <- abx_all %>%
  dplyr::group_by(case_type, ATC) %>%
  dplyr::summarise(count = dplyr::n(), .groups = "drop")

# 4. è½¬ä¸ºå®½æ ¼å¼ï¼ˆè¡Œæ˜¯ ATCï¼Œåˆ—æ˜¯ case_typeï¼Œå€¼ä¸º countï¼‰
atc_case_wide <- atc_case_count %>%
  tidyr::pivot_wider(
    names_from = case_type,
    values_from = count,
    values_fill = 0
  )

# 5. è¾“å‡ºè¡¨æ ¼ï¼ˆå¯è§†åŒ–é¢„è§ˆï¼‰
atc_case_wide %>%
  knitr::kable(caption = "ATC ç¼–ç åœ¨å„ç–¾ç—…ç±»å‹ä¸­çš„å¼€è¯æ¬¡æ•°") %>%
  kableExtra::kable_styling(full_width = TRUE)

# 6. ç”Ÿæˆå¸¦æ—¥æœŸçš„æ–‡ä»¶åå¹¶å¯¼å‡ºä¸º Excel
output_filename <- paste0("ATC2-", format(Sys.time(), "%Y-%m-%d"), ".xlsx")
write.xlsx(atc_case_wide, file = output_filename)

# æ¸…é™¤å˜é‡
rm(output_filename)




```









```{r}



library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(scales)
library(colorspace)

# å‡è®¾ä½ çš„æ•°æ®æ¡†åæ˜¯ atc_case_wideï¼Œç»“æ„ç±»ä¼¼ï¼š
#  | ATC     | case_type1 | case_type2 | ... |
#  |---------|------------|------------|-----|
#  | J01CA01 | 10         | 5          | ... |
#  | J01DB02 | 3          | 8          | ... |

# Step 1: è½¬æ¢æ•°æ®ä¸ºé•¿æ ¼å¼
abx_long <- atc_case_wide %>%
  pivot_longer(-ATC, names_to = "case_type", values_to = "count") %>%
  filter(count > 0)

# Step 2: è®¡ç®—æ¯”ä¾‹
abx_prop <- abx_long %>%
  group_by(case_type) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()

# Step 3: æå–ATCç±»åˆ«åˆ—è¡¨
atc_list <- sort(unique(abx_prop$ATC))

# Step 4: ç”Ÿæˆ27ä¸ªé«˜é¥±å’Œåº¦é¢œè‰²
my_colors <- qualitative_hcl(
  n = length(atc_list),
  h = c(0, 360),   # è‰²è°ƒç¯å…¨è¦†ç›–
  c = 100,         # é¥±å’Œåº¦é«˜
  l = 50           # äº®åº¦é€‚ä¸­
)
names(my_colors) <- atc_list

# Step 5: ç»˜å›¾
ggplot(abx_prop, aes(x = prop, y = fct_rev(case_type), fill = ATC)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "å„ç–¾ç—…æŠ—ç”Ÿç´ ä½¿ç”¨åˆ†å¸ƒï¼ˆé«˜é¥±å’Œåº¦é…è‰²ï¼‰",
    x = "æŠ—ç”Ÿç´ å¤„æ–¹å æ¯”",
    y = "ç–¾ç—…ç±»å‹",
    fill = "ATCç±»åˆ«"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 9),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    panel.grid.major.y = element_blank()
  )








```



```{r}


library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(scales)
library(colorspace)

# Step 1: è½¬æ¢æ•°æ®ä¸ºé•¿æ ¼å¼
abx_long <- atc_case_wide %>%
  pivot_longer(-ATC, names_to = "case_type", values_to = "count") %>%
  filter(count > 0)

# Step 2: è®¡ç®—æ¯”ä¾‹
abx_prop <- abx_long %>%
  group_by(case_type) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()

# Step 3: æå–ATCç±»åˆ«åˆ—è¡¨
atc_list <- sort(unique(abx_prop$ATC))

# Step 4: ä½¿ç”¨æ·±è‰²ä¼˜å…ˆç”Ÿæˆé…è‰²
set.seed(2025)
atc_colors <- qualitative_hcl(
  n = length(atc_list),
  palette = "Dark 3",     # å¼ºè°ƒæ·±è‰²ç³»
  l = 40,                 # äº®åº¦ï¼ˆlè¶Šå°è¶Šæ·±ï¼‰ï¼Œé»˜è®¤æ˜¯ 60-80ï¼Œæˆ‘ä»¬é™åˆ° 40
  c = 100                 # è‰²å½©é¥±å’Œåº¦ï¼Œ100æ¯”è¾ƒé«˜
)
names(atc_colors) <- atc_list

# Step 5: ç»˜å›¾
ggplot(abx_prop, aes(x = prop, y = fct_rev(case_type), fill = ATC)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = atc_colors) +
  labs(
    title = "å„ç–¾ç—…æŠ—ç”Ÿç´ ä½¿ç”¨åˆ†å¸ƒï¼ˆæ·±è‰²é«˜è¾¨è¯†åº¦é…è‰²ï¼‰",
    x = "æŠ—ç”Ÿç´ å¤„æ–¹å æ¯”",
    y = "ç–¾ç—…ç±»å‹",
    fill = "ATCç±»åˆ«"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 9),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    panel.grid.major.y = element_blank()
  )



```



















### æŠ—èŒè¯ç‰©å¼€è®¾è¯ç‰©å¤„æ–¹çš„æ»¡æ„åº¦

```{r}

library(dplyr)

prescription_rate_data <- prescription_rate_data %>%
  left_join(
    qualityresult %>% dplyr::select(record_id, `è¯äº‹æœåŠ¡æ»¡æ„åº¦`),
    by = "record_id"
  )



```

```{r}

table(prescription_rate_data$`è¯äº‹æœåŠ¡æ»¡æ„åº¦`, useNA = "always")
table(prescription_rate_data$antibiotic_prescribed, useNA = "always")


```




```{r}


library(dplyr)

# æè¿°æ€§åˆ—è”è¡¨
table_satisfaction <- prescription_rate_data %>%
  filter(!is.na(`è¯äº‹æœåŠ¡æ»¡æ„åº¦`), !is.na(antibiotic_prescribed)) %>%
  count(antibiotic_prescribed, `è¯äº‹æœåŠ¡æ»¡æ„åº¦`) %>%
  group_by(antibiotic_prescribed) %>%
  mutate(percent = round(100 * n / sum(n), 1))

# ç¾è§‚è¾“å‡º
library(tidyr)
table_satisfaction_wide <- table_satisfaction %>%
  unite("n_percent", n, percent, sep = " (") %>%
  mutate(n_percent = paste0(n_percent, "%)")) %>%
  pivot_wider(names_from = `è¯äº‹æœåŠ¡æ»¡æ„åº¦`, values_from = n_percent)

# æŸ¥çœ‹
print(table_satisfaction_wide)



```





# å¾è€å¸ˆå»ºè®®æ–‡ç« 
## æŠ—ç”Ÿç´ æ˜¯å¦æ˜¯å”¯ä¸€çš„è¯ï¼Œè¿˜æ˜¯æœ‰å…¶ä»–è”ç”¨çš„è¯
æ–‡æ¡£è§ `output_by_case_type.xlsx`

```{r}

library(readxl)
library(dplyr)
library(tidyr)
library(purrr)

file_path <- "antibotic_drug_info_by_cases-2025-06-01.xlsx"
sheet_names <- excel_sheets(file_path)

process_sheet <- function(sheet_name) {
  # è¯»å–å•ä¸ªsheet
  df <- read_excel(file_path, sheet = sheet_name)

  # æ ‡å‡†åŒ–åˆ—å
  names(df) <- tolower(trimws(names(df)))

  # æ£€æŸ¥å¿…é¡»åˆ—
  required_cols <- c("record_id", "drug_total_fee", "common_name")
  missing_cols <- setdiff(required_cols, names(df))
  if (length(missing_cols) > 0) {
    stop(paste("Sheet", sheet_name, "ç¼ºå°‘åˆ—:", paste(missing_cols, collapse = ", ")))
  }

  # åªä¿ç•™ç›®æ ‡åˆ—ï¼Œè½¬æ¢ drug_total_fee ä¸ºæ•°å€¼å‹ï¼ˆè‹¥è½¬æ¢å¤±è´¥åˆ™ä¸ºNAï¼‰
  df <- df %>%
    dplyr::select(record_id, drug_total_fee, common_name) %>%
    mutate(drug_total_fee = as.numeric(drug_total_fee))

  # è´¹ç”¨èšåˆï¼šæ¯ä¸ªrecord_idå–ç¬¬ä¸€ä¸ªéNAçš„drug_total_feeï¼Œå¦‚æœå…¨NAåˆ™ä¸ºNA
  fee_data <- df %>%
    group_by(record_id) %>%
    dplyr::summarize(
      drug_total_fee = if (all(is.na(drug_total_fee))) NA_real_ else first(na.omit(drug_total_fee)),
      .groups = "drop"
    )

  # è¯å“é¡ºåºç¼–å·ï¼ˆä»…å¯¹éNA common_nameï¼‰
  drug_data <- df %>%
    group_by(record_id) %>%
    mutate(drug_order = ifelse(!is.na(common_name), paste0("drug", row_number()), NA_character_)) %>%
    ungroup()

  # å®½æ ¼å¼è½¬æ¢ï¼Œè¯å“åˆ—
  drug_wide <- drug_data %>%
    filter(!is.na(drug_order)) %>%
    dplyr::select(record_id, drug_order, common_name) %>%
    pivot_wider(names_from = drug_order, values_from = common_name)

  # åˆå¹¶è´¹ç”¨å’Œè¯å“å®½è¡¨ï¼Œå¹¶å¢åŠ case_typeåˆ—
  full_data <- fee_data %>%
    left_join(drug_wide, by = "record_id") %>%
    mutate(case_type = sheet_name) %>%
    dplyr::select(record_id, drug_total_fee, case_type, everything())

  return(full_data)
}

# å¯¹æ‰€æœ‰sheetå¤„ç†å¹¶åˆå¹¶
combined_drug_data <- map_dfr(sheet_names, process_sheet)

# æŸ¥çœ‹ç»“æœå‰å‡ è¡Œï¼Œæ£€æŸ¥æ•°æ®ç»“æ„
print(head(combined_drug_data))





```



```{r}

library(writexl)


# å‡è®¾ final_data å·²ç»åŠ è½½ä¸”æœ‰ record_id åˆ—

filtered_data <- combined_drug_data %>%
  semi_join(final_data %>% dplyr::select(record_id), by = "record_id")

# æŸ¥çœ‹ç»“æœ
print(nrow(filtered_data))  # åº”è¯¥æ˜¯2143æ¡å·¦å³


# combined_drug_data æ˜¯ä½ åˆå¹¶çš„è¯å“æ•°æ®
# final_data æ˜¯ä½ å·²æœ‰çš„å‚è€ƒæ•°æ®æ¡†ï¼Œé‡Œé¢æœ‰ record_id åˆ—

filtered_combined_drug_data <- combined_drug_data %>%
  semi_join(final_data %>% dplyr::select(record_id), by = "record_id")

# æŸ¥çœ‹å‰å‡ æ¡
head(filtered_combined_drug_data)





# è·å–æ‰€æœ‰å”¯ä¸€çš„ case_type
case_types <- unique(filtered_combined_drug_data$case_type)

# ç”Ÿæˆä¸€ä¸ªå‘½ååˆ—è¡¨ï¼Œç¡®ä¿åå­—å’Œæ•°æ®å¯¹åº”
split_list <- lapply(case_types, function(ct) {
  filtered_combined_drug_data %>% filter(case_type == ct)
})
names(split_list) <- case_types

# å†™å…¥ Excelï¼Œsheet åå°±æ˜¯ case_type
write_xlsx(split_list, path = "output_by_case_type-11.xlsx")




```





### Fugure 2. Distribution of prescribed antibiotic by antibiotic ATC classes for 11 cases at primary healthcare

ç¬¬ä¸€ç§
```{r}

library(tidyr)
library(ggplot2)
library(forcats)
library(scales)

# Step 0: Rename Chinese column names to English
colnames(atc_case_wide) <- c(
  "ATC",
  "Migraine",
  "Stress urinary incontinence",
  "Asthma",
  "Pediatric diarrhea",
  "Angina",
  "Common cold",
  "Diabetes",
  "Gastritis",
  "Low back pain",
  "Hypertension"
)



# Step 1: Data transformation
abx_long <- atc_case_wide %>%
  pivot_longer(-ATC, names_to = "case_type", values_to = "count") %>%
  filter(count > 0)

# Step 2: Proportion calculation
abx_prop <- abx_long %>%
  group_by(case_type) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()


# Step 3: Custom color palette with J01CA04 fixed to #8B1A1A
fixed_color <- "#8B1A1A"
fixed_atc <- "J01CA04"

# åŸå§‹é¢œè‰²ï¼ˆé™¤å» #8B1A1Aï¼‰
colors <- c(
  "#08306B", "#A1D99B", "#6BAED6", "#FEE391",
  "#BCBDDC", "#41AB5D", "#A3C6BF", "#FF8C00", "#007FFF",
  "#E27A6E", "#8BA7BE", "#E3B27E", "#BED877", "#F6C8D4",
  "#D5D6D6", "#AD91C2", "#B22222", "#FFF6B0", "#509C7A",
  "#BF642A", "#6E66AF", "#CF2A78", "#7C9A1C", "#D0A62F",
  "#96772F", "#626262"
)

# è·å– ATC åˆ—è¡¨å¹¶ç§»é™¤å›ºå®šçš„ ATC
atc_list <- sort(unique(abx_prop$ATC))
atc_remaining <- setdiff(atc_list, fixed_atc)

# æ£€æŸ¥é¢œè‰²æ•°é‡æ˜¯å¦åŒ¹é…
if (length(atc_remaining) != length(colors)) {
  stop("å‰©ä½™ ATC ç±»åˆ«æ•°ä¸é¢œè‰²æ•°ä¸ä¸€è‡´ï¼")
}

# æ‹¼æ¥é¢œè‰²æ˜ å°„
my_colors <- c(fixed_color, colors)
names(my_colors) <- c(fixed_atc, atc_remaining)



# Step 4: Plot (larger fonts)
abx_plot <- ggplot(abx_prop, aes(x = prop, y = fct_rev(case_type), fill = ATC)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "Types of antibiotics prescribed for different diagnostic categories",
    x = "Proportion of antibiotic prescriptions",
    y = "Diagnostic category",
    fill = "ATC category"
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE)) +
  theme_minimal(base_size = 36) +  # åŸºç¡€å­—ä½“æ›´å¤§
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.5, "cm"),
    legend.spacing.x = unit(0.4, "cm"),
    legend.margin = margin(t = 5),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title = element_text(size = 24),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

# Step 5: Save plot
ggsave(
  filename = "antibiotic_by_casetype.png",
  plot = abx_plot,
  width = 26,   # å®½åº¦ä¿æŒ
  height = 8,   # é«˜åº¦å¢åŠ ï¼Œæ›´é€‚åˆå¤§å­—ä½“
  dpi = 300
)



```





ç¬¬ä¸€ç§
```{r}

library(tidyr)
library(ggplot2)
library(forcats)
library(scales)

# Step 0: Rename Chinese column names to English
colnames(atc_case_wide) <- c(
  "ATC",
  "Migraine",
  "Stress urinary incontinence",
  "Asthma",
  "Pediatric diarrhea",
  "Angina",
  "Common cold",
  "Diabetes",
  "Gastritis",
  "Low back pain",
  "Hypertension"
)



# Step 1: Data transformation
abx_long <- atc_case_wide %>%
  pivot_longer(-ATC, names_to = "case_type", values_to = "count") %>%
  filter(count > 0)

# Step 2: Proportion calculation
abx_prop <- abx_long %>%
  group_by(case_type) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()


# Step 3: Custom color palette with J01CA04 fixed to #8B1A1A
fixed_color <- "#8B1A1A"
fixed_atc <- "J01CA04"

# åŸå§‹é¢œè‰²ï¼ˆé™¤å» #8B1A1Aï¼‰
colors <- c(
  "#08306B", "#A1D99B", "#6BAED6", "#FEE391",
  "#BCBDDC", "#41AB5D", "#A3C6BF", "#FF8C00", "#007FFF",
  "#E27A6E", "#8BA7BE", "#E3B27E", "#BED877", "#F6C8D4",
  "#D5D6D6", "#AD91C2", "#B22222", "#FFF6B0", "#509C7A",
  "#BF642A", "#6E66AF", "#CF2A78", "#7C9A1C", "#D0A62F",
  "#96772F", "#626262"
)



# è·å– ATC åˆ—è¡¨å¹¶ç§»é™¤å›ºå®šçš„ ATC
atc_list <- sort(unique(abx_prop$ATC))
atc_remaining <- setdiff(atc_list, fixed_atc)

# æ£€æŸ¥é¢œè‰²æ•°é‡æ˜¯å¦åŒ¹é…
if (length(atc_remaining) != length(colors)) {
  stop("å‰©ä½™ ATC ç±»åˆ«æ•°ä¸é¢œè‰²æ•°ä¸ä¸€è‡´ï¼")
}

# æ‹¼æ¥é¢œè‰²æ˜ å°„
my_colors <- c(fixed_color, colors)
names(my_colors) <- c(fixed_atc, atc_remaining)



# Step 4: Plot (larger fonts)
abx_plot <- ggplot(abx_prop, aes(x = prop, y = fct_rev(case_type), fill = ATC)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "Types of antibiotics prescribed for different diagnostic categories",
    x = "Proportion of antibiotic prescriptions",
    y = "Diagnostic category",
    fill = "ATC category"
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE)) +
  theme_minimal(base_size = 36) +  # åŸºç¡€å­—ä½“æ›´å¤§
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.5, "cm"),
    legend.spacing.x = unit(0.4, "cm"),
    legend.margin = margin(t = 5),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title = element_text(size = 24),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

# Step 5: Save plot
ggsave(
  filename = "antibiotic_by_casetype.png",
  plot = abx_plot,
  width = 26,   # å®½åº¦ä¿æŒ
  height = 8,   # é«˜åº¦å¢åŠ ï¼Œæ›´é€‚åˆå¤§å­—ä½“
  dpi = 300
)



```


```{r}

library(tidyr)
library(ggplot2)
library(forcats)
library(scales)

# Step 0: Rename Chinese column names to English
colnames(atc_case_wide) <- c(
  "ATC",
  "Migraine",
  "Stress urinary incontinence",
  "Asthma",
  "Pediatric diarrhea",
  "Angina",
  "Common cold",
  "Diabetes",
  "Gastritis",
  "Low back pain",
  "Hypertension"
)



# Step 1: Data transformation
abx_long <- atc_case_wide %>%
  pivot_longer(-ATC, names_to = "case_type", values_to = "count") %>%
  filter(count > 0)

# Step 2: Proportion calculation
abx_prop <- abx_long %>%
  group_by(case_type) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()


# Step 3: Custom color palette with J01CA04 fixed to #8B1A1A


# åŸå§‹é¢œè‰²ï¼ˆé™¤å» #8B1A1Aï¼‰
colors <- c(
'#00429d', '#2250a4', '#345faa', '#446db1', '#517cb7', '#5f8bbd', '#6c9bc3', '#7aaac9', '#88bacf', '#98c9d4', '#a9d9d9', '#bde7dd', '#d6f5e0', '#ffffe0', '#ffebd1', '#ffd7c2', '#ffc2b2', '#ffaca3', '#fe9694', '#f88186', '#ef6d79', '#e5596d', '#d94561', '#cb3256', '#bb1e4c', '#a80a42', '#93003a'
)


atc_list <- sort(unique(abx_prop$ATC))
if (length(colors) != length(atc_list)) {
  stop("é¢œè‰²æ•°é‡ä¸ ATC ç±»åˆ«æ•°é‡ä¸ä¸€è‡´ï¼")
}
my_colors <- setNames(colors, atc_list)



# Step 4: Plot (larger fonts)
abx_plot <- ggplot(abx_prop, aes(x = prop, y = fct_rev(case_type), fill = ATC)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "Types of antibiotics prescribed for different diagnostic categories",
    x = "Proportion of antibiotic prescriptions",
    y = "Diagnostic category",
    fill = "ATC category"
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE)) +
  theme_minimal(base_size = 36) +  # åŸºç¡€å­—ä½“æ›´å¤§
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.5, "cm"),
    legend.spacing.x = unit(0.4, "cm"),
    legend.margin = margin(t = 5),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title = element_text(size = 24),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

# Step 5: Save plot
ggsave(
  filename = "antibiotic_by_casetype.png",
  plot = abx_plot,
  width = 26,   # å®½åº¦ä¿æŒ
  height = 8,   # é«˜åº¦å¢åŠ ï¼Œæ›´é€‚åˆå¤§å­—ä½“
  dpi = 300
)



```


```{r}


table(mediation_clean$diagnosis_quality_clean, useNA = "ifany")
str(mediation_clean$diagnosis_quality_clean)



```



# é»„åä¸¹æŒ‡å¯¼

```{r}

library(readr)
library(lavaan)
library(tidyverse)

mediation_data <- read_csv("mediation_data.csv")





# æ„é€ ä¸€ä¸ªæ–°çš„æ•°æ®æ¡†ï¼šmediation_cleanï¼ŒæŠŠå˜é‡éƒ½åšæˆç­‰çº§åˆ¶
mediation_clean <- mediation_data %>%
  # åˆ›å»ºå¹²å‡€ç‰ˆçš„ diagnosis_quality å˜é‡
  mutate(
    diagnosis_quality_clean = ifelse(
      diagnosis_quality == "æ²¡æœ‰ä¸‹è¯Šæ–­",
      NA,
      diagnosis_quality
    ),
    diagnosis_quality = factor(
      diagnosis_quality_clean,
      levels = c("é”™è¯¯", "éƒ¨åˆ†æ­£ç¡®", "å®Œå…¨æ­£ç¡®"),
      ordered = TRUE
    ),
    diagnosis_quality_num = as.numeric(diagnosis_quality)
  )



mediation_clean <- mediation_clean %>%
  mutate(
    management_type = factor(
      management_type,
      levels = c("éè¥åˆ©æ€§", "è¥åˆ©æ€§")  # è®¾ç½®å‚è€ƒç»„ä¸ºâ€œéè¥åˆ©æ€§â€
    )
  )




mediation_clean <- mediation_clean %>%
  mutate(
    case_type = factor(case_type)  # è½¬ä¸ºå› å­å³å¯
  )

mediation_clean <- mediation_clean %>%
  mutate(
    ownership_type = factor(ownership_type)
  )


mediation_clean <- mediation_clean %>%
  mutate(
    province = factor(province)
  )

mediation_clean <- mediation_clean %>%
  mutate(
    rural_type = factor(rural_type)
  )

mediation_clean <- mediation_clean %>%
  mutate(
    sp_gender = factor(sp_gender)
  )


mediation_clean <- mediation_clean %>%
  mutate(
    sp_age_group = factor(sp_age_group)
  )


mediation_clean <- mediation_clean %>%
  mutate(
    doctor_age = factor(doctor_age)
  )


mediation_clean <- mediation_clean %>%
  mutate(
    doctor_ethnic = factor(doctor_ethnic)
  )


mediation_clean <- mediation_clean %>%
  mutate(
    doctor_female = factor(doctor_female)
  )


# å°† sp_age_group è®¾ç½®ä¸ºæœ‰åºå› å­
mediation_clean$sp_age_group <- factor(
  mediation_clean$sp_age_group,
  levels = c("â‰¤30", "30-49", "â‰¥50"),
  ordered = TRUE
)

# å°† doctor_age è®¾ç½®ä¸ºæœ‰åºå› å­
mediation_clean$doctor_age <- factor(
  mediation_clean$doctor_age,
  levels = c("<30", "30-50", "â‰¥50"),
  ordered = TRUE
)





```





## ç¬¬ä¸€ä¸ªM1 history_taking_ratioï¼ŒM2æ˜¯diagnosis_qualityâ€”â€”è·‘å‡ºæ¥å‘ç°å¤šåˆ†ç±»æ²¡æ³•æ”¾å…¥
```{r}






multipleMediation <- '
  antibiotic_prescribed ~ case_type + doctor_female + management_type + ownership_type + province + rural_type + sp_gender + sp_age_group + doctor_age + doctor_ethnic + b1*history_taking_ratio + b2* diagnosis_quality_clean + c1*consultation_time
  history_taking_ratio ~ case_type + doctor_female + management_type + ownership_type + province + rural_type + sp_gender + sp_age_group + doctor_age + doctor_ethnic + a1*consultation_time
   diagnosis_quality_clean ~ case_type + doctor_female + management_type + ownership_type + province + rural_type + sp_gender + sp_age_group + doctor_age + doctor_ethnic + a2*consultation_time + d1*history_taking_ratio

  Indirect1 := a1*b1
  Indirect2 := a2*b2
  secondInd1 := a1*d1*b2
  c := c1 + a1*b1 + a2*b2 + a1*d1*b2
'






fit <- sem(model = multipleMediation,data = mediation_clean,se = "bootstrap",bootstrap = 5000)
summary(fit,ci=T)





```


å¤–ç”Ÿåå˜é‡æ—¶å¦‚ä½•å¤„ç†ç¼–ç ï¼Œæ¯”å¦‚`case_type`, `province`ï¼Œ`sp_age_group`,`doctor_age`ç­‰æ— åºæˆ–è€…ä¸‰ç­‰çº§åˆ¶æœ‰åºå˜é‡ï¼š

å¦‚æœæ˜¯åˆ†ç±»å˜é‡ï¼Œå»ºè®®æ‹†æˆè™šæ‹Ÿå˜é‡ï¼ˆdummy variablesï¼‰ï¼Œé˜²æ­¢lavaanå› ä¸ºå¤šç±»åˆ«éåºå˜é‡æŠ¥é”™ã€‚

ä¾‹å¦‚ï¼šslideæœ‰3ç±»ï¼Œæ‹†æˆslide_1ã€slide_2ä¸¤ä¸ª0/1å˜é‡ï¼ˆå‚è€ƒç±»ä¸å»ºå˜é‡ï¼‰ã€‚




## ç¬¬ä¸€ä¸ªM1 history_taking_ratioï¼ŒM2æ˜¯diagnosis_qualityâ€”â€”å¼€å§‹è¿›è¡Œå“‘å˜é‡å¤„ç†
```{r}


library(fastDummies)

# åˆ›å»º dummy å˜é‡ï¼ˆä¸ä¿ç•™åŸå§‹å˜é‡ï¼Œä¸”å»æ‰æ¯ä¸ªåˆ†ç±»çš„å‚è€ƒç»„ï¼Œé¿å…å…±çº¿æ€§ï¼‰
mediation_clean_dummies <- fastDummies::dummy_cols(
  mediation_clean,
  select_columns = c("case_type", "province"),
  remove_first_dummy = TRUE,
  remove_selected_columns = TRUE
)



mediation_clean_dummies <- fastDummies::dummy_cols(
  mediation_clean_dummies,
  select_columns = c("sp_age_group", "doctor_age"),
  remove_first_dummy = TRUE,      # åˆ é™¤å‚è€ƒç»„ï¼Œé¿å…å…±çº¿æ€§
  remove_selected_columns = TRUE  # ç§»é™¤åŸå§‹å˜é‡
)


mediation_clean_dummies <- dummy_cols(
  mediation_clean_dummies, # ä½ ä¹‹å‰å·²ç»åŒ…å«å…¶ä»– dummy çš„æ•°æ®
  select_columns = "diagnosis_quality_clean",
  remove_first_dummy = TRUE,   # ç§»é™¤å‚è€ƒç»„ï¼Œé¿å…å¤šé‡å…±çº¿æ€§
  remove_selected_columns = TRUE  # åˆ é™¤åŸå˜é‡
)



names(mediation_clean_dummies)[grepl("sp_age_group", names(mediation_clean_dummies))]
names(mediation_clean_dummies)[grepl("doctor_age", names(mediation_clean_dummies))]
names(mediation_clean_dummies)[grepl("diagnosis_quality_clean", names(mediation_clean_dummies))]





case_type_dummies <- c(
  "case_type_åå¤´ç—›",
  "case_type_å‹åŠ›æ€§å°¿å¤±ç¦",
  "case_type_å“®å–˜",
  "case_type_å°å„¿è…¹æ³»",
  "case_type_å¿ƒç»ç—›",
  "case_type_æ™®é€šæ„Ÿå†’",
  "case_type_ç³–å°¿ç—…",
  "case_type_èƒƒç‚",
  "case_type_è…°èƒŒç—›",
  "case_type_é«˜è¡€å‹"
)


province_dummies <- c(
  "province_Guangdong",
  "province_Guizhou",
  "province_Hunan",
  "province_InnerMongolia",
  "province_Shaanx",
  "province_Sichuan"
)




multipleMediation <- '
  antibiotic_prescribed ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      b1*history_taking_ratio +
      b2a*diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® +
      b2b*diagnosis_quality_clean_é”™è¯¯ +
      c1*consultation_time

  history_taking_ratio ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a1*consultation_time

  diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2a*consultation_time + d1a*history_taking_ratio

  diagnosis_quality_clean_é”™è¯¯ ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2b*consultation_time + d1b*history_taking_ratio

  Indirect1 := a1*b1
  Indirect2 := a2a*b2a
  secondInd1 := a1*d1a*b2a
  c := c1 + a1*b1 + a2a*b2a + a1*d1a*b2a
'


fit <- sem(model = multipleMediation,
           data = mediation_clean_dummies,
           se = "bootstrap",
           bootstrap = 5000)

summary(fit, ci = TRUE)




```




## ç¬¬äºŒä¸ªM1 physical_exam_ratioï¼ŒM2æ˜¯diagnosis_qualityâ€”â€”å¼€å§‹è¿›è¡Œå“‘å˜é‡å¤„ç†

```{r}



multipleMediation <- '
  antibiotic_prescribed ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      b1*physical_exam_ratio +
      b2a*diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® +
      b2b*diagnosis_quality_clean_é”™è¯¯ +
      c1*consultation_time

  physical_exam_ratio ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a1*consultation_time

  diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2a*consultation_time + d1a*physical_exam_ratio

  diagnosis_quality_clean_é”™è¯¯ ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2b*consultation_time + d1b*physical_exam_ratio

  Indirect1 := a1*b1
  Indirect2 := a2a*b2a
  secondInd1 := a1*d1a*b2a
  c := c1 + a1*b1 + a2a*b2a + a1*d1a*b2a
'

# æ‹Ÿåˆæ¨¡å‹
fit <- sem(model = multipleMediation,
           data = mediation_clean_dummies,
           se = "bootstrap",
           bootstrap = 5000)

# è¾“å‡ºæ‘˜è¦ï¼ˆåŒ…å«ç½®ä¿¡åŒºé—´ï¼‰
summary(fit, ci = TRUE)



```



## ç¬¬ä¸‰ä¸ªM1 lab_imaging_ratioï¼ŒM2æ˜¯diagnosis_qualityâ€”â€”å¼€å§‹è¿›è¡Œå“‘å˜é‡å¤„ç†

```{r}



multipleMediation <- '
  antibiotic_prescribed ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      b1*lab_imaging_ratio +
      b2a*diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® +
      b2b*diagnosis_quality_clean_é”™è¯¯ +
      c1*consultation_time

  lab_imaging_ratio ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a1*consultation_time

  diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2a*consultation_time + d1a*lab_imaging_ratio

  diagnosis_quality_clean_é”™è¯¯ ~
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic +
      a2b*consultation_time + d1b*lab_imaging_ratio

  Indirect1 := a1*b1
  Indirect2 := a2a*b2a
  secondInd1 := a1*d1a*b2a
  c := c1 + a1*b1 + a2a*b2a + a1*d1a*b2a
'


# æ‹Ÿåˆæ¨¡å‹
fit <- sem(model = multipleMediation,
           data = mediation_clean_dummies,
           se = "bootstrap",
           bootstrap = 5000)

# è¾“å‡ºæ‘˜è¦ï¼ˆåŒ…å«ç½®ä¿¡åŒºé—´ï¼‰
summary(fit, ci = TRUE)





```




## ç¬¬å››ä¸ªM1 diagnosis_qualityâ€”â€”å•ä¸€ä¸­ä»‹

```{r}

simpleMediation <- '
  # è·¯å¾„ï¼šconsultation_time -> diagnosis_quality -> antibiotic_prescribed
  antibiotic_prescribed ~
      b2a*diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® +
      b2b*diagnosis_quality_clean_é”™è¯¯ +
      c1*consultation_time +
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic

  # ä¸­ä»‹æ–¹ç¨‹
  diagnosis_quality_clean_éƒ¨åˆ†æ­£ç¡® ~ a2a*consultation_time +
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic

  diagnosis_quality_clean_é”™è¯¯ ~ a2b*consultation_time +
      case_type_åå¤´ç—› + case_type_å‹åŠ›æ€§å°¿å¤±ç¦ + case_type_å“®å–˜ + case_type_å°å„¿è…¹æ³» + case_type_å¿ƒç»ç—› +
      case_type_æ™®é€šæ„Ÿå†’ + case_type_ç³–å°¿ç—… + case_type_èƒƒç‚ + case_type_è…°èƒŒç—› + case_type_é«˜è¡€å‹ +
      province_Guangdong + province_Guizhou + province_Hunan + province_InnerMongolia + province_Shaanx + province_Sichuan +
      doctor_female + management_type + ownership_type + rural_type + sp_gender +
      `sp_age_group_30-49` + `sp_age_group_â‰¥50` +
      `doctor_age_30-50` + `doctor_age_â‰¥50` +
      doctor_ethnic

  # é—´æ¥æ•ˆåº”å®šä¹‰
  Indirect2a := a2a * b2a
  Indirect2b := a2b * b2b
  Total_Indirect := Indirect2a + Indirect2b
  Total_Effect := c1 + Total_Indirect
'

# æ‹Ÿåˆæ¨¡å‹
fit <- sem(model = multipleMediation,
           data = mediation_clean_dummies,
           se = "bootstrap",
           bootstrap = 5000)

# è¾“å‡ºæ‘˜è¦ï¼ˆåŒ…å«ç½®ä¿¡åŒºé—´ï¼‰
summary(fit, ci = TRUE)




```





## å¾è€å¸ˆè®©è¡¥å……çš„åˆ†æ
```{r}


library(dplyr)
library(broom)

# è®¡ç®—æ¯ç±»çš„ç»Ÿè®¡é‡
result <- formal_data_final_modeimputed %>%
  group_by(institution_type_houyu) %>%
  summarise(
    n_visits = n(),
    n_antibiotic = sum(antibiotic_prescribed == 1, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    total_visits = sum(n_visits),
    all_visits_percent = paste0(n_visits, " (", round(n_visits / total_visits * 100, 2), "%)")
  )

# è®¡ç®—å¤„æ–¹ç‡å’Œ95%CI
rate_ci <- result %>%
  rowwise() %>%
  mutate(
    ci = list(binom.test(n_antibiotic, n_visits)$conf.int),
    rate = n_antibiotic / n_visits * 100
  ) %>%
  mutate(
    ci_low = round(ci[[1]] * 100, 2),
    ci_high = round(ci[[2]] * 100, 2),
    antibiotic_rate = paste0(round(rate, 2), "% (", ci_low, "â€“", ci_high, "%)")
  ) %>%
  select(institution_type_houyu, all_visits_percent, n_antibiotic, antibiotic_rate)

print(rate_ci)




```




```{r}

library(dplyr)

# æ€»æ ·æœ¬æ•°
total_n <- nrow(formal_data_final_modeimputed)

result <- formal_data_final_modeimputed %>%
  group_by(case_type, institution_type_houyu) %>%
  summarise(
    n = n(),
    antibiotic_yes = sum(antibiotic_prescribed == 1, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    # å°±è¯Šæ¬¡æ•°å æ¯”
    all_visits_percent = round(100 * n / total_n, 2),

    # æŠ—ç”Ÿç´ å¤„æ–¹ç‡
    prescription_rate = antibiotic_yes / n,

    # è®¡ç®— 95% CI (ç”¨ binom.test)
    ci = list(binom.test(antibiotic_yes, n)$conf.int)
  ) %>%
  mutate(
    ci_low = round(ci[[1]] * 100, 2),
    ci_high = round(ci[[2]] * 100, 2),
    prescription_rate_percent = round(prescription_rate * 100, 2),
    prescription_rate_ci = paste0(prescription_rate_percent, "% (", ci_low, "â€“", ci_high, "%)")
  ) %>%
  ungroup() %>%
  select(
    case_type,
    institution_type_houyu,
    `All visits (%)` = all_visits_percent,
    `Antibiotic prescriptions` = antibiotic_yes,
    `Antibiotic prescription rate (95% CI)` = prescription_rate_ci
  )




# ä¿å­˜ä¸º CSV
write.csv(result, "antibiotic_prescription_rate.csv", row.names = FALSE)




```




```{r}



library(dplyr)

# æ€»æ ·æœ¬æ•°
total_n <- nrow(formal_data_final_modeimputed)

result <- formal_data_final_modeimputed %>%
  mutate(
    institution_type_grouped = case_when(
      institution_type_houyu %in% c("ä¹¡é•‡å«ç”Ÿé™¢", "æ‘å«ç”Ÿå®¤") ~ "ä¹¡é•‡å«ç”Ÿé™¢/æ‘å«ç”Ÿå®¤",
      TRUE ~ institution_type_houyu
    )
  ) %>%
  group_by(case_type, institution_type_grouped) %>%
  summarise(
    n = n(),
    antibiotic_yes = sum(antibiotic_prescribed == 1, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    # å°±è¯Šæ¬¡æ•°å æ¯”
    all_visits_percent = round(100 * n / total_n, 2),

    # æŠ—ç”Ÿç´ å¤„æ–¹ç‡
    prescription_rate = antibiotic_yes / n,

    # è®¡ç®— 95% CI (binom.test)
    ci = list(binom.test(antibiotic_yes, n)$conf.int)
  ) %>%
  mutate(
    ci_low = round(ci[[1]] * 100, 2),
    ci_high = round(ci[[2]] * 100, 2),
    prescription_rate_percent = round(prescription_rate * 100, 2),
    prescription_rate_ci = paste0(prescription_rate_percent, "% (", ci_low, "â€“", ci_high, "%)")
  ) %>%
  ungroup() %>%
  select(
    case_type,
    institution_type = institution_type_grouped,
    `All visits (%)` = all_visits_percent,
    `Antibiotic prescriptions` = antibiotic_yes,
    `Antibiotic prescription rate (95% CI)` = prescription_rate_ci
  )

# ä¿å­˜ä¸º CSV
write.csv(result, "antibiotic_prescription_rate-combine.csv", row.names = FALSE)








```










